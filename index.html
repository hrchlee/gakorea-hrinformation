<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA KOREA ì¸ì‚¬ì •ë³´ë“±ë¡</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
    // HTTPS ê°•ì œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        location.replace('https:' + window.location.href.substring(window.location.protocol.length));
    }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Malgun Gothic', sans-serif; background: #f5f6f8; font-size: 12px; }
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .login-box { background: white; padding: 50px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); width: 450px; }
        .login-header { text-align: center; margin-bottom: 40px; }
        .login-header h1 { color: #333; font-size: 28px; margin-bottom: 10px; }
        .firebase-badge { background: #ff9800; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; display: inline-block; margin-top: 10px; }
        .login-form .form-group { margin-bottom: 20px; }
        .login-form label { display: block; margin-bottom: 8px; color: #333; font-weight: bold; }
        .login-form input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .login-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .error-msg { background: #ffebee; color: #c62828; padding: 12px; border-radius: 4px; margin-bottom: 20px; display: none; text-align: center; }
        .main-screen { display: none; }
        .main-screen.active { display: block; }
        .header { background: white; border-bottom: 2px solid #e0e0e0; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .header-left h1 { color: #333; font-size: 18px; font-weight: bold; }
        .header-right { display: flex; gap: 15px; align-items: center; }
        .logout-btn { padding: 8px 16px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .tab-menu { background: white; border-bottom: 1px solid #e0e0e0; padding: 0 30px; display: flex; gap: 5px; }
        .tab-btn { padding: 12px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 13px; color: #666; }
        .tab-btn.active { color: #1976d2; border-bottom-color: #1976d2; font-weight: bold; }
        .layout { display: flex; height: calc(100vh - 120px); }
        .sidebar { width: 250px; background: white; border-right: 1px solid #e0e0e0; padding: 20px; overflow-y: auto; }
        .main-content { flex: 1; background: white; overflow-y: auto; padding: 25px; }
        .filter-section { margin-bottom: 20px; }
        .filter-section h3 { font-size: 13px; margin-bottom: 10px; font-weight: bold; }
        .filter-group { margin-bottom: 12px; }
        .filter-group label { display: block; margin-bottom: 6px; font-size: 12px; color: #666; }
        .filter-group input, .filter-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; }
        .employee-list { border-top: 1px solid #e0e0e0; margin-top: 15px; padding-top: 15px; max-height: 400px; overflow-y: auto; }
        .employee-item { padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 8px; cursor: pointer; }
        .employee-item:hover { background: #f5f9ff; border-color: #1976d2; }
        .employee-item .name { font-weight: bold; margin-bottom: 4px; }
        .employee-item .info { font-size: 11px; color: #666; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: #1976d2; color: white; }
        .btn-secondary { background: #757575; color: white; }
        .btn-outline { background: white; border: 1px solid #ddd; color: #666; }
        .form-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .form-table tr { border-bottom: 1px solid #f0f0f0; }
        .form-table th { width: 150px; padding: 10px; text-align: left; background: #fafafa; font-weight: 600; font-size: 12px; border-right: 1px solid #e0e0e0; }
        .form-table td { padding: 10px; }
        .form-table input, .form-table select, .form-table textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; }
        .form-table textarea { min-height: 60px; font-family: inherit; }
        .required::after { content: ' *'; color: #f44336; }
        .detail-tabs { display: flex; gap: 2px; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px; }
        .detail-tab { padding: 10px 20px; background: #f5f5f5; border: none; border-radius: 4px 4px 0 0; cursor: pointer; font-size: 13px; color: #666; }
        .detail-tab.active { background: white; color: #1976d2; font-weight: bold; border-bottom: 2px solid white; margin-bottom: -1px; }
        .detail-content { display: none; }
        .detail-content.active { display: block; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .button-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0; }
        .form-title { font-size: 14px; color: #1976d2; margin: 20px 0 10px 0; font-weight: bold; padding-bottom: 8px; border-bottom: 2px solid #1976d2; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .loading.active { display: flex; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #1976d2; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .radio-group { display: flex; gap: 10px; }
    </style>
</head>
<body>
    <div class="loading" id="loading"><div class="spinner"></div></div>

    <div id="login-screen" class="login-screen">
        <div class="login-box">
            <div class="login-header">
                <h1>ğŸ¢ ê·¸ë£¹ ì¸ì‚¬ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
                <p>ê´€ë¦¬ì ë¡œê·¸ì¸</p>
                <span class="firebase-badge">ğŸ” Firebase Authentication</span>
            </div>
            <div class="error-msg" id="login-error">ë¡œê·¸ì¸ ì‹¤íŒ¨</div>
            <form class="login-form" id="login-form">
                <div class="form-group">
                    <label>ì´ë©”ì¼</label>
                    <input type="email" id="login-email" placeholder="example@company.com" required>
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="login-btn" id="login-btn">ë¡œê·¸ì¸</button>
            </form>
        </div>
    </div>

    <div id="main-screen" class="main-screen">
        <div class="header">
            <div class="header-left"><h1>GA KOREA ì¸ì‚¬ì •ë³´ë“±ë¡</h1></div>
            <div class="header-right">
                <div class="user-info"><strong id="current-user"></strong></div>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="tab-menu">
            <button class="tab-btn active" onclick="switchMainTab('employee')">ì§ì› ê´€ë¦¬</button>
            <button class="tab-btn" onclick="switchMainTab('roster')">ì„ì§ì› ëª…ë¶€</button>
            <button class="tab-btn" onclick="switchMainTab('company')">ë²•ì¸ ê´€ë¦¬</button>
            <button class="tab-btn" onclick="switchMainTab('admin')">ì‹œìŠ¤í…œ ê´€ë¦¬ì</button>
        </div>

        <div id="employee-tab" class="layout">
            <div class="sidebar">
                <div class="filter-section">
                    <h3>ê²€ìƒ‰</h3>
                    <input type="text" id="search-employee" placeholder="ì´ë¦„/ì‚¬ë²ˆ..." oninput="filterEmployees()">
                </div>
                <div class="filter-section">
                    <h3>ë²•ì¸</h3>
                    <select id="filter-company" onchange="filterEmployees()"></select>
                </div>
                <div class="employee-list" id="employee-list">
                    <div class="empty-state"><p>ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</p></div>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="showNewEmployeeForm()">+ ì‹ ê·œ ë“±ë¡</button>
            </div>

            <div class="main-content" id="employee-detail">
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-outline" onclick="downloadExcelTemplate()">ğŸ“¥ ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn btn-primary" onclick="document.getElementById('excel-upload').click()">ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ</button>
                    <input type="file" id="excel-upload" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelUpload(event)">
                </div>
                <div class="empty-state"><h3>ì§ì›ì„ ì„ íƒí•˜ê±°ë‚˜ ì‹ ê·œ ë“±ë¡í•˜ì„¸ìš”</h3></div>
            </div>
        </div>

        <!-- ì„ì§ì› ëª…ë¶€ íƒ­ -->
        <div id="roster-tab" class="layout" style="display: none;">
            <div class="main-content" style="padding: 30px;">
                <h2 style="margin-bottom: 20px;">ì„ì§ì› ëª…ë¶€</h2>
                
                <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <select id="roster-company-filter" onchange="loadRoster()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">ì „ì²´ ë²•ì¸</option>
                    </select>
                    <select id="roster-dept-filter" onchange="loadRoster()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">ì „ì²´ ë¶€ì„œ</option>
                    </select>
                    <button class="btn btn-primary" onclick="exportRoster()">ğŸ“Š Excel ë‚´ë³´ë‚´ê¸°</button>
                </div>

                <div style="overflow-x: auto;">
                    <table id="roster-table" style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <thead style="background: #f5f5f5;">
                            <tr>
                                <th style="padding: 12px; border: 1px solid #ddd; font-size: 12px;">No</th>
                                <th style="padding: 12px; border: 1px solid #ddd; font-size: 12px;">ì‚¬ë²ˆ</th>
                                <th style="padding: 12px; border: 1px solid #ddd; font-size: 12px;">ì„±ëª…</th>
                                <th style="padding: 12px; border: 1px solid #ddd; font-size: 12px;">ë²•ì¸</th>
                                <th style="padding: 12px; border: 1px solid #ddd; font-size: 12px;">ë¶€ì„œ</th>
                                <th style="padding: 12px; border: 1px solid #ddd; font-size: 12px;">ì§ê¸‰</th>
                                <th style="padding: 12px; border: 1px solid #ddd; font-size: 12px;">ì…ì‚¬ì¼</th>
                                <th style="padding: 12px; border: 1px solid #ddd; font-size: 12px;">ì¬ì§ìƒíƒœ</th>
                                <th style="padding: 12px; border: 1px solid #ddd; font-size: 12px;">íœ´ëŒ€ì „í™”</th>
                                <th style="padding: 12px; border: 1px solid #ddd; font-size: 12px;">ì´ë©”ì¼</th>
                            </tr>
                        </thead>
                        <tbody id="roster-tbody">
                            <tr>
                                <td colspan="10" style="padding: 40px; text-align: center; color: #999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ë²•ì¸ ê´€ë¦¬ íƒ­ -->
        <div id="company-tab" class="layout" style="display: none;">
            <div class="main-content" style="padding: 30px;">
                <h2 style="margin-bottom: 20px;">ë²•ì¸ ê´€ë¦¬</h2>
                
                <div style="margin-bottom: 30px;">
                    <button class="btn btn-primary" onclick="showAddCompanyForm()">+ ë²•ì¸ ì¶”ê°€</button>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;" id="company-list">
                    <div style="text-align: center; padding: 40px; color: #999;">ë²•ì¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>

                <!-- ë¶€ì„œ ê´€ë¦¬ ì„¹ì…˜ -->
                <h2 style="margin: 40px 0 20px 0;">ë¶€ì„œ ê´€ë¦¬</h2>
                
                <div style="margin-bottom: 30px;">
                    <button class="btn btn-primary" onclick="showAddDeptForm()">+ ë¶€ì„œ ì¶”ê°€</button>
                </div>

                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white;">
                        <thead style="background: #f5f5f5;">
                            <tr>
                                <th style="padding: 12px; border: 1px solid #ddd;">ë¶€ì„œëª…</th>
                                <th style="padding: 12px; border: 1px solid #ddd;">ê·¼ë¬´ì§€</th>
                                <th style="padding: 12px; border: 1px solid #ddd;">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="dept-list">
                            <tr>
                                <td colspan="3" style="padding: 20px; text-align: center; color: #999;">ë¶€ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ì‹œìŠ¤í…œ ê´€ë¦¬ì íƒ­ -->
        <div id="admin-tab" class="layout" style="display: none;">
            <div class="main-content" style="padding: 30px;">
                <h2 style="margin-bottom: 30px;">ì‹œìŠ¤í…œ ê´€ë¦¬ì ì„¤ì •</h2>

                <div style="max-width: 600px; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px; color: #1976d2;">ê´€ë¦¬ì ê³„ì • ê´€ë¦¬</h3>
                    
                    <div id="admin-accounts-list">
                        <p style="color: #999;">ê´€ë¦¬ì ê³„ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                        <button class="btn btn-primary" onclick="showAddAdminForm()">+ ê´€ë¦¬ì ì¶”ê°€</button>
                    </div>
                </div>

                <div style="max-width: 600px; background: #fff3cd; padding: 20px; border-radius: 8px; margin-top: 30px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">âš ï¸ ë³´ì•ˆ ì£¼ì˜ì‚¬í•­</h4>
                    <ul style="color: #856404; font-size: 12px; line-height: 1.8;">
                        <li>ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ ê¶Œì¥í•©ë‹ˆë‹¤.</li>
                        <li>ê´€ë¦¬ì ê³„ì •ì€ ì‹ ì¤‘í•˜ê²Œ ê´€ë¦¬í•˜ì„¸ìš”.</li>
                        <li>ì •ê¸°ì ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì„¸ìš”.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCrsPO00nsUH4iwUfHCF1aFKwcuoedqTTs",
            authDomain: "ga-korea-hr.firebaseapp.com",
            projectId: "ga-korea-hr",
            storageBucket: "ga-korea-hr.firebasestorage.app",
            messagingSenderId: "1022770625476",
            appId: "1:1022770625476:web:927f6a18be08feb5518291"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.db = db;
        window.auth = auth;
        window.collection = collection;
        window.getDocs = getDocs;
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.getDoc = getDoc;
        window.serverTimestamp = serverTimestamp;
        
        console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
        console.log('ğŸ”’ Firebase Authentication í™œì„±í™”');

        let currentAuthUser = null;

        // ì¸ì¦ ìƒíƒœ ê°ì§€
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('âœ… ë¡œê·¸ì¸ë¨:', user.email);
                currentAuthUser = user;
                await showMainScreen(user);
            } else {
                console.log('âŒ ë¡œê·¸ì•„ì›ƒ ìƒíƒœ');
                showLoginScreen();
            }
        });

        // ë¡œê·¸ì¸ í¼ ì²˜ë¦¬
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginBtn = document.getElementById('login-btn');
            const errorMsg = document.getElementById('login-error');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
            errorMsg.style.display = 'none';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ');
            } catch (error) {
                console.error('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨:', error.code);
                
                let errorText = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorText = 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                } else if (error.code === 'auth/invalid-email') {
                    errorText = 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorText = 'ë„ˆë¬´ ë§ì€ ì‹œë„ë¥¼ í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
                }
                
                errorMsg.textContent = errorText;
                errorMsg.style.display = 'block';
                
                loginBtn.disabled = false;
                loginBtn.textContent = 'ë¡œê·¸ì¸';
            }
        });

        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-screen').classList.remove('active');
        }

        async function showMainScreen(user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-screen').classList.add('active');
            
            const userName = user.email.split('@')[0];
            document.getElementById('current-user').textContent = userName;
            
            await loadCompanyFilters();
            await loadEmployees();
        }

        window.logout = async function() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await signOut(auth);
                    console.log('âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
                } catch (error) {
                    console.error('âŒ ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                }
            }
        }
    </script>

    <script>
        function showLoading() { document.getElementById('loading').classList.add('active'); }
        function hideLoading() { document.getElementById('loading').classList.remove('active'); }

        function hashPassword(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                hash = ((hash << 5) - hash) + password.charCodeAt(i);
                hash = hash & hash;
            }
            return hash.toString();
        }

        let session = null;
        let allEmployees = [];

        async function initializeData() {
            try {
                const companiesRef = window.collection(window.db, 'companies');
                const snap = await window.getDocs(companiesRef);
                
                if (snap.empty) {
                    await window.setDoc(window.doc(window.db, 'companies', 'C001'), { code: 'C001', name: 'GA KOREA' });
                    await window.setDoc(window.doc(window.db, 'companies', 'C002'), { code: 'C002', name: 'ãˆœì§€ì—ì´í…Œí¬' });
                    await window.setDoc(window.doc(window.db, 'departments', 'D001'), { code: 'D001', name: 'ê²½ì˜ì§€ì›íŒ€', companyCode: 'C001' });
                    await window.setDoc(window.doc(window.db, 'departments', 'D002'), { code: 'D002', name: 'ì¸ì‚¬íŒ€', companyCode: 'C001' });
                }

                const usersRef = window.collection(window.db, 'users');
                const uSnap = await window.getDocs(usersRef);
                
                if (uSnap.empty) {
                    await window.setDoc(window.doc(window.db, 'users', 'admin'), {
                        username: 'admin',
                        password: hashPassword('admin1234'),
                        name: 'ì‹œìŠ¤í…œê´€ë¦¬ì',
                        role: 'admin',
                        active: true
                    });
                }
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }

        window.addEventListener('DOMContentLoaded', async function() {
            showLoading();
            await initializeData();
            hideLoading();
        });

        window.switchMainTab = function(tabName) {
            // íƒ­ ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // íƒ­ ì½˜í…ì¸  í‘œì‹œ
            document.getElementById('employee-tab').style.display = 'none';
            document.getElementById('roster-tab').style.display = 'none';
            document.getElementById('company-tab').style.display = 'none';
            document.getElementById('admin-tab').style.display = 'none';
            
            if (tabName === 'employee') {
                document.getElementById('employee-tab').style.display = 'flex';
            } else if (tabName === 'roster') {
                document.getElementById('roster-tab').style.display = 'flex';
                loadRoster();
            } else if (tabName === 'company') {
                document.getElementById('company-tab').style.display = 'flex';
                loadCompanyManagement();
            } else if (tabName === 'admin') {
                document.getElementById('admin-tab').style.display = 'flex';
                loadAdminManagement();
            }
        }

        async function loadCompanyFilters() {
            const select = document.getElementById('filter-company');
            select.innerHTML = '<option value="">ì „ì²´</option>';
            
            const snapshot = await window.getDocs(window.collection(window.db, 'companies'));
            snapshot.forEach(doc => {
                const c = doc.data();
                select.innerHTML += `<option value="${c.code}">${c.name}</option>`;
            });
        }

        async function loadEmployees() {
            showLoading();
            allEmployees = [];
            const snapshot = await window.getDocs(window.collection(window.db, 'employees'));
            snapshot.forEach(doc => {
                allEmployees.push({ id: doc.id, ...doc.data() });
            });
            filterEmployees();
            hideLoading();
        }

        function filterEmployees() {
            const search = document.getElementById('search-employee').value.toLowerCase();
            const company = document.getElementById('filter-company').value;
            
            let filtered = allEmployees.filter(emp => {
                const matchSearch = !search || (emp.name && emp.name.toLowerCase().includes(search)) || (emp.employeeId && emp.employeeId.includes(search));
                // GA KOREA(C001)ëŠ” í†µí•©ë²•ì¸ìœ¼ë¡œ ëª¨ë“  ì§ì› ì¡°íšŒ
                const matchCompany = !company || company === 'C001' || emp.companyCode === company;
                return matchSearch && matchCompany;
            });
            
            renderEmployeeList(filtered);
        }

        function renderEmployeeList(employees) {
            const list = document.getElementById('employee-list');
            if (employees.length === 0) {
                list.innerHTML = '<div class="empty-state"><p>ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
                return;
            }
            
            list.innerHTML = employees.map(emp => `
                <div class="employee-item" onclick="selectEmployee('${emp.employeeId}')">
                    <div class="name">${emp.name}</div>
                    <div class="info">${emp.employeeId}</div>
                </div>
            `).join('');
        }

        function selectEmployee(id) {
            const emp = allEmployees.find(e => e.employeeId === id);
            if (!emp) return;
            
            document.getElementById('employee-detail').innerHTML = `
                <h2>${emp.name} (${emp.employeeId})</h2>
                <p>ë²•ì¸: ${emp.companyCode} | ë¶€ì„œ: ${emp.departmentCode || '-'}</p>
                <p>ì§ê¸‰: ${emp.position || '-'} | ì…ì‚¬ì¼: ${emp.hireDate || '-'}</p>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="editEmployee('${id}')">ìˆ˜ì •</button>
                    <button class="btn btn-secondary" onclick="deleteEmployee('${id}')">ì‚­ì œ</button>
                </div>
            `;
        }

        async function deleteEmployee(id) {
            if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            showLoading();
            await window.deleteDoc(window.doc(window.db, 'employees', id));
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            await loadEmployees();
            document.getElementById('employee-detail').innerHTML = '<div class="empty-state"><h3>ì§ì›ì„ ì„ íƒí•˜ê±°ë‚˜ ì‹ ê·œ ë“±ë¡í•˜ì„¸ìš”</h3></div>';
            hideLoading();
        }

        function editEmployee(id) {
            const emp = allEmployees.find(e => e.employeeId === id);
            showEmployeeForm(emp);
        }

        window.showNewEmployeeForm = function() {
            showEmployeeForm();
        }

        function generateId() {
            return new Date().getFullYear().toString().slice(2) + 
                   (new Date().getMonth() + 1).toString().padStart(2, '0') + 
                   Math.floor(Math.random() * 9000 + 1000);
        }

        async function showEmployeeForm(emp = null) {
            const companies = [];
            const depts = [];
            
            const cSnap = await window.getDocs(window.collection(window.db, 'companies'));
            cSnap.forEach(doc => companies.push(doc.data()));
            
            const dSnap = await window.getDocs(window.collection(window.db, 'departments'));
            dSnap.forEach(doc => depts.push(doc.data()));
            
            document.getElementById('employee-detail').innerHTML = `
                <h2>${emp ? 'ì§ì› ì •ë³´ ìˆ˜ì •' : 'ì‹ ê·œ ì§ì› ë“±ë¡'}</h2>
                <form id="emp-form" onsubmit="saveEmployee(event)">
                    <div class="detail-tabs">
                        <button type="button" class="detail-tab active" onclick="switchTab(event, 'personal')">ì¸ì ì •ë³´</button>
                        <button type="button" class="detail-tab" onclick="switchTab(event, 'employment')">ì¬ì§ì •ë³´</button>
                        <button type="button" class="detail-tab" onclick="switchTab(event, 'salary')">ê¸‰ì—¬ì •ë³´</button>
                        <button type="button" class="detail-tab" onclick="switchTab(event, 'attendance')">ê·¼íƒœì •ë³´</button>
                    </div>
                    
                    <div id="tab-personal" class="detail-content active">
                        <div class="form-title">ê¸°ë³¸ì •ë³´</div>
                        <table class="form-table">
                            <tr>
                                <th class="required">ì‚¬ë²ˆ</th>
                                <td><input name="employeeId" value="${emp?.employeeId || generateId()}" ${emp ? 'readonly' : ''} required></td>
                                <th>ì˜ë¬¸ ì‚¬ë²ˆ</th>
                                <td><input name="employeeIdEn" value="${emp?.employeeIdEn || ''}"></td>
                            </tr>
                            <tr>
                                <th class="required">ì„±ëª…</th>
                                <td><input name="name" value="${emp?.name || ''}" required></td>
                                <th>ì˜ë¬¸ëª…</th>
                                <td><input name="nameEn" value="${emp?.nameEn || ''}"></td>
                            </tr>
                            <tr>
                                <th class="required">ë‚´/ì™¸êµ­ì¸</th>
                                <td>
                                    <div class="radio-group">
                                        <label><input type="radio" name="nationality" value="ë‚´êµ­ì¸" ${!emp || emp.nationality === 'ë‚´êµ­ì¸' ? 'checked' : ''}> ë‚´êµ­ì¸</label>
                                        <label><input type="radio" name="nationality" value="ì™¸êµ­ì¸" ${emp?.nationality === 'ì™¸êµ­ì¸' ? 'checked' : ''}> ì™¸êµ­ì¸</label>
                                    </div>
                                </td>
                                <th class="required">ì„±ë³„</th>
                                <td>
                                    <select name="gender" required>
                                        <option value="ë‚¨ì„±" ${!emp || emp.gender === 'ë‚¨ì„±' ? 'selected' : ''}>ë‚¨ì„±</option>
                                        <option value="ì—¬ì„±" ${emp?.gender === 'ì—¬ì„±' ? 'selected' : ''}>ì—¬ì„±</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th class="required">ìƒë…„ì›”ì¼</th>
                                <td><input type="date" name="birthDate" value="${emp?.birthDate || ''}" required></td>
                                <th>ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</th>
                                <td><input name="residentNumber" value="${emp?.residentNumber || ''}" placeholder="000000-0000000"></td>
                            </tr>
                            <tr>
                                <th class="required">íœ´ëŒ€ì „í™”</th>
                                <td><input name="mobile" value="${emp?.mobile || ''}" placeholder="010-0000-0000" required></td>
                                <th>ì „í™”ë²ˆí˜¸</th>
                                <td><input name="phone" value="${emp?.phone || ''}" placeholder="02-0000-0000"></td>
                            </tr>
                            <tr>
                                <th>ì£¼ì†Œ</th>
                                <td colspan="3"><input name="address" value="${emp?.address || ''}"></td>
                            </tr>
                            <tr>
                                <th>ì´ë©”ì¼(íšŒì‚¬)</th>
                                <td><input type="email" name="companyEmail" value="${emp?.companyEmail || ''}"></td>
                                <th>ì´ë©”ì¼(ê°œì¸)</th>
                                <td><input type="email" name="personalEmail" value="${emp?.personalEmail || ''}"></td>
                            </tr>
                        </table>
                        
                        <div class="form-title">ì€í–‰ì •ë³´</div>
                        <table class="form-table">
                            <tr>
                                <th>ì€í–‰ëª…</th>
                                <td><input name="bankName" value="${emp?.bankName || ''}"></td>
                                <th>ê³„ì¢Œë²ˆí˜¸</th>
                                <td><input name="accountNumber" value="${emp?.accountNumber || ''}"></td>
                            </tr>
                            <tr>
                                <th>ì˜ˆê¸ˆì£¼</th>
                                <td colspan="3"><input name="accountHolder" value="${emp?.accountHolder || ''}"></td>
                            </tr>
                        </table>
                        
                        <div class="form-title">í•™ë ¥ì •ë³´</div>
                        <table class="form-table">
                            <tr>
                                <th>ìµœì¢…í•™ë ¥</th>
                                <td>
                                    <select name="education">
                                        <option value="">ì„ íƒ</option>
                                        <option value="ê³ ì¡¸" ${emp?.education === 'ê³ ì¡¸' ? 'selected' : ''}>ê³ ì¡¸</option>
                                        <option value="ì „ë¬¸ëŒ€ì¡¸" ${emp?.education === 'ì „ë¬¸ëŒ€ì¡¸' ? 'selected' : ''}>ì „ë¬¸ëŒ€ì¡¸</option>
                                        <option value="ëŒ€ì¡¸" ${emp?.education === 'ëŒ€ì¡¸' ? 'selected' : ''}>ëŒ€ì¡¸</option>
                                        <option value="ëŒ€í•™ì›ì¡¸" ${emp?.education === 'ëŒ€í•™ì›ì¡¸' ? 'selected' : ''}>ëŒ€í•™ì›ì¡¸</option>
                                    </select>
                                </td>
                                <th>í•™êµëª…</th>
                                <td><input name="schoolName" value="${emp?.schoolName || ''}"></td>
                            </tr>
                            <tr>
                                <th>ì „ê³µ</th>
                                <td><input name="major" value="${emp?.major || ''}"></td>
                                <th>ì¡¸ì—…ì¼</th>
                                <td><input type="date" name="graduationDate" value="${emp?.graduationDate || ''}"></td>
                            </tr>
                        </table>
                        
                        <div class="form-title">ê°€ì¡±ì‚¬í•­</div>
                        <table class="form-table">
                            <tr>
                                <th>ê²°í˜¼ì—¬ë¶€</th>
                                <td>
                                    <div class="radio-group">
                                        <label><input type="radio" name="maritalStatus" value="ë¯¸í˜¼" ${!emp || emp.maritalStatus === 'ë¯¸í˜¼' ? 'checked' : ''}> ë¯¸í˜¼</label>
                                        <label><input type="radio" name="maritalStatus" value="ê¸°í˜¼" ${emp?.maritalStatus === 'ê¸°í˜¼' ? 'checked' : ''}> ê¸°í˜¼</label>
                                    </div>
                                </td>
                                <th>ìë…€ìˆ˜</th>
                                <td><input type="number" name="numberOfChildren" value="${emp?.numberOfChildren || '0'}"></td>
                            </tr>
                            <tr>
                                <th>ë¹„ìƒì—°ë½ì²˜</th>
                                <td><input name="emergencyContact" value="${emp?.emergencyContact || ''}"></td>
                                <th>ë¹„ìƒì—°ë½ì²˜ ê´€ê³„</th>
                                <td><input name="emergencyRelation" value="${emp?.emergencyRelation || ''}"></td>
                            </tr>
                        </table>
                    </div>
                    
                    <div id="tab-employment" class="detail-content">
                        <div class="form-title">ì¬ì§ì •ë³´</div>
                        <table class="form-table">
                            <tr>
                                <th class="required">ì…ì‚¬ì¼</th>
                                <td><input type="date" name="hireDate" value="${emp?.hireDate || ''}" required></td>
                                <th>ê·¸ë£¹ì…ì‚¬ì¼</th>
                                <td><input type="date" name="groupHireDate" value="${emp?.groupHireDate || ''}"></td>
                            </tr>
                            <tr>
                                <th>í‡´ì‚¬ì¼</th>
                                <td><input type="date" name="resignDate" value="${emp?.resignDate || ''}"></td>
                                <th class="required">ì¬ì§ìƒíƒœ</th>
                                <td>
                                    <select name="workStatus" required>
                                        <option value="ì¬ì§" ${!emp || emp.workStatus === 'ì¬ì§' ? 'selected' : ''}>ì¬ì§</option>
                                        <option value="íœ´ì§" ${emp?.workStatus === 'íœ´ì§' ? 'selected' : ''}>íœ´ì§</option>
                                        <option value="í‡´ì§" ${emp?.workStatus === 'í‡´ì§' ? 'selected' : ''}>í‡´ì§</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th class="required">ë²•ì¸</th>
                                <td>
                                    <select name="companyCode" required>
                                        <option value="">ì„ íƒ</option>
                                        ${companies.map(c => `<option value="${c.code}" ${emp?.companyCode === c.code ? 'selected' : ''}>${c.name}</option>`).join('')}
                                    </select>
                                </td>
                                <th class="required">ê·¼ë¬´ì§€</th>
                                <td>
                                    <select name="workLocation" id="workLocation" onchange="filterDepartmentsByLocation()" required>
                                        <option value="">ì„ íƒ</option>
                                        ${[...new Set(depts.map(d => d.location).filter(l => l))].map(loc => `<option value="${loc}" ${emp?.workLocation === loc ? 'selected' : ''}>${loc}</option>`).join('')}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th class="required">ë¶€ì„œ</th>
                                <td colspan="3">
                                    <select name="departmentCode" id="departmentCode" required>
                                        <option value="">ê·¼ë¬´ì§€ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                                        ${depts.map(d => `<option value="${d.code}" data-location="${d.location}" ${emp?.departmentCode === d.code ? 'selected' : ''}>${d.name}</option>`).join('')}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th class="required">ê³ ìš©í˜•íƒœ</th>
                                <td>
                                    <select name="employmentType" required>
                                        <option value="">ì„ íƒ</option>
                                        <option value="ì •ê·œì§" ${emp?.employmentType === 'ì •ê·œì§' ? 'selected' : ''}>ì •ê·œì§</option>
                                        <option value="ê³„ì•½ì§" ${emp?.employmentType === 'ê³„ì•½ì§' ? 'selected' : ''}>ê³„ì•½ì§</option>
                                        <option value="ì¸í„´" ${emp?.employmentType === 'ì¸í„´' ? 'selected' : ''}>ì¸í„´</option>
                                        <option value="íŒŒê²¬ì§" ${emp?.employmentType === 'íŒŒê²¬ì§' ? 'selected' : ''}>íŒŒê²¬ì§</option>
                                    </select>
                                </td>
                                <th class="required">ì§ê¸‰</th>
                                <td>
                                    <select name="position" required>
                                        <option value="">ì„ íƒ</option>
                                        <option value="ì¸í„´" ${emp?.position === 'ì¸í„´' ? 'selected' : ''}>ì¸í„´</option>
                                        <option value="ì‚¬ì›" ${emp?.position === 'ì‚¬ì›' ? 'selected' : ''}>ì‚¬ì›</option>
                                        <option value="ì£¼ì„" ${emp?.position === 'ì£¼ì„' ? 'selected' : ''}>ì£¼ì„</option>
                                        <option value="ëŒ€ë¦¬" ${emp?.position === 'ëŒ€ë¦¬' ? 'selected' : ''}>ëŒ€ë¦¬</option>
                                        <option value="ê³¼ì¥" ${emp?.position === 'ê³¼ì¥' ? 'selected' : ''}>ê³¼ì¥</option>
                                        <option value="ì°¨ì¥" ${emp?.position === 'ì°¨ì¥' ? 'selected' : ''}>ì°¨ì¥</option>
                                        <option value="ë¶€ì¥" ${emp?.position === 'ë¶€ì¥' ? 'selected' : ''}>ë¶€ì¥</option>
                                        <option value="ì´ì‚¬" ${emp?.position === 'ì´ì‚¬' ? 'selected' : ''}>ì´ì‚¬</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th>ì§ì±…</th>
                                <td><input name="jobTitle" value="${emp?.jobTitle || ''}"></td>
                                <th>ì§ë¬´</th>
                                <td><input name="jobRole" value="${emp?.jobRole || ''}"></td>
                            </tr>
                            <tr>
                                <th>ê·¼ë¬´í˜•íƒœ</th>
                                <td colspan="3"><input name="workType" value="${emp?.workType || ''}"></td>
                            </tr>
                        </table>
                    </div>
                    
                    <div id="tab-salary" class="detail-content">
                        <div class="form-title">ê¸‰ì—¬ì •ë³´</div>
                        <table class="form-table">
                            <tr>
                                <th>ê¸‰ì—¬ë“±ê¸‰</th>
                                <td><input name="salaryGrade" value="${emp?.salaryGrade || ''}"></td>
                                <th>ê¸‰ì—¬ë“±ê¸‰ì¼</th>
                                <td><input type="date" name="salaryGradeDate" value="${emp?.salaryGradeDate || ''}"></td>
                            </tr>
                            <tr>
                                <th>ê¸°ë³¸ê¸‰</th>
                                <td><input type="number" name="baseSalary" value="${emp?.baseSalary || ''}"></td>
                                <th>ì—°ë´‰</th>
                                <td><input type="number" name="annualSalary" value="${emp?.annualSalary || ''}"></td>
                            </tr>
                        </table>
                        
                        <div class="form-title">4ëŒ€ë³´í—˜</div>
                        <table class="form-table">
                            <tr>
                                <td colspan="4">
                                    <label><input type="checkbox" name="nationalPension" ${emp?.nationalPension ? 'checked' : ''}> êµ­ë¯¼ì—°ê¸ˆ</label>
                                    <label><input type="checkbox" name="healthInsurance" ${emp?.healthInsurance ? 'checked' : ''}> ê±´ê°•ë³´í—˜</label>
                                    <label><input type="checkbox" name="employmentInsurance" ${emp?.employmentInsurance ? 'checked' : ''}> ê³ ìš©ë³´í—˜</label>
                                    <label><input type="checkbox" name="industrialAccident" ${emp?.industrialAccident ? 'checked' : ''}> ì‚°ì¬ë³´í—˜</label>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <div id="tab-attendance" class="detail-content">
                        <div class="form-title">ê¸°íƒ€ì •ë³´</div>
                        <table class="form-table">
                            <tr>
                                <th>ë…¸ì¡°ê°€ì…</th>
                                <td><input type="checkbox" name="unionMember" ${emp?.unionMember ? 'checked' : ''}></td>
                                <th>ìš°í¸ì£¼ì†Œ</th>
                                <td><input name="mailAddress" value="${emp?.mailAddress || ''}"></td>
                            </tr>
                            <tr>
                                <th>ì¥ì• ì—¬ë¶€</th>
                                <td><input type="checkbox" name="disability" ${emp?.disability ? 'checked' : ''}></td>
                                <th>ë³´í›ˆëŒ€ìƒ</th>
                                <td><input type="checkbox" name="veteran" ${emp?.veteran ? 'checked' : ''}></td>
                            </tr>
                            <tr>
                                <th>ë¹„ê³ </th>
                                <td colspan="3"><textarea name="notes">${emp?.notes || ''}</textarea></td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">ğŸ’¾ ì €ì¥</button>
                        <button type="button" class="btn btn-outline" onclick="cancelForm()">ì·¨ì†Œ</button>
                    </div>
                </form>
            `;
        }

        window.switchTab = function(e, tab) {
            document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.detail-content').forEach(c => c.classList.remove('active'));
            e.target.classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
        }

        window.filterDepartmentsByLocation = function() {
            const locationSelect = document.getElementById('workLocation');
            const deptSelect = document.getElementById('departmentCode');
            const selectedLocation = locationSelect.value;
            
            if (!selectedLocation) {
                deptSelect.innerHTML = '<option value="">ê·¼ë¬´ì§€ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>';
                return;
            }
            
            const allOptions = Array.from(deptSelect.options);
            deptSelect.innerHTML = '<option value="">ì„ íƒ</option>';
            
            allOptions.forEach(option => {
                if (option.dataset.location === selectedLocation) {
                    deptSelect.appendChild(option);
                }
            });
        }

        window.saveEmployee = async function(e) {
            e.preventDefault();
            showLoading();
            
            try {
                const formData = new FormData(e.target);
                const data = {};
                
                for (let [k, v] of formData.entries()) {
                    if (e.target.elements[k].type === 'checkbox') {
                        data[k] = e.target.elements[k].checked;
                    } else {
                        data[k] = v;
                    }
                }
                
                // ë¼ë””ì˜¤ ë²„íŠ¼ ì²˜ë¦¬
                const radios = e.target.querySelectorAll('input[type="radio"]:checked');
                radios.forEach(radio => {
                    data[radio.name] = radio.value;
                });
                
                console.log('ì €ì¥ ë°ì´í„°:', data);
                
                await window.setDoc(window.doc(window.db, 'employees', data.employeeId), data);
                
                alert('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                await loadEmployees();
                selectEmployee(data.employeeId);
                
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                alert('âŒ ì €ì¥ ì˜¤ë¥˜: ' + error.message);
            }
            
            hideLoading();
        }

        window.cancelForm = function() {
            document.getElementById('employee-detail').innerHTML = `
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-outline" onclick="downloadExcelTemplate()">ğŸ“¥ ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn btn-primary" onclick="document.getElementById('excel-upload').click()">ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ</button>
                    <input type="file" id="excel-upload" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelUpload(event)">
                </div>
                <div class="empty-state"><h3>ì§ì›ì„ ì„ íƒí•˜ê±°ë‚˜ ì‹ ê·œ ë“±ë¡í•˜ì„¸ìš”</h3></div>
            `;
        }

        // ===== ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ì–‘ì‹) =====
        window.downloadExcelTemplate = function() {
            const template = [
                {
                    'ì‚¬ë²ˆ': '26011001',
                    'ì„±ëª…': 'í™ê¸¸ë™',
                    'ì˜ë¬¸ëª…': 'Hong Gil Dong',
                    'ë‚´ì™¸êµ­ì¸': 'ë‚´êµ­ì¸',
                    'ì„±ë³„': 'ë‚¨ì„±',
                    'ìƒë…„ì›”ì¼': '1990-01-01',
                    'ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸': '900101-1234567',
                    'íœ´ëŒ€ì „í™”': '010-1234-5678',
                    'ì „í™”ë²ˆí˜¸': '02-1234-5678',
                    'ì£¼ì†Œ': 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬',
                    'ì´ë©”ì¼(íšŒì‚¬)': 'hong@gakorea.com',
                    'ì´ë©”ì¼(ê°œì¸)': 'hong@email.com',
                    'ì€í–‰ëª…': 'ì‹ í•œì€í–‰',
                    'ê³„ì¢Œë²ˆí˜¸': '110-123-456789',
                    'ì˜ˆê¸ˆì£¼': 'í™ê¸¸ë™',
                    'ìµœì¢…í•™ë ¥': 'ëŒ€ì¡¸',
                    'í•™êµëª…': 'OOëŒ€í•™êµ',
                    'ì „ê³µ': 'ê²½ì˜í•™',
                    'ì¡¸ì—…ì¼': '2012-02-28',
                    'ê²°í˜¼ì—¬ë¶€': 'ê¸°í˜¼',
                    'ìë…€ìˆ˜': '2',
                    'ë¹„ìƒì—°ë½ì²˜': '010-9876-5432',
                    'ë¹„ìƒì—°ë½ì²˜ê´€ê³„': 'ë°°ìš°ì',
                    'ì…ì‚¬ì¼': '2020-01-01',
                    'ê·¸ë£¹ì…ì‚¬ì¼': '2020-01-01',
                    'í‡´ì‚¬ì¼': '',
                    'ì¬ì§ìƒíƒœ': 'ì¬ì§',
                    'ë²•ì¸': 'GA KOREA',
                    'ê·¼ë¬´ì§€': 'ë³¸ì‚¬',
                    'ë¶€ì„œ': 'ì¸ì‚¬íŒ€',
                    'ê³ ìš©í˜•íƒœ': 'ì •ê·œì§',
                    'ì§ê¸‰': 'ëŒ€ë¦¬',
                    'ì§ì±…': 'íŒ€ì›',
                    'ì§ë¬´': 'ì¸ì‚¬ê´€ë¦¬',
                    'ê·¼ë¬´í˜•íƒœ': 'ì£¼5ì¼',
                    'ê¸‰ì—¬ë“±ê¸‰': 'G3',
                    'ê¸°ë³¸ê¸‰': '3000000',
                    'ì—°ë´‰': '40000000',
                    'êµ­ë¯¼ì—°ê¸ˆ': 'O',
                    'ê±´ê°•ë³´í—˜': 'O',
                    'ê³ ìš©ë³´í—˜': 'O',
                    'ì‚°ì¬ë³´í—˜': 'O',
                    'ë¹„ê³ ': ''
                }
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(template);
            
            // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = [
                {wch: 12}, {wch: 10}, {wch: 15}, {wch: 10}, {wch: 8},
                {wch: 12}, {wch: 18}, {wch: 15}, {wch: 15}, {wch: 30},
                {wch: 20}, {wch: 20}, {wch: 12}, {wch: 18}, {wch: 10},
                {wch: 10}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 10},
                {wch: 8}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 12},
                {wch: 12}, {wch: 10}, {wch: 15}, {wch: 12}, {wch: 12},
                {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 12},
                {wch: 12}, {wch: 12}, {wch: 12}, {wch: 10}, {wch: 10},
                {wch: 10}, {wch: 10}, {wch: 30}
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'ì§ì›ëª©ë¡');
            XLSX.writeFile(wb, 'ì§ì›ë“±ë¡_ì–‘ì‹.xlsx');
        }

        // ===== ì—‘ì…€ ì—…ë¡œë“œ =====
        window.handleExcelUpload = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading();

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                console.log('ì—‘ì…€ ë°ì´í„°:', jsonData);

                if (jsonData.length === 0) {
                    alert('ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    hideLoading();
                    return;
                }

                // ë²•ì¸, ë¶€ì„œ ë§¤í•‘ ë°ì´í„° ë¡œë“œ
                const companiesSnap = await window.getDocs(window.collection(window.db, 'companies'));
                const companyMap = {};
                companiesSnap.forEach(doc => {
                    const c = doc.data();
                    companyMap[c.name] = c.code;
                });

                const deptsSnap = await window.getDocs(window.collection(window.db, 'departments'));
                const deptMap = {};
                deptsSnap.forEach(doc => {
                    const d = doc.data();
                    deptMap[d.name + '_' + d.location] = d.code;
                });

                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                for (let i = 0; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    
                    try {
                        // í•„ìˆ˜ í•„ë“œ ê²€ì¦
                        if (!row['ì‚¬ë²ˆ'] || !row['ì„±ëª…'] || !row['ì…ì‚¬ì¼']) {
                            errors.push(`${i+2}í–‰: í•„ìˆ˜ í•­ëª© ëˆ„ë½ (ì‚¬ë²ˆ, ì„±ëª…, ì…ì‚¬ì¼)`);
                            errorCount++;
                            continue;
                        }

                        // ë²•ì¸ ì½”ë“œ ì°¾ê¸°
                        const companyCode = companyMap[row['ë²•ì¸']] || 'C001';
                        
                        // ë¶€ì„œ ì½”ë“œ ì°¾ê¸° (ë¶€ì„œëª… + ê·¼ë¬´ì§€)
                        const deptKey = (row['ë¶€ì„œ'] || '') + '_' + (row['ê·¼ë¬´ì§€'] || '');
                        const departmentCode = deptMap[deptKey] || '';

                        // ë°ì´í„° ë§¤í•‘
                        const employeeData = {
                            employeeId: String(row['ì‚¬ë²ˆ']),
                            name: row['ì„±ëª…'],
                            nameEn: row['ì˜ë¬¸ëª…'] || '',
                            nationality: row['ë‚´ì™¸êµ­ì¸'] || 'ë‚´êµ­ì¸',
                            gender: row['ì„±ë³„'] || 'ë‚¨ì„±',
                            birthDate: row['ìƒë…„ì›”ì¼'] || '',
                            residentNumber: row['ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸'] || '',
                            mobile: row['íœ´ëŒ€ì „í™”'] || '',
                            phone: row['ì „í™”ë²ˆí˜¸'] || '',
                            address: row['ì£¼ì†Œ'] || '',
                            companyEmail: row['ì´ë©”ì¼(íšŒì‚¬)'] || '',
                            personalEmail: row['ì´ë©”ì¼(ê°œì¸)'] || '',
                            bankName: row['ì€í–‰ëª…'] || '',
                            accountNumber: row['ê³„ì¢Œë²ˆí˜¸'] || '',
                            accountHolder: row['ì˜ˆê¸ˆì£¼'] || '',
                            education: row['ìµœì¢…í•™ë ¥'] || '',
                            schoolName: row['í•™êµëª…'] || '',
                            major: row['ì „ê³µ'] || '',
                            graduationDate: row['ì¡¸ì—…ì¼'] || '',
                            maritalStatus: row['ê²°í˜¼ì—¬ë¶€'] || 'ë¯¸í˜¼',
                            numberOfChildren: String(row['ìë…€ìˆ˜'] || '0'),
                            emergencyContact: row['ë¹„ìƒì—°ë½ì²˜'] || '',
                            emergencyRelation: row['ë¹„ìƒì—°ë½ì²˜ê´€ê³„'] || '',
                            hireDate: row['ì…ì‚¬ì¼'] || '',
                            groupHireDate: row['ê·¸ë£¹ì…ì‚¬ì¼'] || '',
                            resignDate: row['í‡´ì‚¬ì¼'] || '',
                            workStatus: row['ì¬ì§ìƒíƒœ'] || 'ì¬ì§',
                            companyCode: companyCode,
                            workLocation: row['ê·¼ë¬´ì§€'] || '',
                            departmentCode: departmentCode,
                            employmentType: row['ê³ ìš©í˜•íƒœ'] || 'ì •ê·œì§',
                            position: row['ì§ê¸‰'] || '',
                            jobTitle: row['ì§ì±…'] || '',
                            jobRole: row['ì§ë¬´'] || '',
                            workType: row['ê·¼ë¬´í˜•íƒœ'] || '',
                            salaryGrade: row['ê¸‰ì—¬ë“±ê¸‰'] || '',
                            baseSalary: String(row['ê¸°ë³¸ê¸‰'] || ''),
                            annualSalary: String(row['ì—°ë´‰'] || ''),
                            nationalPension: (row['êµ­ë¯¼ì—°ê¸ˆ'] === 'O' || row['êµ­ë¯¼ì—°ê¸ˆ'] === 'o'),
                            healthInsurance: (row['ê±´ê°•ë³´í—˜'] === 'O' || row['ê±´ê°•ë³´í—˜'] === 'o'),
                            employmentInsurance: (row['ê³ ìš©ë³´í—˜'] === 'O' || row['ê³ ìš©ë³´í—˜'] === 'o'),
                            industrialAccident: (row['ì‚°ì¬ë³´í—˜'] === 'O' || row['ì‚°ì¬ë³´í—˜'] === 'o'),
                            notes: row['ë¹„ê³ '] || ''
                        };

                        await window.setDoc(window.doc(window.db, 'employees', employeeData.employeeId), employeeData);
                        successCount++;
                        
                    } catch (error) {
                        console.error(`${i+2}í–‰ ì €ì¥ ì˜¤ë¥˜:`, error);
                        errors.push(`${i+2}í–‰: ${error.message}`);
                        errorCount++;
                    }
                }

                hideLoading();

                let resultMessage = `ì—…ë¡œë“œ ì™„ë£Œ!\n\nì„±ê³µ: ${successCount}ê±´\nì‹¤íŒ¨: ${errorCount}ê±´`;
                if (errors.length > 0) {
                    resultMessage += '\n\nì˜¤ë¥˜ ë‚´ì—­:\n' + errors.slice(0, 5).join('\n');
                    if (errors.length > 5) {
                        resultMessage += `\n... ì™¸ ${errors.length - 5}ê±´`;
                    }
                }

                alert(resultMessage);
                
                // ì§ì› ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadEmployees();

            } catch (error) {
                hideLoading();
                console.error('ì—‘ì…€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
            }

            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            event.target.value = '';
        }

        // ===== ì„ì§ì› ëª…ë¶€ =====
        async function loadRoster() {
            showLoading();
            
            const companyFilter = document.getElementById('roster-company-filter').value;
            const deptFilter = document.getElementById('roster-dept-filter').value;
            
            // í•„í„° ì˜µì…˜ ë¡œë“œ
            const companiesSnap = await window.getDocs(window.collection(window.db, 'companies'));
            const companies = {};
            companiesSnap.forEach(doc => {
                const c = doc.data();
                companies[c.code] = c.name;
            });
            
            const deptsSnap = await window.getDocs(window.collection(window.db, 'departments'));
            const depts = {};
            deptsSnap.forEach(doc => {
                const d = doc.data();
                depts[d.code] = d.name;
            });
            
            // ë²•ì¸ í•„í„° ì—…ë°ì´íŠ¸
            const companySelect = document.getElementById('roster-company-filter');
            if (companySelect.options.length === 1) {
                Object.entries(companies).forEach(([code, name]) => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = name;
                    companySelect.appendChild(option);
                });
            }
            
            // ì§ì› ë°ì´í„° ë¡œë“œ
            const employeesSnap = await window.getDocs(window.collection(window.db, 'employees'));
            let employees = [];
            employeesSnap.forEach(doc => {
                employees.push(doc.data());
            });
            
            // í•„í„°ë§
            if (companyFilter) {
                // GA KOREA(C001)ëŠ” í†µí•©ë²•ì¸ìœ¼ë¡œ ëª¨ë“  ì§ì› ì¡°íšŒ
                if (companyFilter !== 'C001') {
                    employees = employees.filter(e => e.companyCode === companyFilter);
                }
            }
            if (deptFilter) {
                employees = employees.filter(e => e.departmentCode === deptFilter);
            }
            
            // í…Œì´ë¸” ë Œë”ë§
            const tbody = document.getElementById('roster-tbody');
            if (employees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="padding: 40px; text-align: center; color: #999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            } else {
                tbody.innerHTML = employees.map((emp, idx) => `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${idx + 1}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${emp.employeeId || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">${emp.name || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${companies[emp.companyCode] || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${depts[emp.departmentCode] || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${emp.position || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${emp.hireDate || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${emp.workStatus || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${emp.mobile || '-'}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${emp.companyEmail || emp.personalEmail || '-'}</td>
                    </tr>
                `).join('');
            }
            
            hideLoading();
        }

        window.exportRoster = function() {
            const table = document.getElementById('roster-table');
            let csv = [];
            
            for (let row of table.rows) {
                let rowData = [];
                for (let cell of row.cells) {
                    rowData.push('"' + cell.textContent.replace(/"/g, '""') + '"');
                }
                csv.push(rowData.join(','));
            }
            
            const csvContent = csv.join('\n');
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ì„ì§ì›ëª…ë¶€_' + new Date().toISOString().slice(0,10) + '.csv';
            link.click();
        }

        // ===== ë²•ì¸ ê´€ë¦¬ =====
        async function loadCompanyManagement() {
            showLoading();
            
            // ë²•ì¸ ëª©ë¡ ë¡œë“œ
            const companiesSnap = await window.getDocs(window.collection(window.db, 'companies'));
            const companies = [];
            companiesSnap.forEach(doc => companies.push(doc.data()));
            
            const companyList = document.getElementById('company-list');
            if (companies.length === 0) {
                companyList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">ë“±ë¡ëœ ë²•ì¸ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            } else {
                companyList.innerHTML = companies.map(c => `
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 10px; color: #1976d2;">${c.name}</h3>
                        <p style="margin: 5px 0; font-size: 12px; color: #666;">ë²•ì¸ì½”ë“œ: ${c.code}</p>
                        <p style="margin: 5px 0; font-size: 12px; color: #666;">ì‚¬ì—…ìë²ˆí˜¸: ${c.businessNumber || '-'}</p>
                        <p style="margin: 5px 0; font-size: 12px; color: #666;">ëŒ€í‘œì: ${c.ceo || '-'}</p>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-outline" onclick="editCompany('${c.code}')" style="flex: 1; padding: 8px;">ìˆ˜ì •</button>
                            <button class="btn btn-secondary" onclick="deleteCompany('${c.code}')" style="flex: 1; padding: 8px;">ì‚­ì œ</button>
                        </div>
                    </div>
                `).join('');
            }
            
            // ë¶€ì„œ ëª©ë¡ ë¡œë“œ
            const deptsSnap = await window.getDocs(window.collection(window.db, 'departments'));
            const depts = [];
            deptsSnap.forEach(doc => depts.push({id: doc.id, ...doc.data()}));
            
            const deptTbody = document.getElementById('dept-list');
            if (depts.length === 0) {
                deptTbody.innerHTML = '<tr><td colspan="3" style="padding: 20px; text-align: center; color: #999;">ë“±ë¡ëœ ë¶€ì„œê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            } else {
                deptTbody.innerHTML = depts.map(d => `
                    <tr>
                        <td style="padding: 12px; border: 1px solid #ddd;">${d.name}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${d.location || '-'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">
                            <button class="btn btn-outline" onclick="editDept('${d.id}')" style="padding: 6px 12px; margin-right: 5px;">ìˆ˜ì •</button>
                            <button class="btn btn-secondary" onclick="deleteDept('${d.id}')" style="padding: 6px 12px;">ì‚­ì œ</button>
                        </td>
                    </tr>
                `).join('');
            }
            
            hideLoading();
        }

        window.showAddCompanyForm = function() {
            const code = 'C' + String(Math.floor(Math.random() * 900 + 100)).padStart(3, '0');
            
            if (confirm('ìƒˆ ë²•ì¸ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const name = prompt('ë²•ì¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', '');
                if (!name) return;
                
                const businessNumber = prompt('ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', '');
                const ceo = prompt('ëŒ€í‘œìëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', '');
                
                showLoading();
                window.setDoc(window.doc(window.db, 'companies', code), {
                    code: code,
                    name: name,
                    businessNumber: businessNumber || '',
                    ceo: ceo || ''
                }).then(() => {
                    alert('ë²•ì¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadCompanyManagement();
                }).catch(error => {
                    alert('ì˜¤ë¥˜: ' + error.message);
                    hideLoading();
                });
            }
        }

        window.editCompany = async function(code) {
            const docRef = window.doc(window.db, 'companies', code);
            const docSnap = await window.getDoc(docRef);
            if (!docSnap.exists()) return;
            
            const company = docSnap.data();
            const name = prompt('ë²•ì¸ëª…:', company.name);
            if (!name) return;
            
            const businessNumber = prompt('ì‚¬ì—…ìë²ˆí˜¸:', company.businessNumber || '');
            const ceo = prompt('ëŒ€í‘œìëª…:', company.ceo || '');
            
            showLoading();
            window.setDoc(docRef, {
                code: code,
                name: name,
                businessNumber: businessNumber || '',
                ceo: ceo || ''
            }).then(() => {
                alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadCompanyManagement();
            }).catch(error => {
                alert('ì˜¤ë¥˜: ' + error.message);
                hideLoading();
            });
        }

        window.deleteCompany = async function(code) {
            if (!confirm('ì´ ë²•ì¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê´€ë ¨ ë¶€ì„œì™€ ì§ì› ë°ì´í„°ë„ ì˜í–¥ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) return;
            
            showLoading();
            await window.deleteDoc(window.doc(window.db, 'companies', code));
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadCompanyManagement();
        }

        window.showAddDeptForm = async function() {
            const name = prompt('ë¶€ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', '');
            if (!name) return;
            
            const location = prompt('ê·¼ë¬´ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë³¸ì‚¬, ì„œìš¸, ê³¨ë“œCC ë“±):', '');
            if (!location) return;
            
            const code = 'D' + Date.now().toString().slice(-6); // íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ê³ ìœ  ì½”ë“œ ìƒì„±
            
            showLoading();
            window.setDoc(window.doc(window.db, 'departments', code), {
                code: code,
                name: name,
                location: location,
                companyCode: 'C001' // ê¸°ë³¸ê°’ìœ¼ë¡œ GA KOREA ì„¤ì •
            }).then(() => {
                alert('ë¶€ì„œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadCompanyManagement();
            }).catch(error => {
                alert('ì˜¤ë¥˜: ' + error.message);
                hideLoading();
            });
        }

        window.editDept = async function(code) {
            const docRef = window.doc(window.db, 'departments', code);
            const docSnap = await window.getDoc(docRef);
            if (!docSnap.exists()) return;
            
            const dept = docSnap.data();
            const name = prompt('ë¶€ì„œëª…:', dept.name);
            if (!name) return;
            
            const location = prompt('ê·¼ë¬´ì§€ (ì˜ˆ: ë³¸ì‚¬, ì„œìš¸, ê³¨ë“œCC ë“±):', dept.location || '');
            if (!location) return;
            
            showLoading();
            window.setDoc(docRef, {
                code: code,
                name: name,
                location: location,
                companyCode: dept.companyCode || 'C001' // ê¸°ì¡´ ê°’ ìœ ì§€
            }).then(() => {
                alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadCompanyManagement();
            }).catch(error => {
                alert('ì˜¤ë¥˜: ' + error.message);
                hideLoading();
            });
        }

        window.deleteDept = async function(code) {
            if (!confirm('ì´ ë¶€ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            showLoading();
            await window.deleteDoc(window.doc(window.db, 'departments', code));
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadCompanyManagement();
        }

        // ===== ì‹œìŠ¤í…œ ê´€ë¦¬ì ê´€ë¦¬ =====
        async function loadAdminManagement() {
            showLoading();
            
            const usersSnap = await window.getDocs(window.collection(window.db, 'users'));
            const users = [];
            usersSnap.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
            
            const adminList = document.getElementById('admin-accounts-list');
            if (users.length === 0) {
                adminList.innerHTML = '<p style="color: #999;">ë“±ë¡ëœ ê´€ë¦¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                adminList.innerHTML = users.map(u => `
                    <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; font-size: 14px; margin-bottom: 5px;">
                                ${u.name} 
                                <span style="font-size: 11px; background: ${u.role === 'admin' ? '#1976d2' : '#757575'}; color: white; padding: 2px 8px; border-radius: 10px; margin-left: 8px;">
                                    ${u.role === 'admin' ? 'ì‹œìŠ¤í…œ ê´€ë¦¬ì' : 'ì¼ë°˜ ê´€ë¦¬ì'}
                                </span>
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                ì•„ì´ë””: ${u.username}
                            </div>
                            <div style="font-size: 11px; color: ${u.active ? '#4caf50' : '#f44336'}; margin-top: 3px;">
                                ${u.active ? 'âœ“ í™œì„±' : 'âœ— ë¹„í™œì„±'}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-outline" onclick="changeAdminPassword('${u.id}')" style="padding: 6px 12px; font-size: 11px;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                            <button class="btn btn-outline" onclick="editAdmin('${u.id}')" style="padding: 6px 12px; font-size: 11px;">ìˆ˜ì •</button>
                            ${u.id !== 'admin' ? `<button class="btn btn-secondary" onclick="deleteAdmin('${u.id}')" style="padding: 6px 12px; font-size: 11px;">ì‚­ì œ</button>` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            hideLoading();
        }

        window.showAddAdminForm = function() {
            const username = prompt('ìƒˆ ê´€ë¦¬ì ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', '');
            if (!username) return;
            
            const name = prompt('ê´€ë¦¬ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', '');
            if (!name) return;
            
            const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (8ì ì´ìƒ ê¶Œì¥):', '');
            if (!password) return;
            
            if (password.length < 6) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            const roleChoice = confirm('ì‹œìŠ¤í…œ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní™•ì¸: ì‹œìŠ¤í…œ ê´€ë¦¬ì\nì·¨ì†Œ: ì¼ë°˜ ê´€ë¦¬ì');
            const role = roleChoice ? 'admin' : 'user';
            
            showLoading();
            window.setDoc(window.doc(window.db, 'users', username), {
                username: username,
                password: hashPassword(password),
                name: name,
                role: role,
                active: true
            }).then(() => {
                alert('ê´€ë¦¬ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadAdminManagement();
            }).catch(error => {
                alert('ì˜¤ë¥˜: ' + error.message);
                hideLoading();
            });
        }

        window.changeAdminPassword = async function(userId) {
            const docRef = window.doc(window.db, 'users', userId);
            const docSnap = await window.getDoc(docRef);
            if (!docSnap.exists()) return;
            
            const user = docSnap.data();
            
            const newPassword = prompt(`"${user.name}" ê´€ë¦¬ìì˜ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`, '');
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                showLoading();
                window.setDoc(docRef, {
                    ...user,
                    password: hashPassword(newPassword)
                }).then(() => {
                    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•œ ê²½ìš° ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ë„ë¡ ì•ˆë‚´
                    if (userId === session.username) {
                        alert('ë³¸ì¸ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        location.reload();
                    } else {
                        loadAdminManagement();
                    }
                }).catch(error => {
                    alert('ì˜¤ë¥˜: ' + error.message);
                    hideLoading();
                });
            }
        }

        window.editAdmin = async function(userId) {
            const docRef = window.doc(window.db, 'users', userId);
            const docSnap = await window.getDoc(docRef);
            if (!docSnap.exists()) return;
            
            const user = docSnap.data();
            
            const name = prompt('ê´€ë¦¬ì ì´ë¦„:', user.name);
            if (!name) return;
            
            const activeChoice = confirm('ê³„ì •ì„ í™œì„±í™” ìƒíƒœë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní™•ì¸: í™œì„±\nì·¨ì†Œ: ë¹„í™œì„±');
            
            let role = user.role;
            if (userId !== 'admin') { // ê¸°ë³¸ admin ê³„ì •ì€ ê¶Œí•œ ë³€ê²½ ë¶ˆê°€
                const roleChoice = confirm('ì‹œìŠ¤í…œ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní™•ì¸: ì‹œìŠ¤í…œ ê´€ë¦¬ì\nì·¨ì†Œ: ì¼ë°˜ ê´€ë¦¬ì');
                role = roleChoice ? 'admin' : 'user';
            }
            
            showLoading();
            window.setDoc(docRef, {
                ...user,
                name: name,
                role: role,
                active: activeChoice
            }).then(() => {
                alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadAdminManagement();
            }).catch(error => {
                alert('ì˜¤ë¥˜: ' + error.message);
                hideLoading();
            });
        }

        window.deleteAdmin = async function(userId) {
            if (userId === 'admin') {
                alert('ê¸°ë³¸ ê´€ë¦¬ì ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm('ì´ ê´€ë¦¬ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            showLoading();
            await window.deleteDoc(window.doc(window.db, 'users', userId));
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadAdminManagement();
        }
    </script>
</body>
</html>
