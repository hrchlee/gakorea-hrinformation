<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA KOREA ì¸ì‚¬ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <!-- 
        ë²„ì „: v2.1.0 - 2026-01-04
        ë³€ê²½ì‚¬í•­:
        - HTTPS ê°•ì œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì œê±° (GitHub Pages í˜¸í™˜)
        - ì¬ì§ì •ë³´ ë²•ì¸/ë¶€ì„œëª… ì‹¤ì œ ì¡°íšŒ í‘œì‹œ
        - ì‚¬ë²ˆ ìë™ìƒì„± ì œê±°, í•„ìˆ˜ ì…ë ¥ìœ¼ë¡œ ë³€ê²½
        - ê²€ìƒ‰ ë²„íŠ¼ ì¶”ê°€ ë° í•„í„°ë§ ê¸°ëŠ¥ ê°œì„ 
        - ì„ì›/ìë¬¸/ê³ ë¬¸ VIP ìš°ì„  ì •ë ¬
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Malgun Gothic', sans-serif; background: #f5f6f8; font-size: 12px; }
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .login-box { background: white; padding: 50px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); width: 450px; }
        .login-header { text-align: center; margin-bottom: 40px; }
        .login-header h1 { color: #333; font-size: 28px; margin-bottom: 10px; }
        .firebase-badge { background: #ff9800; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; display: inline-block; margin-top: 10px; }
        .login-form .form-group { margin-bottom: 20px; }
        .login-form label { display: block; margin-bottom: 8px; color: #333; font-weight: bold; }
        .login-form input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .login-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .error-msg { background: #ffebee; color: #c62828; padding: 12px; border-radius: 4px; margin-bottom: 20px; display: none; text-align: center; }
        .main-screen { display: none; }
        .main-screen.active { display: block; }
        .header { background: white; border-bottom: 2px solid #e0e0e0; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .header-left h1 { color: #333; font-size: 18px; font-weight: bold; }
        .header-right { display: flex; gap: 15px; align-items: center; }
        .logout-btn { padding: 8px 16px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .tab-menu { background: white; border-bottom: 1px solid #e0e0e0; padding: 0 30px; display: flex; gap: 5px; }
        .tab-btn { padding: 12px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 13px; color: #666; position: relative; }
        .tab-btn.active { color: #1976d2; border-bottom-color: #1976d2; font-weight: bold; }
        .tab-btn:hover .dropdown-menu { display: block; }
        .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #e0e0e0; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 180px; z-index: 1000; }
        .dropdown-item { padding: 12px 20px; cursor: pointer; font-size: 13px; color: #333; border-bottom: 1px solid #f0f0f0; white-space: nowrap; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: #f5f9ff; color: #1976d2; }
        .layout { display: flex; height: calc(100vh - 120px); }
        .sidebar { width: 250px; background: white; border-right: 1px solid #e0e0e0; padding: 20px; overflow-y: auto; }
        .main-content { flex: 1; background: white; overflow-y: auto; padding: 25px; }
        .filter-section { margin-bottom: 20px; }
        .filter-section h3 { font-size: 13px; margin-bottom: 10px; font-weight: bold; }
        .filter-group { margin-bottom: 12px; }
        .filter-group label { display: block; margin-bottom: 6px; font-size: 12px; color: #666; }
        .filter-group input, .filter-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; }
        .employee-list { border-top: 1px solid #e0e0e0; margin-top: 15px; padding-top: 15px; max-height: 400px; overflow-y: auto; }
        .employee-item { padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 8px; cursor: pointer; }
        .employee-item:hover { background: #f5f9ff; border-color: #1976d2; }
        .employee-item .name { font-weight: bold; margin-bottom: 4px; }
        .employee-item .info { font-size: 11px; color: #666; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: #1976d2; color: white; }
        .btn-secondary { background: #757575; color: white; }
        .btn-outline { background: white; border: 1px solid #ddd; color: #666; }
        .form-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .form-table tr { border-bottom: 1px solid #f0f0f0; }
        .form-table th { width: 150px; padding: 10px; text-align: left; background: #fafafa; font-weight: 600; font-size: 12px; border-right: 1px solid #e0e0e0; }
        .form-table td { padding: 10px; }
        .form-table input, .form-table select, .form-table textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; }
        .form-table textarea { min-height: 60px; font-family: inherit; }
        .required::after { content: ' *'; color: #f44336; }
        .detail-tabs { display: flex; gap: 2px; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px; }
        .detail-tab { padding: 10px 20px; background: #f5f5f5; border: none; border-radius: 4px 4px 0 0; cursor: pointer; font-size: 13px; color: #666; }
        .detail-tab.active { background: white; color: #1976d2; font-weight: bold; border-bottom: 2px solid white; margin-bottom: -1px; }
        .detail-content { display: none; }
        .detail-content.active { display: block; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .button-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0; }
        .form-title { font-size: 14px; color: #1976d2; margin: 20px 0 10px 0; font-weight: bold; padding-bottom: 8px; border-bottom: 2px solid #1976d2; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .loading.active { display: flex; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #1976d2; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .radio-group { display: flex; gap: 10px; }
        .context-menu-item:hover { background: #f5f9ff; color: #1976d2; }
    </style>
</head>
<body>
    <div class="loading" id="loading"><div class="spinner"></div></div>

    <div id="login-screen" class="login-screen">
        <div class="login-box">
            <div class="login-header">
                <h1>ğŸ¢ ê·¸ë£¹ ì¸ì‚¬ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
                <p>ê´€ë¦¬ì ë¡œê·¸ì¸</p>
                <span class="firebase-badge">ğŸ” Firebase Authentication</span>
            </div>
            <div class="error-msg" id="login-error">ë¡œê·¸ì¸ ì‹¤íŒ¨</div>
            <form class="login-form" id="login-form">
                <div class="form-group">
                    <label>ì´ë©”ì¼</label>
                    <input type="email" id="login-email" placeholder="example@company.com" required>
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="login-btn" id="login-btn">ë¡œê·¸ì¸</button>
            </form>
        </div>
    </div>

    <div id="main-screen" class="main-screen">
        <div class="header">
            <div class="header-left"><h1>GA KOREA ì¸ì‚¬ê´€ë¦¬ì‹œìŠ¤í…œ</h1></div>
            <div class="header-right">
                <div class="user-info"><strong id="current-user"></strong></div>
                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="tab-menu">
            <button id="tab-dashboard" class="tab-btn active" onclick="switchMainTab('dashboard')">HR ëŒ€ì‹œë³´ë“œ</button>
            <button id="tab-employee" class="tab-btn">
                ì§ì› ê´€ë¦¬
                <div class="dropdown-menu">
                    <div class="dropdown-item" onclick="switchMainTab('employee-info')">ì„ì§ì› ê´€ë¦¬</div>
                    <div class="dropdown-item" onclick="switchMainTab('salary-info')">ì—°ë´‰ì •ë³´</div>
                </div>
            </button>
            <button id="tab-employee-data" class="tab-btn">
                ì„ì§ì› ì •ë³´
                <div class="dropdown-menu">
                    <div class="dropdown-item" onclick="switchMainTab('employee-roster')">ì„ì§ì› ëª…ë¶€</div>
                    <div class="dropdown-item" onclick="switchMainTab('org-chart')">ì¡°ì§ë„</div>
                    <div class="dropdown-item" onclick="switchMainTab('employee-record')">ì¸ì‚¬ê¸°ë¡ì¹´ë“œ</div>
                </div>
            </button>
            <button id="tab-company" class="tab-btn" onclick="switchMainTab('company')">ë²•ì¸ ê´€ë¦¬</button>
            <button id="tab-admin" class="tab-btn" onclick="switchMainTab('admin')">ì‹œìŠ¤í…œ ê´€ë¦¬ì</button>
        </div>

        <!-- HR ëŒ€ì‹œë³´ë“œ íƒ­ -->
        <div id="dashboard-tab" class="layout" style="display: none;">
            <div class="main-content" style="padding: 40px 60px; max-width: 1600px; margin: 0 auto;">
                <h2 style="margin-bottom: 30px; color: #333; font-size: 20px; font-weight: 600;">ğŸ“Š HR ëŒ€ì‹œë³´ë“œ</h2>
                
                <!-- ìƒë‹¨ ìš”ì•½ ì¹´ë“œ (4ê°œ) -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 30px;">
                    <!-- ì „ì²´ ì§ì› -->
                    <div style="background: white; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: #eff6ff; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 20px;">ğŸ‘¥</span>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">ì „ì²´ ì§ì›</div>
                                <div style="font-size: 24px; font-weight: 700; color: #1f2937;" id="total-employees">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì‹ ê·œ ì…í‡´ì‚¬ì -->
                    <div style="background: white; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: #f0fdf4; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 20px;">ğŸ“ˆ</span>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">ì´ë²ˆ ë‹¬ ì…í‡´ì‚¬</div>
                                <div style="display: flex; align-items: baseline; gap: 8px;">
                                    <span style="font-size: 18px; font-weight: 700; color: #16a34a;" id="new-hires">-</span>
                                    <span style="font-size: 11px; color: #16a34a;">ì…ì‚¬</span>
                                    <span style="font-size: 18px; font-weight: 700; color: #dc2626;" id="resignations">-</span>
                                    <span style="font-size: 11px; color: #dc2626;">í‡´ì‚¬</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì±„ìš© ì§„í–‰ í¬ì§€ì…˜ -->
                    <div style="background: white; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 20px;">ğŸ“‹</span>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">ì±„ìš© ì§„í–‰ í¬ì§€ì…˜</div>
                                <div style="font-size: 24px; font-weight: 700; color: #1f2937;" id="open-positions">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì¸ì‚¬íŒ€ KPI ë‹¬ì„±ë¥  -->
                    <div style="background: white; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: #fce7f3; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 20px;">ğŸ¯</span>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">ì¸ì‚¬íŒ€ KPI ë‹¬ì„±ë¥ </div>
                                <div style="font-size: 24px; font-weight: 700; color: #1f2937;" id="hr-kpi">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ì¤‘ë‹¨ ì˜ì—­: 3ê°œ ì„¹ì…˜ -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 30px;">
                    <!-- ì±„ìš© í˜„í™© -->
                    <div style="background: white; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <h3 style="margin-bottom: 16px; color: #1f2937; font-size: 14px; font-weight: 600;">ì±„ìš© ì§„í–‰ í˜„í™©</h3>
                        <div id="recruitment-status" style="font-size: 12px;"></div>
                    </div>
                    
                    <!-- ì¡°ì§ ê±´ê°•ë„ & ë¦¬ìŠ¤í¬ -->
                    <div style="background: white; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <h3 style="margin-bottom: 16px; color: #1f2937; font-size: 14px; font-weight: 600;">ì¡°ì§ ê±´ê°•ë„ & ë¦¬ìŠ¤í¬</h3>
                        <div id="org-health" style="font-size: 12px;"></div>
                    </div>
                    
                    <!-- ëª©í‘œ ë‹¬ì„±ë¥  -->
                    <div style="background: white; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <h3 style="margin-bottom: 16px; color: #1f2937; font-size: 14px; font-weight: 600;">ë¶€ì„œë³„ ëª©í‘œ ë‹¬ì„±ë¥ </h3>
                        <div id="goal-achievement" style="font-size: 12px;"></div>
                    </div>
                </div>
                
                <!-- í•˜ë‹¨ ì˜ì—­: 2ê°œ ì°¨íŠ¸ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div style="background: white; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <h3 style="margin-bottom: 16px; color: #1f2937; font-size: 14px; font-weight: 600;">ë¶€ì„œë³„ ì¸ì› í˜„í™©</h3>
                        <div id="dept-chart" style="max-height: 280px; overflow-y: auto;"></div>
                    </div>
                    
                    <div style="background: white; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <h3 style="margin-bottom: 16px; color: #1f2937; font-size: 14px; font-weight: 600;">ì§ê¸‰ë³„ ì¸ì› í˜„í™©</h3>
                        <div id="position-chart" style="max-height: 280px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="employee-info-tab" class="layout" style="display: none;">
            <div class="sidebar">
                <div class="filter-section">
                    <h3>ê²€ìƒ‰</h3>
                    <input type="text" id="search-employee" placeholder="ì´ë¦„/ì‚¬ë²ˆ..." oninput="filterEmployees()">
                </div>
                <div class="filter-section">
                    <h3>ë²•ì¸</h3>
                    <select id="filter-company" onchange="filterEmployees()"></select>
                </div>
                <div style="padding: 0 15px 10px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #e0e0e0;">
                    <input type="checkbox" id="select-all-checkbox" onclick="toggleSelectAll()" style="width: 16px; height: 16px; cursor: pointer;">
                    <label for="select-all-checkbox" style="cursor: pointer; font-size: 13px; color: #666;">ì „ì²´ ì„ íƒ</label>
                </div>
                <div class="employee-list" id="employee-list">
                    <div class="empty-state"><p>ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</p></div>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="showNewEmployeeForm()">+ ì‹ ê·œ ë“±ë¡</button>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="deleteSelectedEmployees()" id="delete-selected-btn">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
            </div>

            <div class="main-content" id="employee-detail">
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-outline" onclick="downloadExcelTemplate()">ğŸ“¥ ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn btn-primary" onclick="document.getElementById('excel-upload').click()">ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ</button>
                    <input type="file" id="excel-upload" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelUpload(event)">
                </div>
                <div class="empty-state"><h3>ì§ì›ì„ ì„ íƒí•˜ê±°ë‚˜ ì‹ ê·œ ë“±ë¡í•˜ì„¸ìš”</h3></div>
            </div>
        </div>

        <!-- ì„ì§ì› ëª…ë¶€ íƒ­ -->
        <div id="employee-roster-tab" class="layout" style="display: none;">
            <div class="main-content" style="padding: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ì„ì§ì› ëª…ë¶€</h2>
                    <button class="btn btn-primary" onclick="exportRoster()">ğŸ“Š Excel ë‚´ë³´ë‚´ê¸°</button>
                </div>
                
                <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <select id="roster-company-filter" onchange="loadRoster()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">ì „ì²´ ë²•ì¸</option>
                    </select>
                    <select id="roster-location-filter" onchange="loadRoster()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">ì „ì²´ ê·¼ë¬´ì§€</option>
                    </select>
                    <select id="roster-position-filter" onchange="loadRoster()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">ì „ì²´ ì§ê¸‰</option>
                    </select>
                    <select id="roster-jobtitle-filter" onchange="loadRoster()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">ì „ì²´ ì§ìœ„</option>
                    </select>
                </div>

                <div style="overflow-x: auto;">
                    <table id="roster-table" style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 11px;">
                        <thead style="background: #f5f5f5;">
                            <tr>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap; width: 40px;">No</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ê·¼ë¬´ì§€</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ë¶€ì„œ</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì„±ëª…</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì§ìœ„</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì§ê¸‰</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì§ë¬´</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì†Œì†ë²•ì¸</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ìƒë…„ì›”ì¼</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ë‚˜ì´</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì„±ë³„</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ìµœì´ˆì…ì‚¬ì¼</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ê·¼ì†ê¸°ê°„</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì—°ë´‰</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ìµœì¢…í•™ë ¥</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì—°ë½ì²˜</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì´ë©”ì¼</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì£¼ì†Œ</th>
                            </tr>
                        </thead>
                        <tbody id="roster-tbody">
                            <tr>
                                <td colspan="19" style="padding: 40px; text-align: center; color: #999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ì¸ì‚¬ê¸°ë¡ì¹´ë“œ íƒ­ -->
        <div id="employee-record-tab" class="layout" style="display: none;">
            <div class="main-content" style="padding: 30px;">
                <h2>ì¸ì‚¬ê¸°ë¡ì¹´ë“œ</h2>
                <div class="empty-state"><p>ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤</p></div>
            </div>
        </div>

        <!-- ì¡°ì§ë„ íƒ­ -->
        <div id="org-chart-tab" class="layout" style="display: none;">
            <div style="display: flex; height: calc(100vh - 60px); width: 100%;">
                <!-- ì¡°ì§ë„ ë©”ì¸ ì˜ì—­ -->
                <div id="org-chart-main" style="flex: 1; background: #fff; position: relative; overflow: auto;">
                    <!-- ìƒë‹¨ ì •ë³´ -->
                    <div style="display: flex; justify-content: space-between; padding: 15px 30px; border-bottom: 1px solid #e0e0e0;">
                        <div id="org-chart-info" style="font-size: 12px; line-height: 1.6;">
                            <div>ê¸°ì¤€ì¼ : <span id="org-chart-date"></span></div>
                            <div>ì´ì¸ì› : <span id="org-chart-total">0</span>ëª…</div>
                            <div>íŠ¹ì´ì‚¬í•­ : <span id="org-chart-special">-</span></div>
                        </div>
                        <div style="text-align: center; flex: 1;">
                            <h1 style="font-size: 24px; font-weight: bold; color: #333; margin: 0;">GA KOREA ì¡°ì§ë„</h1>
                        </div>
                        <div style="font-size: 12px; text-align: right;">
                            <div>ê¸°ì¤€ì¼ : <span id="org-chart-date2"></span></div>
                            <button onclick="showOrgStyleModal()" style="margin-top: 8px; padding: 6px 12px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">âš™ï¸ ì–‘ì‹ ìˆ˜ì •</button>
                        </div>
                    </div>
                    
                    <!-- ì¡°ì§ë„ ìº”ë²„ìŠ¤ ì˜ì—­ -->
                    <div id="org-chart-canvas" style="width: 100%; min-height: 1500px; position: relative; padding: 20px;" oncontextmenu="showOrgChartContextMenu(event); return false;">
                        <!-- SVG ì—°ê²°ì„  ë ˆì´ì–´ -->
                        <svg id="org-chart-svg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;"></svg>
                        <!-- ì¡°ì§ë„ ìš”ì†Œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </div>
                </div>
                
                <!-- ì„ì§ì› íŒ¨ë„ (ê¸°ë³¸ ìˆ¨ê¹€) -->
                <div id="org-chart-employee-panel" style="width: 280px; background: #f5f5f5; border-left: 1px solid #ddd; display: none; flex-direction: column;">
                    <div style="padding: 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 14px;">ì„ì§ì› ëª©ë¡</h3>
                        <button onclick="hideEmployeePanel()" style="background: none; border: none; cursor: pointer; font-size: 18px;">âœ•</button>
                    </div>
                    <div style="padding: 10px;">
                        <input type="text" id="org-employee-search" placeholder="ì´ë¦„ ê²€ìƒ‰..." oninput="filterOrgEmployees()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <div id="org-employee-list" style="flex: 1; overflow-y: auto; padding: 10px;">
                        <!-- ì„ì§ì› ëª©ë¡ -->
                    </div>
                </div>
            </div>
            
            <!-- ë¹ˆê³µê°„ ìš°í´ë¦­ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ -->
            <div id="org-context-menu" style="display: none; position: fixed; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); z-index: 1000;">
                <div class="context-menu-item" onclick="showCreateDeptModal()" style="padding: 10px 20px; cursor: pointer; font-size: 13px;">ë¶€ì„œ ìƒì„±</div>
                <div class="context-menu-item" onclick="showEmployeePanel()" style="padding: 10px 20px; cursor: pointer; font-size: 13px; border-top: 1px solid #eee;">ì„ì§ì› ë¶ˆëŸ¬ì˜¤ê¸°</div>
            </div>
            
            <!-- ë¶€ì„œ ìš°í´ë¦­ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ -->
            <div id="dept-context-menu" style="display: none; position: fixed; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); z-index: 1000;">
                <div class="context-menu-item" onclick="showCreateTeamModal()" style="padding: 10px 20px; cursor: pointer; font-size: 13px;">í•˜ìœ„ íŒ€ ìƒì„±</div>
                <div class="context-menu-item" onclick="editDept()" style="padding: 10px 20px; cursor: pointer; font-size: 13px; border-top: 1px solid #eee;">ë¶€ì„œ ìˆ˜ì •</div>
                <div class="context-menu-item" onclick="deleteSelectedDept()" style="padding: 10px 20px; cursor: pointer; font-size: 13px; border-top: 1px solid #eee; color: #d32f2f;">ë¶€ì„œ ì‚­ì œ</div>
            </div>
            
            <!-- ë¶€ì„œ ìƒì„± ëª¨ë‹¬ -->
            <div id="create-dept-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; justify-content: center; align-items: center;">
                <div style="background: white; padding: 25px; border-radius: 8px; width: 380px;">
                    <h3 id="dept-modal-title" style="margin: 0 0 20px 0;">ë¶€ì„œ ìƒì„±</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">ë¶€ì„œëª…</label>
                        <input type="text" id="new-dept-name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">ë ˆë²¨ (1~10)</label>
                        <select id="new-dept-level" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="1">ë ˆë²¨ 1 (ìµœìƒìœ„)</option>
                            <option value="2">ë ˆë²¨ 2</option>
                            <option value="3">ë ˆë²¨ 3</option>
                            <option value="4">ë ˆë²¨ 4</option>
                            <option value="5">ë ˆë²¨ 5</option>
                            <option value="6">ë ˆë²¨ 6</option>
                            <option value="7">ë ˆë²¨ 7</option>
                            <option value="8">ë ˆë²¨ 8</option>
                            <option value="9">ë ˆë²¨ 9</option>
                            <option value="10">ë ˆë²¨ 10 (ìµœí•˜ìœ„)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">ìƒ‰ìƒ</label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <div class="color-option" data-color="#1976d2" onclick="selectDeptColor('#1976d2')" style="width: 30px; height: 30px; background: #1976d2; border-radius: 4px; cursor: pointer; border: 2px solid transparent;"></div>
                            <div class="color-option" data-color="#388e3c" onclick="selectDeptColor('#388e3c')" style="width: 30px; height: 30px; background: #388e3c; border-radius: 4px; cursor: pointer; border: 2px solid transparent;"></div>
                            <div class="color-option" data-color="#f57c00" onclick="selectDeptColor('#f57c00')" style="width: 30px; height: 30px; background: #f57c00; border-radius: 4px; cursor: pointer; border: 2px solid transparent;"></div>
                            <div class="color-option" data-color="#d32f2f" onclick="selectDeptColor('#d32f2f')" style="width: 30px; height: 30px; background: #d32f2f; border-radius: 4px; cursor: pointer; border: 2px solid transparent;"></div>
                            <div class="color-option" data-color="#7b1fa2" onclick="selectDeptColor('#7b1fa2')" style="width: 30px; height: 30px; background: #7b1fa2; border-radius: 4px; cursor: pointer; border: 2px solid transparent;"></div>
                            <div class="color-option" data-color="#455a64" onclick="selectDeptColor('#455a64')" style="width: 30px; height: 30px; background: #455a64; border-radius: 4px; cursor: pointer; border: 2px solid transparent;"></div>
                            <div class="color-option" data-color="#00796b" onclick="selectDeptColor('#00796b')" style="width: 30px; height: 30px; background: #00796b; border-radius: 4px; cursor: pointer; border: 2px solid transparent;"></div>
                            <div class="color-option" data-color="#5d4037" onclick="selectDeptColor('#5d4037')" style="width: 30px; height: 30px; background: #5d4037; border-radius: 4px; cursor: pointer; border: 2px solid transparent;"></div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeCreateDeptModal()" style="padding: 8px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">ì·¨ì†Œ</button>
                        <button onclick="createDeptBox()" style="padding: 8px 20px; border: none; background: #1976d2; color: white; border-radius: 4px; cursor: pointer;">ìƒì„±</button>
                    </div>
                </div>
            </div>
            
            <!-- í•˜ìœ„ íŒ€ ìƒì„± ëª¨ë‹¬ -->
            <div id="create-team-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; justify-content: center; align-items: center;">
                <div style="background: white; padding: 25px; border-radius: 8px; width: 350px;">
                    <h3 style="margin: 0 0 20px 0;">í•˜ìœ„ íŒ€ ìƒì„±</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">íŒ€ëª…</label>
                        <input type="text" id="new-team-name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeCreateTeamModal()" style="padding: 8px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">ì·¨ì†Œ</button>
                        <button onclick="createTeam()" style="padding: 8px 20px; border: none; background: #1976d2; color: white; border-radius: 4px; cursor: pointer;">ìƒì„±</button>
                    </div>
                </div>
            </div>
            
            <!-- ì–‘ì‹ ìˆ˜ì • ëª¨ë‹¬ -->
            <div id="org-style-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; justify-content: center; align-items: center;">
                <div style="background: white; padding: 25px; border-radius: 8px; width: 400px;">
                    <h3 style="margin: 0 0 20px 0;">ì¡°ì§ë„ ì–‘ì‹ ìˆ˜ì •</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">ë ˆë²¨ ê°„ ë†’ì´ (px)</label>
                        <input type="range" id="style-level-height" min="80" max="200" value="120" oninput="document.getElementById('style-level-height-val').textContent = this.value" style="width: 100%;">
                        <span id="style-level-height-val" style="font-size: 12px; color: #666;">120</span>px
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">ë¶€ì„œ ë°•ìŠ¤ ìµœì†Œ ë„ˆë¹„ (px)</label>
                        <input type="range" id="style-box-width" min="80" max="180" value="100" oninput="document.getElementById('style-box-width-val').textContent = this.value" style="width: 100%;">
                        <span id="style-box-width-val" style="font-size: 12px; color: #666;">100</span>px
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">ë¶€ì„œëª… ê¸€ì í¬ê¸° (px)</label>
                        <input type="range" id="style-header-font" min="9" max="14" value="11" oninput="document.getElementById('style-header-font-val').textContent = this.value" style="width: 100%;">
                        <span id="style-header-font-val" style="font-size: 12px; color: #666;">11</span>px
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">ì§ì› ê¸€ì í¬ê¸° (px)</label>
                        <input type="range" id="style-member-font" min="8" max="12" value="10" oninput="document.getElementById('style-member-font-val').textContent = this.value" style="width: 100%;">
                        <span id="style-member-font-val" style="font-size: 12px; color: #666;">10</span>px
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 13px;">í—¤ë” íŒ¨ë”© (px)</label>
                        <input type="range" id="style-header-padding" min="4" max="12" value="6" oninput="document.getElementById('style-header-padding-val').textContent = this.value" style="width: 100%;">
                        <span id="style-header-padding-val" style="font-size: 12px; color: #666;">6</span>px
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeOrgStyleModal()" style="padding: 8px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">ì·¨ì†Œ</button>
                        <button onclick="applyOrgStyle()" style="padding: 8px 20px; border: none; background: #1976d2; color: white; border-radius: 4px; cursor: pointer;">ì ìš©</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì—°ë´‰ì •ë³´ íƒ­ -->
        <div id="salary-info-tab" class="layout" style="display: none;">
            <div class="main-content" style="padding: 30px;">
                <h2 style="margin-bottom: 20px;">ì—°ë´‰ì •ë³´</h2>
                
                <!-- í•„í„° -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center;">
                    <select id="salary-company-filter" onchange="filterSalaryInfo()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">ì „ì²´ ë²•ì¸</option>
                    </select>
                    <select id="salary-location-filter" onchange="filterSalaryInfo()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">ì „ì²´ ê·¼ë¬´ì§€</option>
                    </select>
                    <select id="salary-position-filter" onchange="filterSalaryInfo()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">ì „ì²´ ì§ê¸‰</option>
                    </select>
                    <select id="salary-jobtitle-filter" onchange="filterSalaryInfo()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">ì „ì²´ ì§ìœ„</option>
                    </select>
                    <div style="margin-left: auto; display: flex; gap: 10px;">
                        <button class="btn btn-outline" onclick="downloadSalaryTemplate()">ğŸ“¥ ì—°ë´‰ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn btn-primary" onclick="document.getElementById('salary-excel-upload').click()">ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ</button>
                        <input type="file" id="salary-excel-upload" accept=".xlsx,.xls" style="display: none;" onchange="handleSalaryExcelUpload(event)">
                        <button id="salary-edit-btn" class="btn btn-secondary" onclick="enableSalaryEdit()">âœï¸ ì—°ë´‰ì •ë³´ ìˆ˜ì •</button>
                        <button id="salary-save-btn" class="btn btn-primary" onclick="saveSalaryChanges()" style="display: none;">ğŸ’¾ ì €ì¥</button>
                        <button id="salary-cancel-btn" class="btn btn-outline" onclick="cancelSalaryEdit()" style="display: none;">ì·¨ì†Œ</button>
                        <button class="btn btn-primary" onclick="exportSalary()">ğŸ“Š Excel ë‚´ë³´ë‚´ê¸°</button>
                    </div>
                </div>

                <!-- ì—°ë´‰ì •ë³´ í…Œì´ë¸” -->
                <div style="overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <table id="salary-table" style="width: 100%; border-collapse: collapse; background: white; font-size: 11px;">
                        <thead style="background: #f5f5f5;">
                            <tr>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap; width: 40px;">No</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ê·¼ë¬´ì§€</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ë¶€ì„œ</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì„±ëª…</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì§ìœ„</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ë²•ì¸ëª…</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì…ì‚¬ì¼</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">í†µìƒì„ê¸ˆ</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ê¸°ë³¸ê¸‰</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì°¨ëŸ‰ë³´ì¡°ë¹„</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ê¸°íƒ€ìˆ˜ë‹¹</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì—°ì¥ê·¼ë¡œìˆ˜ë‹¹</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">íœ´ì¼ê·¼ë¡œìˆ˜ë‹¹</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì•¼ê°„ê·¼ë¡œìˆ˜ë‹¹</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ê³ ì •ìƒì—¬</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì›” ê¸‰ì—¬ ê³„</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì—°ë´‰</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ë¹„ê³¼ì„¸</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì—°ì¥ê·¼ë¡œ(ì‹œê°„)</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">íœ´ì¼ê·¼ë¡œ(ì¼)</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">íœ´ì¼ê·¼ë¡œ(ì‹œê°„)</th>
                                <th style="padding: 6px 8px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">ì•¼ê°„ê·¼ë¡œ(ì‹œê°„)</th>
                            </tr>
                        </thead>
                        <tbody id="salary-tbody">
                            <tr>
                                <td colspan="22" style="padding: 40px; text-align: center; color: #999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ë²•ì¸ ê´€ë¦¬ íƒ­ -->
        <div id="company-tab" class="layout" style="display: none;">
            <div class="main-content" style="padding: 30px;">
                <h2 style="margin-bottom: 20px;">ë²•ì¸ ê´€ë¦¬</h2>
                
                <div style="margin-bottom: 30px;">
                    <button class="btn btn-primary" onclick="showAddCompanyForm()">+ ë²•ì¸ ì¶”ê°€</button>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;" id="company-list">
                    <div style="text-align: center; padding: 40px; color: #999;">ë²•ì¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>

                <!-- ë¶€ì„œ ê´€ë¦¬ ì„¹ì…˜ -->
                <h2 style="margin: 40px 0 20px 0;">ë¶€ì„œ ê´€ë¦¬</h2>
                
                <div style="margin-bottom: 30px;">
                    <button class="btn btn-primary" onclick="showAddDeptForm()">+ ë¶€ì„œ ì¶”ê°€</button>
                </div>

                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white;">
                        <thead style="background: #f5f5f5;">
                            <tr>
                                <th style="padding: 12px; border: 1px solid #ddd;">ë¶€ì„œëª…</th>
                                <th style="padding: 12px; border: 1px solid #ddd;">ê·¼ë¬´ì§€</th>
                                <th style="padding: 12px; border: 1px solid #ddd;">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="dept-list">
                            <tr>
                                <td colspan="3" style="padding: 20px; text-align: center; color: #999;">ë¶€ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ì‹œìŠ¤í…œ ê´€ë¦¬ì íƒ­ -->
        <div id="admin-tab" class="layout" style="display: none;">
            <div class="main-content" style="padding: 30px;">
                <h2 style="margin-bottom: 30px;">ì‹œìŠ¤í…œ ì„¤ì •</h2>

                <!-- ì„¤ì •ê°’ ê´€ë¦¬ -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 40px;">
                    <!-- ì§ê¸‰ ì„¤ì • -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 15px; color: #1976d2;">ì§ê¸‰ ì„¤ì •</h3>
                        <div id="position-list" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto;"></div>
                        <button class="btn btn-outline" onclick="addSetting('position')" style="width: 100%; padding: 8px;">+ ì§ê¸‰ ì¶”ê°€</button>
                    </div>

                    <!-- ì§ìœ„ ì„¤ì • -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 15px; color: #1976d2;">ì§ìœ„ ì„¤ì •</h3>
                        <div id="jobtitle-list" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto;"></div>
                        <button class="btn btn-outline" onclick="addSetting('jobTitle')" style="width: 100%; padding: 8px;">+ ì§ìœ„ ì¶”ê°€</button>
                    </div>

                    <!-- ì§ì±… ì„¤ì • -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 15px; color: #1976d2;">ì§ì±… ì„¤ì •</h3>
                        <div id="jobrole-list" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto;"></div>
                        <button class="btn btn-outline" onclick="addSetting('jobRole')" style="width: 100%; padding: 8px;">+ ì§ì±… ì¶”ê°€</button>
                    </div>

                    <!-- ê·¼ë¬´ì§€ ì„¤ì • -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 15px; color: #1976d2;">ê·¼ë¬´ì§€ ì„¤ì •</h3>
                        <div id="location-list" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto;"></div>
                        <button class="btn btn-outline" onclick="addSetting('location')" style="width: 100%; padding: 8px;">+ ê·¼ë¬´ì§€ ì¶”ê°€</button>
                    </div>

                    <!-- ê³ ìš©í˜•íƒœ ì„¤ì • -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 15px; color: #1976d2;">ê³ ìš©í˜•íƒœ ì„¤ì •</h3>
                        <div id="employmenttype-list" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto;"></div>
                        <button class="btn btn-outline" onclick="addSetting('employmentType')" style="width: 100%; padding: 8px;">+ ê³ ìš©í˜•íƒœ ì¶”ê°€</button>
                    </div>

                    <!-- ëª…ë¶€ ì •ë ¬ ê¸°ì¤€ ì„¤ì • -->
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 15px; color: #1976d2;">ì„ì§ì› ëª…ë¶€ ì •ë ¬ ê¸°ì¤€</h3>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ì •ë ¬ ê¸°ì¤€ 1 (1ì°¨)</label>
                            <select id="roster-sort-1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">ì„ íƒ ì•ˆ í•¨</option>
                                <option value="name">ì´ë¦„ìˆœ</option>
                                <option value="hireDate">ì…ì‚¬ì¼ìˆœ</option>
                                <option value="position">ì§ê¸‰ìˆœ</option>
                                <option value="jobTitle">ì§ìœ„ìˆœ</option>
                                <option value="jobRole">ì§ì±…ìˆœ</option>
                                <option value="department">ë¶€ì„œìˆœ</option>
                                <option value="location">ê·¼ë¬´ì§€ìˆœ</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ì •ë ¬ ê¸°ì¤€ 2 (2ì°¨)</label>
                            <select id="roster-sort-2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">ì„ íƒ ì•ˆ í•¨</option>
                                <option value="name">ì´ë¦„ìˆœ</option>
                                <option value="hireDate">ì…ì‚¬ì¼ìˆœ</option>
                                <option value="position">ì§ê¸‰ìˆœ</option>
                                <option value="jobTitle">ì§ìœ„ìˆœ</option>
                                <option value="jobRole">ì§ì±…ìˆœ</option>
                                <option value="department">ë¶€ì„œìˆœ</option>
                                <option value="location">ê·¼ë¬´ì§€ìˆœ</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ì •ë ¬ ê¸°ì¤€ 3 (3ì°¨)</label>
                            <select id="roster-sort-3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">ì„ íƒ ì•ˆ í•¨</option>
                                <option value="name">ì´ë¦„ìˆœ</option>
                                <option value="hireDate">ì…ì‚¬ì¼ìˆœ</option>
                                <option value="position">ì§ê¸‰ìˆœ</option>
                                <option value="jobTitle">ì§ìœ„ìˆœ</option>
                                <option value="jobRole">ì§ì±…ìˆœ</option>
                                <option value="department">ë¶€ì„œìˆœ</option>
                                <option value="location">ê·¼ë¬´ì§€ìˆœ</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveRosterSortSetting()" style="width: 100%; padding: 8px;">ì €ì¥</button>
                    </div>
                </div>

                <!-- ê´€ë¦¬ì ê³„ì • ê´€ë¦¬ -->
                <div style="max-width: 600px; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px; color: #1976d2;">ê´€ë¦¬ì ê³„ì • ê´€ë¦¬</h3>
                    
                    <div id="admin-accounts-list">
                        <p style="color: #999;">ê´€ë¦¬ì ê³„ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                        <button class="btn btn-primary" onclick="showAddAdminForm()">+ ê´€ë¦¬ì ì¶”ê°€</button>
                    </div>
                </div>

                <div style="max-width: 600px; background: #fff3cd; padding: 20px; border-radius: 8px; margin-top: 30px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">âš ï¸ ë³´ì•ˆ ì£¼ì˜ì‚¬í•­</h4>
                    <ul style="color: #856404; font-size: 12px; line-height: 1.8;">
                        <li>ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ ê¶Œì¥í•©ë‹ˆë‹¤.</li>
                        <li>ê´€ë¦¬ì ê³„ì •ì€ ì‹ ì¤‘í•˜ê²Œ ê´€ë¦¬í•˜ì„¸ìš”.</li>
                        <li>ì •ê¸°ì ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì„¸ìš”.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCrsPO00nsUH4iwUfHCF1aFKwcuoedqTTs",
            authDomain: "ga-korea-hr.firebaseapp.com",
            projectId: "ga-korea-hr",
            storageBucket: "ga-korea-hr.firebasestorage.app",
            messagingSenderId: "1022770625476",
            appId: "1:1022770625476:web:927f6a18be08feb5518291"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.db = db;
        window.auth = auth;
        window.collection = collection;
        window.getDocs = getDocs;
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.getDoc = getDoc;
        window.serverTimestamp = serverTimestamp;
        
        console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
        console.log('ğŸ”’ Firebase Authentication í™œì„±í™”');

        let currentAuthUser = null;

        // ì¸ì¦ ìƒíƒœ ê°ì§€
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('âœ… ë¡œê·¸ì¸ë¨:', user.email);
                currentAuthUser = user;
                await showMainScreen(user);
            } else {
                console.log('âŒ ë¡œê·¸ì•„ì›ƒ ìƒíƒœ');
                showLoginScreen();
            }
        });

        // ë¡œê·¸ì¸ í¼ ì²˜ë¦¬
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginBtn = document.getElementById('login-btn');
            const errorMsg = document.getElementById('login-error');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
            errorMsg.style.display = 'none';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ');
            } catch (error) {
                console.error('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨:', error.code);
                
                let errorText = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorText = 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                } else if (error.code === 'auth/invalid-email') {
                    errorText = 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorText = 'ë„ˆë¬´ ë§ì€ ì‹œë„ë¥¼ í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
                }
                
                errorMsg.textContent = errorText;
                errorMsg.style.display = 'block';
                
                loginBtn.disabled = false;
                loginBtn.textContent = 'ë¡œê·¸ì¸';
            }
        });

        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-screen').classList.remove('active');
        }

        async function showMainScreen(user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-screen').classList.add('active');
            
            const userName = user.email.split('@')[0];
            document.getElementById('current-user').textContent = userName;
            
            // window ê°ì²´ë¥¼ í†µí•´ í•¨ìˆ˜ í˜¸ì¶œ (ì •ì˜ ìˆœì„œì— ê´€ê³„ì—†ì´ ì•ˆì „í•˜ê²Œ í˜¸ì¶œ)
            if (typeof window.loadCompanyFilters === 'function') {
                await window.loadCompanyFilters();
            }
            if (typeof window.loadEmployees === 'function') {
                await window.loadEmployees();
            }
        }

        window.logout = async function() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await signOut(auth);
                    console.log('âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
                } catch (error) {
                    console.error('âŒ ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                }
            }
        }
        
        // ====== ì´í•˜ ìœ í‹¸ë¦¬í‹° ë° ë°ì´í„° í•¨ìˆ˜ë“¤ ======
        
        function showLoading() { document.getElementById('loading').classList.add('active'); }
        function hideLoading() { document.getElementById('loading').classList.remove('active'); }

        function hashPassword(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                hash = ((hash << 5) - hash) + password.charCodeAt(i);
                hash = hash & hash;
            }
            return hash.toString();
        }

        let session = null;
        let allEmployees = [];

        async function initializeData() {
            try {
                const companiesRef = window.collection(window.db, 'companies');
                const snap = await window.getDocs(companiesRef);
                
                if (snap.empty) {
                    await window.setDoc(window.doc(window.db, 'companies', 'C001'), { code: 'C001', name: 'GA KOREA' });
                    await window.setDoc(window.doc(window.db, 'companies', 'C002'), { code: 'C002', name: 'ãˆœì§€ì—ì´í…Œí¬' });
                    await window.setDoc(window.doc(window.db, 'departments', 'D001'), { code: 'D001', name: 'ê²½ì˜ì§€ì›íŒ€', companyCode: 'C001' });
                    await window.setDoc(window.doc(window.db, 'departments', 'D002'), { code: 'D002', name: 'ì¸ì‚¬íŒ€', companyCode: 'C001' });
                }

                const usersRef = window.collection(window.db, 'users');
                const uSnap = await window.getDocs(usersRef);
                
                if (uSnap.empty) {
                    await window.setDoc(window.doc(window.db, 'users', 'admin'), {
                        username: 'admin',
                        password: hashPassword('admin1234'),
                        name: 'ì‹œìŠ¤í…œê´€ë¦¬ì',
                        role: 'admin',
                        active: true
                    });
                }
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }

        window.addEventListener('DOMContentLoaded', async function() {
            console.log('âœ… í˜ì´ì§€ ë¡œë”© ì‹œì‘');
            showLoading();
            try {
                await initializeData();
                console.log('âœ… ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ');
                // ì´ˆê¸° íƒ­ ë¡œë“œ - ëŒ€ì‹œë³´ë“œë¥¼ ì²« í™”ë©´ìœ¼ë¡œ
                if (typeof window.switchMainTab === 'function') {
                    window.switchMainTab('dashboard');
                }
                console.log('âœ… ì´ˆê¸° íƒ­ ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert('ì´ˆê¸°í™” ì˜¤ë¥˜: ' + error.message);
            }
            hideLoading();
        });

        window.switchMainTab = function(tabName) {
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
            document.getElementById('dashboard-tab').style.display = 'none';
            document.getElementById('employee-info-tab').style.display = 'none';
            document.getElementById('salary-info-tab').style.display = 'none';
            document.getElementById('employee-roster-tab').style.display = 'none';
            document.getElementById('employee-record-tab').style.display = 'none';
            document.getElementById('org-chart-tab').style.display = 'none';
            document.getElementById('company-tab').style.display = 'none';
            document.getElementById('admin-tab').style.display = 'none';
            
            // ì„ íƒëœ íƒ­ í‘œì‹œ ë° ë²„íŠ¼ í™œì„±í™”
            if (tabName === 'dashboard') {
                document.getElementById('dashboard-tab').style.display = 'flex';
                document.getElementById('tab-dashboard').classList.add('active');
                loadDashboard();
            } else if (tabName === 'employee-info') {
                document.getElementById('employee-info-tab').style.display = 'flex';
                document.getElementById('tab-employee').classList.add('active');
                loadEmployees();  // ì§ì› ëª©ë¡ ë¡œë“œ ì¶”ê°€
                loadCompanyFilters();  // ë²•ì¸ í•„í„° ë¡œë“œ ì¶”ê°€
            } else if (tabName === 'salary-info') {
                document.getElementById('salary-info-tab').style.display = 'flex';
                document.getElementById('tab-employee').classList.add('active');
                loadSalaryInfo();
            } else if (tabName === 'employee-roster') {
                document.getElementById('employee-roster-tab').style.display = 'flex';
                document.getElementById('tab-employee-data').classList.add('active');
                window.loadRoster();
            } else if (tabName === 'org-chart') {
                document.getElementById('org-chart-tab').style.display = 'flex';
                document.getElementById('tab-employee-data').classList.add('active');
                loadOrgChart();
            } else if (tabName === 'employee-record') {
                document.getElementById('employee-record-tab').style.display = 'flex';
                document.getElementById('tab-employee-data').classList.add('active');
            } else if (tabName === 'company') {
                document.getElementById('company-tab').style.display = 'flex';
                document.getElementById('tab-company').classList.add('active');
                loadCompanyManagement();
            } else if (tabName === 'admin') {
                document.getElementById('admin-tab').style.display = 'flex';
                document.getElementById('tab-admin').classList.add('active');
                loadAdminManagement();
            }
        }

        window.loadCompanyFilters = async function loadCompanyFilters() {
            const select = document.getElementById('filter-company');
            select.innerHTML = '<option value="">ì „ì²´</option>';
            
            const snapshot = await window.getDocs(window.collection(window.db, 'companies'));
            snapshot.forEach(doc => {
                const c = doc.data();
                select.innerHTML += `<option value="${c.code}">${c.name}</option>`;
            });
        }

        window.loadEmployees = async function loadEmployees() {
            showLoading();
            allEmployees = [];
            const snapshot = await window.getDocs(window.collection(window.db, 'employees'));
            snapshot.forEach(doc => {
                allEmployees.push({ id: doc.id, ...doc.data() });
            });
            filterEmployees();
            hideLoading();
        }

        function filterEmployees() {
            const search = document.getElementById('search-employee').value.toLowerCase();
            const company = document.getElementById('filter-company').value;
            
            let filtered = allEmployees.filter(emp => {
                const matchSearch = !search || (emp.name && emp.name.toLowerCase().includes(search)) || (emp.id && emp.id.includes(search));
                // GA KOREA(C001)ëŠ” í†µí•©ë²•ì¸ìœ¼ë¡œ ëª¨ë“  ì§ì› ì¡°íšŒ
                const matchCompany = !company || company === 'C001' || emp.companyCode === company;
                return matchSearch && matchCompany;
            });
            
            renderEmployeeList(filtered);
        }

        function renderEmployeeList(employees) {
            const list = document.getElementById('employee-list');
            if (employees.length === 0) {
                list.innerHTML = '<div class="empty-state"><p>ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
                return;
            }
            
            list.innerHTML = employees.map(emp => `
                <div class="employee-item" style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" class="employee-checkbox" value="${emp.id}" 
                           onclick="event.stopPropagation()" style="width: 16px; height: 16px; cursor: pointer;">
                    <div style="flex: 1; cursor: pointer;" onclick="selectEmployee('${emp.id}')">
                        <div class="name">${emp.name}</div>
                        <div class="info">${emp.id}</div>
                    </div>
                </div>
            `).join('');
        }

        window.deleteSelectedEmployees = async function() {
            console.log('âœ… deleteSelectedEmployees í˜¸ì¶œë¨');
            const checkboxes = document.querySelectorAll('.employee-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('ì‚­ì œí•  ì§ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const employeeIds = Array.from(checkboxes).map(cb => cb.value);
            const names = employeeIds.map(id => {
                const emp = allEmployees.find(e => e.id === id);
                return emp ? emp.name : id;
            });
            
            // ê°•í™”ëœ ì‚­ì œ í™•ì¸
            const confirmMessage = `ì •ë§ë¡œ ë‹¤ìŒ ${employeeIds.length}ëª…ì˜ ì§ì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${names.join(', ')}\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // ë‘ ë²ˆì§¸ í™•ì¸
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ìµœì¢… í™•ì¸)')) {
                return;
            }
            
            showLoading();
            
            try {
                let successCount = 0;
                let failCount = 0;
                
                for (const id of employeeIds) {
                    try {
                        await window.deleteDoc(window.doc(window.db, 'employees', id));
                        successCount++;
                    } catch (error) {
                        console.error(`ì§ì› ${id} ì‚­ì œ ì‹¤íŒ¨:`, error);
                        failCount++;
                    }
                }
                
                alert(`ì‚­ì œ ì™„ë£Œ!\n\nì„±ê³µ: ${successCount}ëª…\nì‹¤íŒ¨: ${failCount}ëª…`);
                await loadEmployees();
                
                // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ í•´ì œ
                document.getElementById('select-all-checkbox').checked = false;
                
            } catch (error) {
                console.error('ì¼ê´„ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
            
            hideLoading();
        }

        window.toggleSelectAll = function() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const checkboxes = document.querySelectorAll('.employee-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
            });
        }

        window.selectEmployee = function(id) {
            const emp = allEmployees.find(e => e.id === id);
            if (!emp) return;
            
            // ë²•ì¸ëª…, ë¶€ì„œëª… ì¡°íšŒ
            let companyName = emp.companyCode;
            let deptName = emp.departmentCode;
            
            document.getElementById('employee-detail').innerHTML = `
                <div style="max-width: 1200px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2>${emp.name} (${emp.id})</h2>
                        <div class="button-group" style="margin: 0;">
                            <button class="btn btn-primary" onclick="editEmployee('${id}')">ìˆ˜ì •</button>
                            <button class="btn btn-secondary" onclick="deleteEmployee('${id}')">ì‚­ì œ</button>
                        </div>
                    </div>
                    
                    <!-- ì¸ì ì •ë³´ -->
                    <div class="form-title">ì¸ì ì •ë³´</div>
                    <table class="form-table">
                        <tr>
                            <th>ì‚¬ë²ˆ</th>
                            <td>${emp.id || '-'}</td>
                            <th>ì„±ëª…</th>
                            <td>${emp.name || '-'}</td>
                        </tr>
                        <tr>
                            <th>ì˜ë¬¸ëª…</th>
                            <td>${emp.nameEn || '-'}</td>
                            <th>ë‚´ì™¸êµ­ì¸</th>
                            <td>${emp.nationality || '-'}</td>
                        </tr>
                        <tr>
                            <th>ì„±ë³„</th>
                            <td>${emp.gender || '-'}</td>
                            <th>ìƒë…„ì›”ì¼</th>
                            <td>${emp.birthDate || '-'}</td>
                        </tr>
                        <tr>
                            <th>ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</th>
                            <td>${emp.residentNumber || '-'}</td>
                            <th>íœ´ëŒ€ì „í™”</th>
                            <td>${emp.mobile || '-'}</td>
                        </tr>
                        <tr>
                            <th>ì „í™”ë²ˆí˜¸</th>
                            <td>${emp.phone || '-'}</td>
                            <th>ì£¼ì†Œ</th>
                            <td>${emp.address || '-'}</td>
                        </tr>
                        <tr>
                            <th>ì´ë©”ì¼(íšŒì‚¬)</th>
                            <td>${emp.companyEmail || '-'}</td>
                            <th>ì´ë©”ì¼(ê°œì¸)</th>
                            <td>${emp.personalEmail || '-'}</td>
                        </tr>
                    </table>
                    
                    <!-- ì€í–‰ì •ë³´ -->
                    <div class="form-title">ì€í–‰ì •ë³´</div>
                    <table class="form-table">
                        <tr>
                            <th>ì€í–‰ëª…</th>
                            <td>${emp.bankName || '-'}</td>
                            <th>ê³„ì¢Œë²ˆí˜¸</th>
                            <td>${emp.accountNumber || '-'}</td>
                        </tr>
                        <tr>
                            <th>ì˜ˆê¸ˆì£¼</th>
                            <td colspan="3">${emp.accountHolder || '-'}</td>
                        </tr>
                    </table>
                    
                    <!-- í•™ë ¥ì •ë³´ -->
                    <div class="form-title">í•™ë ¥ì •ë³´</div>
                    <table class="form-table">
                        <tr>
                            <th>ìµœì¢…í•™ë ¥</th>
                            <td>${emp.education || '-'}</td>
                            <th>í•™êµëª…</th>
                            <td>${emp.schoolName || '-'}</td>
                        </tr>
                        <tr>
                            <th>ì „ê³µ</th>
                            <td>${emp.major || '-'}</td>
                            <th>ì¡¸ì—…ì¼</th>
                            <td>${emp.graduationDate || '-'}</td>
                        </tr>
                    </table>
                    
                    <!-- ê°€ì¡±ì‚¬í•­ -->
                    <div class="form-title">ê°€ì¡±ì‚¬í•­</div>
                    <table class="form-table">
                        <tr>
                            <th>ê²°í˜¼ì—¬ë¶€</th>
                            <td>${emp.maritalStatus || '-'}</td>
                            <th>ìë…€ìˆ˜</th>
                            <td>${emp.numberOfChildren || '-'}</td>
                        </tr>
                        <tr>
                            <th>ë¹„ìƒì—°ë½ì²˜</th>
                            <td>${emp.emergencyContact || '-'}</td>
                            <th>ë¹„ìƒì—°ë½ì²˜ ê´€ê³„</th>
                            <td>${emp.emergencyRelation || '-'}</td>
                        </tr>
                    </table>
                    
                    <!-- ì¬ì§ì •ë³´ -->
                    <div class="form-title">ì¬ì§ì •ë³´</div>
                    <table class="form-table">
                        <tr>
                            <th>ì…ì‚¬ì¼</th>
                            <td>${emp.hireDate || '-'}</td>
                            <th>ê·¸ë£¹ì…ì‚¬ì¼</th>
                            <td>${emp.groupHireDate || '-'}</td>
                        </tr>
                        <tr>
                            <th>í‡´ì‚¬ì¼</th>
                            <td>${emp.resignDate || '-'}</td>
                            <th>ì¬ì§ìƒíƒœ</th>
                            <td>${emp.workStatus || '-'}</td>
                        </tr>
                        <tr>
                            <th>ë²•ì¸</th>
                            <td>${companyName}</td>
                            <th>ê·¼ë¬´ì§€</th>
                            <td>${emp.workLocation || '-'}</td>
                        </tr>
                        <tr>
                            <th>ë¶€ì„œ</th>
                            <td>${deptName}</td>
                            <th>ê³ ìš©í˜•íƒœ</th>
                            <td>${emp.employmentType || '-'}</td>
                        </tr>
                        <tr>
                            <th>ì§ê¸‰</th>
                            <td>${emp.position || '-'}</td>
                            <th>ì§ìœ„</th>
                            <td>${emp.jobTitle || '-'}</td>
                        </tr>
                        <tr>
                            <th>ì§ë¬´</th>
                            <td>${emp.jobRole || '-'}</td>
                            <th>ê·¼ë¬´í˜•íƒœ</th>
                            <td>${emp.workType || '-'}</td>
                        </tr>
                    </table>
                    
                    <!-- ê¸‰ì—¬ì •ë³´ -->
                    <div class="form-title">ê¸‰ì—¬ì •ë³´</div>
                    <table class="form-table">
                        <tr>
                            <th>ê¸‰ì—¬ë“±ê¸‰</th>
                            <td>${emp.salaryGrade || '-'}</td>
                            <th>ê¸°ë³¸ê¸‰</th>
                            <td>${emp.baseSalary ? Number(emp.baseSalary).toLocaleString() + 'ì›' : '-'}</td>
                        </tr>
                        <tr>
                            <th>ì—°ë´‰</th>
                            <td colspan="3">${emp.annualSalary ? Number(emp.annualSalary).toLocaleString() + 'ì›' : '-'}</td>
                        </tr>
                    </table>
                    
                    <!-- 4ëŒ€ë³´í—˜ -->
                    <div class="form-title">4ëŒ€ë³´í—˜</div>
                    <table class="form-table">
                        <tr>
                            <th>êµ­ë¯¼ì—°ê¸ˆ</th>
                            <td>${emp.nationalPension ? 'O' : 'X'}</td>
                            <th>ê±´ê°•ë³´í—˜</th>
                            <td>${emp.healthInsurance ? 'O' : 'X'}</td>
                        </tr>
                        <tr>
                            <th>ê³ ìš©ë³´í—˜</th>
                            <td>${emp.employmentInsurance ? 'O' : 'X'}</td>
                            <th>ì‚°ì¬ë³´í—˜</th>
                            <td>${emp.industrialAccident ? 'O' : 'X'}</td>
                        </tr>
                    </table>
                    
                    <!-- ë¹„ê³  -->
                    <div class="form-title">ë¹„ê³ </div>
                    <table class="form-table">
                        <tr>
                            <td colspan="4">${emp.notes || '-'}</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        async function deleteEmployee(id) {
            const emp = allEmployees.find(e => e.id === id);
            const empName = emp ? emp.name : id;
            
            // ê°•í™”ëœ ì‚­ì œ í™•ì¸
            if (!confirm(`ì •ë§ë¡œ "${empName}" ì§ì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) return;
            
            // ë‘ ë²ˆì§¸ í™•ì¸
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ìµœì¢… í™•ì¸)')) return;
            
            showLoading();
            await window.deleteDoc(window.doc(window.db, 'employees', id));
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            await loadEmployees();
            document.getElementById('employee-detail').innerHTML = `
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-outline" onclick="downloadExcelTemplate()">ğŸ“¥ ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn btn-primary" onclick="document.getElementById('excel-upload').click()">ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ</button>
                    <input type="file" id="excel-upload" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelUpload(event)">
                </div>
                <div class="empty-state"><h3>ì§ì›ì„ ì„ íƒí•˜ê±°ë‚˜ ì‹ ê·œ ë“±ë¡í•˜ì„¸ìš”</h3></div>
            `;
            hideLoading();
        }

        function editEmployee(id) {
            const emp = allEmployees.find(e => e.id === id);
            showEmployeeForm(emp);
        }

        window.showNewEmployeeForm = function() {
            console.log('âœ… showNewEmployeeForm í˜¸ì¶œë¨');
            showEmployeeForm();
        }

        function generateId() {
            return new Date().getFullYear().toString().slice(2) + 
                   (new Date().getMonth() + 1).toString().padStart(2, '0') + 
                   Math.floor(Math.random() * 9000 + 1000);
        }

        async function showEmployeeForm(emp = null) {
            const companies = [];
            const depts = [];
            
            const cSnap = await window.getDocs(window.collection(window.db, 'companies'));
            cSnap.forEach(doc => companies.push(doc.data()));
            
            const dSnap = await window.getDocs(window.collection(window.db, 'departments'));
            dSnap.forEach(doc => depts.push(doc.data()));
            
            // ì„¤ì •ê°’ ë¡œë“œ
            const settingsDoc = await window.getDoc(window.doc(window.db, 'settings', 'master'));
            const settings = settingsDoc.exists() ? settingsDoc.data() : {
                positions: [],
                jobTitles: [],
                jobRoles: [],
                locations: [],
                employmentTypes: []
            };
            
            document.getElementById('employee-detail').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>${emp ? 'ì§ì› ì •ë³´ ìˆ˜ì •' : 'ì‹ ê·œ ì§ì› ë“±ë¡'}</h2>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn btn-outline" onclick="downloadExcelTemplate()">ğŸ“¥ ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('excel-upload').click()">ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ</button>
                    </div>
                </div>
                <form id="emp-form" onsubmit="saveEmployee(event)">
                    <div class="detail-tabs">
                        <button type="button" class="detail-tab active" onclick="switchTab(event, 'personal')">ì¸ì ì •ë³´</button>
                        <button type="button" class="detail-tab" onclick="switchTab(event, 'employment')">ì¬ì§ì •ë³´</button>
                        <button type="button" class="detail-tab" onclick="switchTab(event, 'salary')">ê¸‰ì—¬ì •ë³´</button>
                        <button type="button" class="detail-tab" onclick="switchTab(event, 'attendance')">ê·¼íƒœì •ë³´</button>
                    </div>
                    
                    <div id="tab-personal" class="detail-content active">
                        <div class="form-title">ê¸°ë³¸ì •ë³´</div>
                        <table class="form-table">
                            <tr>
                                <th class="required">ì‚¬ë²ˆ</th>
                                <td><input name="employeeId" value="${emp?.id || generateId()}" ${emp ? 'readonly' : ''} required></td>
                                <th>ì˜ë¬¸ ì‚¬ë²ˆ</th>
                                <td><input name="employeeIdEn" value="${emp?.employeeIdEn || ''}"></td>
                            </tr>
                            <tr>
                                <th class="required">ì„±ëª…</th>
                                <td><input name="name" value="${emp?.name || ''}" required></td>
                                <th>ì˜ë¬¸ëª…</th>
                                <td><input name="nameEn" value="${emp?.nameEn || ''}"></td>
                            </tr>
                            <tr>
                                <th class="required">ë‚´/ì™¸êµ­ì¸</th>
                                <td>
                                    <div class="radio-group">
                                        <label><input type="radio" name="nationality" value="ë‚´êµ­ì¸" ${!emp || emp.nationality === 'ë‚´êµ­ì¸' ? 'checked' : ''}> ë‚´êµ­ì¸</label>
                                        <label><input type="radio" name="nationality" value="ì™¸êµ­ì¸" ${emp?.nationality === 'ì™¸êµ­ì¸' ? 'checked' : ''}> ì™¸êµ­ì¸</label>
                                    </div>
                                </td>
                                <th class="required">ì„±ë³„</th>
                                <td>
                                    <select name="gender" required>
                                        <option value="ë‚¨ì„±" ${!emp || emp.gender === 'ë‚¨ì„±' ? 'selected' : ''}>ë‚¨ì„±</option>
                                        <option value="ì—¬ì„±" ${emp?.gender === 'ì—¬ì„±' ? 'selected' : ''}>ì—¬ì„±</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th class="required">ìƒë…„ì›”ì¼</th>
                                <td><input type="date" name="birthDate" value="${emp?.birthDate || ''}" required></td>
                                <th>ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</th>
                                <td><input name="residentNumber" value="${emp?.residentNumber || ''}" placeholder="000000-0000000"></td>
                            </tr>
                            <tr>
                                <th class="required">íœ´ëŒ€ì „í™”</th>
                                <td><input name="mobile" value="${emp?.mobile || ''}" placeholder="010-0000-0000" required></td>
                                <th>ì „í™”ë²ˆí˜¸</th>
                                <td><input name="phone" value="${emp?.phone || ''}" placeholder="02-0000-0000"></td>
                            </tr>
                            <tr>
                                <th>ì£¼ì†Œ</th>
                                <td colspan="3"><input name="address" value="${emp?.address || ''}"></td>
                            </tr>
                            <tr>
                                <th>ì´ë©”ì¼(íšŒì‚¬)</th>
                                <td><input type="email" name="companyEmail" value="${emp?.companyEmail || ''}"></td>
                                <th>ì´ë©”ì¼(ê°œì¸)</th>
                                <td><input type="email" name="personalEmail" value="${emp?.personalEmail || ''}"></td>
                            </tr>
                        </table>
                        
                        <div class="form-title">ì€í–‰ì •ë³´</div>
                        <table class="form-table">
                            <tr>
                                <th>ì€í–‰ëª…</th>
                                <td><input name="bankName" value="${emp?.bankName || ''}"></td>
                                <th>ê³„ì¢Œë²ˆí˜¸</th>
                                <td><input name="accountNumber" value="${emp?.accountNumber || ''}"></td>
                            </tr>
                            <tr>
                                <th>ì˜ˆê¸ˆì£¼</th>
                                <td colspan="3"><input name="accountHolder" value="${emp?.accountHolder || ''}"></td>
                            </tr>
                        </table>
                        
                        <div class="form-title">í•™ë ¥ì •ë³´</div>
                        <table class="form-table">
                            <tr>
                                <th>ìµœì¢…í•™ë ¥</th>
                                <td>
                                    <select name="education">
                                        <option value="">ì„ íƒ</option>
                                        <option value="ê³ ì¡¸" ${emp?.education === 'ê³ ì¡¸' ? 'selected' : ''}>ê³ ì¡¸</option>
                                        <option value="ì „ë¬¸ëŒ€ì¡¸" ${emp?.education === 'ì „ë¬¸ëŒ€ì¡¸' ? 'selected' : ''}>ì „ë¬¸ëŒ€ì¡¸</option>
                                        <option value="ëŒ€ì¡¸" ${emp?.education === 'ëŒ€ì¡¸' ? 'selected' : ''}>ëŒ€ì¡¸</option>
                                        <option value="ëŒ€í•™ì›ì¡¸" ${emp?.education === 'ëŒ€í•™ì›ì¡¸' ? 'selected' : ''}>ëŒ€í•™ì›ì¡¸</option>
                                    </select>
                                </td>
                                <th>í•™êµëª…</th>
                                <td><input name="schoolName" value="${emp?.schoolName || ''}"></td>
                            </tr>
                            <tr>
                                <th>ì „ê³µ</th>
                                <td><input name="major" value="${emp?.major || ''}"></td>
                                <th>ì¡¸ì—…ì¼</th>
                                <td><input type="date" name="graduationDate" value="${emp?.graduationDate || ''}"></td>
                            </tr>
                        </table>
                        
                        <div class="form-title">ê°€ì¡±ì‚¬í•­</div>
                        <table class="form-table">
                            <tr>
                                <th>ê²°í˜¼ì—¬ë¶€</th>
                                <td>
                                    <div class="radio-group">
                                        <label><input type="radio" name="maritalStatus" value="ë¯¸í˜¼" ${!emp || emp.maritalStatus === 'ë¯¸í˜¼' ? 'checked' : ''}> ë¯¸í˜¼</label>
                                        <label><input type="radio" name="maritalStatus" value="ê¸°í˜¼" ${emp?.maritalStatus === 'ê¸°í˜¼' ? 'checked' : ''}> ê¸°í˜¼</label>
                                    </div>
                                </td>
                                <th>ìë…€ìˆ˜</th>
                                <td><input type="number" name="numberOfChildren" value="${emp?.numberOfChildren || '0'}"></td>
                            </tr>
                            <tr>
                                <th>ë¹„ìƒì—°ë½ì²˜</th>
                                <td><input name="emergencyContact" value="${emp?.emergencyContact || ''}"></td>
                                <th>ë¹„ìƒì—°ë½ì²˜ ê´€ê³„</th>
                                <td><input name="emergencyRelation" value="${emp?.emergencyRelation || ''}"></td>
                            </tr>
                        </table>
                    </div>
                    
                    <div id="tab-employment" class="detail-content">
                        <div class="form-title">ì¬ì§ì •ë³´</div>
                        <table class="form-table">
                            <tr>
                                <th class="required">ì…ì‚¬ì¼</th>
                                <td><input type="date" name="hireDate" value="${emp?.hireDate || ''}" required></td>
                                <th>ê·¸ë£¹ì…ì‚¬ì¼</th>
                                <td><input type="date" name="groupHireDate" value="${emp?.groupHireDate || ''}"></td>
                            </tr>
                            <tr>
                                <th>í‡´ì‚¬ì¼</th>
                                <td><input type="date" name="resignDate" value="${emp?.resignDate || ''}"></td>
                                <th class="required">ì¬ì§ìƒíƒœ</th>
                                <td>
                                    <select name="workStatus" required>
                                        <option value="ì¬ì§" ${!emp || emp.workStatus === 'ì¬ì§' ? 'selected' : ''}>ì¬ì§</option>
                                        <option value="íœ´ì§" ${emp?.workStatus === 'íœ´ì§' ? 'selected' : ''}>íœ´ì§</option>
                                        <option value="í‡´ì§" ${emp?.workStatus === 'í‡´ì§' ? 'selected' : ''}>í‡´ì§</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th class="required">ë²•ì¸</th>
                                <td>
                                    <select name="companyCode" required>
                                        <option value="">ì„ íƒ</option>
                                        ${companies.map(c => `<option value="${c.code}" ${emp?.companyCode === c.code ? 'selected' : ''}>${c.name}</option>`).join('')}
                                    </select>
                                </td>
                                <th class="required">ê·¼ë¬´ì§€</th>
                                <td>
                                    <select name="workLocation" id="workLocation" onchange="filterDepartmentsByLocation()" required>
                                        <option value="">ì„ íƒ</option>
                                        ${[...new Set(depts.map(d => d.location).filter(l => l))].map(loc => `<option value="${loc}" ${emp?.workLocation === loc ? 'selected' : ''}>${loc}</option>`).join('')}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th class="required">ë¶€ì„œ</th>
                                <td colspan="3">
                                    <select name="departmentCode" id="departmentCode" required>
                                        <option value="">ê·¼ë¬´ì§€ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                                        ${depts.map(d => `<option value="${d.code}" data-location="${d.location}" ${emp?.departmentCode === d.code ? 'selected' : ''}>${d.name}</option>`).join('')}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th class="required">ê³ ìš©í˜•íƒœ</th>
                                <td>
                                    <select name="employmentType" required>
                                        <option value="">ì„ íƒ</option>
                                        ${(settings.employmentTypes || []).map(type => `<option value="${type}" ${emp?.employmentType === type ? 'selected' : ''}>${type}</option>`).join('')}
                                    </select>
                                </td>
                                <th class="required">ì§ê¸‰</th>
                                <td>
                                    <select name="position" required>
                                        <option value="">ì„ íƒ</option>
                                        ${(settings.positions || []).map(pos => `<option value="${pos}" ${emp?.position === pos ? 'selected' : ''}>${pos}</option>`).join('')}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th>ì§ìœ„</th>
                                <td>
                                    <select name="jobTitle">
                                        <option value="">ì„ íƒ</option>
                                        ${(settings.jobTitles || []).map(jt => `<option value="${jt}" ${emp?.jobTitle === jt ? 'selected' : ''}>${jt}</option>`).join('')}
                                    </select>
                                </td>
                                <th>ì§ì±…</th>
                                <td>
                                    <select name="jobRole">
                                        <option value="">ì„ íƒ</option>
                                        ${(settings.jobRoles || []).map(jr => `<option value="${jr}" ${emp?.jobRole === jr ? 'selected' : ''}>${jr}</option>`).join('')}
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th>ì§ë¬´</th>
                                <td colspan="3"><input name="duty" value="${emp?.duty || ''}"></td>
                            </tr>
                            <tr>
                                <th>ê·¼ë¬´í˜•íƒœ</th>
                                <td colspan="3"><input name="workType" value="${emp?.workType || ''}"></td>
                            </tr>
                        </table>
                    </div>
                    
                    <div id="tab-salary" class="detail-content">
                        <div class="form-title">ê¸‰ì—¬ì •ë³´</div>
                        <table class="form-table">
                            <tr>
                                <th>ê¸‰ì—¬ë“±ê¸‰</th>
                                <td><input name="salaryGrade" value="${emp?.salaryGrade || ''}"></td>
                                <th>ê¸‰ì—¬ë“±ê¸‰ì¼</th>
                                <td><input type="date" name="salaryGradeDate" value="${emp?.salaryGradeDate || ''}"></td>
                            </tr>
                            <tr>
                                <th>ê¸°ë³¸ê¸‰</th>
                                <td><input type="number" name="baseSalary" value="${emp?.baseSalary || ''}"></td>
                                <th>ì—°ë´‰</th>
                                <td><input type="number" name="annualSalary" value="${emp?.annualSalary || ''}"></td>
                            </tr>
                        </table>
                        
                        <div class="form-title">4ëŒ€ë³´í—˜</div>
                        <table class="form-table">
                            <tr>
                                <td colspan="4">
                                    <label><input type="checkbox" name="nationalPension" ${emp?.nationalPension ? 'checked' : ''}> êµ­ë¯¼ì—°ê¸ˆ</label>
                                    <label><input type="checkbox" name="healthInsurance" ${emp?.healthInsurance ? 'checked' : ''}> ê±´ê°•ë³´í—˜</label>
                                    <label><input type="checkbox" name="employmentInsurance" ${emp?.employmentInsurance ? 'checked' : ''}> ê³ ìš©ë³´í—˜</label>
                                    <label><input type="checkbox" name="industrialAccident" ${emp?.industrialAccident ? 'checked' : ''}> ì‚°ì¬ë³´í—˜</label>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <div id="tab-attendance" class="detail-content">
                        <div class="form-title">ê¸°íƒ€ì •ë³´</div>
                        <table class="form-table">
                            <tr>
                                <th>ë…¸ì¡°ê°€ì…</th>
                                <td><input type="checkbox" name="unionMember" ${emp?.unionMember ? 'checked' : ''}></td>
                                <th>ìš°í¸ì£¼ì†Œ</th>
                                <td><input name="mailAddress" value="${emp?.mailAddress || ''}"></td>
                            </tr>
                            <tr>
                                <th>ì¥ì• ì—¬ë¶€</th>
                                <td><input type="checkbox" name="disability" ${emp?.disability ? 'checked' : ''}></td>
                                <th>ë³´í›ˆëŒ€ìƒ</th>
                                <td><input type="checkbox" name="veteran" ${emp?.veteran ? 'checked' : ''}></td>
                            </tr>
                            <tr>
                                <th>ë¹„ê³ </th>
                                <td colspan="3"><textarea name="notes">${emp?.notes || ''}</textarea></td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">ğŸ’¾ ì €ì¥</button>
                        <button type="button" class="btn btn-outline" onclick="cancelForm()">ì·¨ì†Œ</button>
                    </div>
                </form>
            `;
        }

        window.switchTab = function(e, tab) {
            document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.detail-content').forEach(c => c.classList.remove('active'));
            e.target.classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
        }

        window.filterDepartmentsByLocation = function() {
            const locationSelect = document.getElementById('workLocation');
            const deptSelect = document.getElementById('departmentCode');
            const selectedLocation = locationSelect.value;
            
            if (!selectedLocation) {
                deptSelect.innerHTML = '<option value="">ê·¼ë¬´ì§€ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>';
                return;
            }
            
            const allOptions = Array.from(deptSelect.options);
            deptSelect.innerHTML = '<option value="">ì„ íƒ</option>';
            
            allOptions.forEach(option => {
                if (option.dataset.location === selectedLocation) {
                    deptSelect.appendChild(option);
                }
            });
        }

        window.saveEmployee = async function(e) {
            e.preventDefault();
            showLoading();
            
            try {
                const formData = new FormData(e.target);
                const data = {};
                
                for (let [k, v] of formData.entries()) {
                    if (e.target.elements[k].type === 'checkbox') {
                        data[k] = e.target.elements[k].checked;
                    } else {
                        data[k] = v;
                    }
                }
                
                // ë¼ë””ì˜¤ ë²„íŠ¼ ì²˜ë¦¬
                const radios = e.target.querySelectorAll('input[type="radio"]:checked');
                radios.forEach(radio => {
                    data[radio.name] = radio.value;
                });
                
                console.log('ì €ì¥ ë°ì´í„°:', data);
                
                // employeeIdë¥¼ ë¬¸ì„œ IDë¡œ ì‚¬ìš©
                const docId = data.employeeId || generateId();
                await window.setDoc(window.doc(window.db, 'employees', docId), data);
                
                alert('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                await loadEmployees();
                selectEmployee(docId);
                
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                alert('âŒ ì €ì¥ ì˜¤ë¥˜: ' + error.message);
            }
            
            hideLoading();
        }

        window.cancelForm = function() {
            document.getElementById('employee-detail').innerHTML = `
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-outline" onclick="downloadExcelTemplate()">ğŸ“¥ ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="btn btn-primary" onclick="document.getElementById('excel-upload').click()">ğŸ“¤ ì—‘ì…€ ì—…ë¡œë“œ</button>
                    <input type="file" id="excel-upload" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelUpload(event)">
                </div>
                <div class="empty-state"><h3>ì§ì›ì„ ì„ íƒí•˜ê±°ë‚˜ ì‹ ê·œ ë“±ë¡í•˜ì„¸ìš”</h3></div>
            `;
        }

        // ===== ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ì–‘ì‹) =====
        window.downloadExcelTemplate = function() {
            console.log('âœ… downloadExcelTemplate í˜¸ì¶œë¨');
            const template = [
                {
                    'ê·¼ë¬´ì§€': 'ë³¸ì‚¬',
                    'ë¶€ì„œ': 'ì¸ì‚¬íŒ€',
                    'ì„±ëª…': 'í™ê¸¸ë™',
                    'ì§ìœ„': 'íŒ€ì›',
                    'ì§ê¸‰': 'ëŒ€ë¦¬',
                    'ì§ë¬´': 'ì¸ì‚¬ê´€ë¦¬',
                    'ì†Œì†ë²•ì¸(ê¸‰ì—¬ê¸°ì¤€)': 'GA KOREA',
                    'ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸': '900101-1234567',
                    'ê³„ì•½ê¸°ê°„': '2020-01-01 ~ 2025-12-31',
                    'ìƒë…„ì›”ì¼': '1990-01-01',
                    'ë‚˜ì´(ë§Œ)': '34',
                    'ì •ë…„ë„ë˜': '2055-01-01',
                    'ì„±ë³„': 'ë‚¨ì„±',
                    'ì—°ë´‰': '40000000',
                    'ìµœì´ˆì…ì‚¬ì¼': '2020-01-01',
                    'ê·¼ì†ê¸°ê°„': '4ë…„ 0ê°œì›”',
                    'ìµœì¢…ìŠ¹ì§„ì¼': '2022-01-01',
                    'ë¹„ê³ ': '',
                    'ìƒë²Œ': '',
                    'í˜„ì§ìœ„ì²´ë¥˜ê¸°ê°„': '2ë…„',
                    'ìµœì¢…í•™ë ¥': 'ëŒ€ì¡¸',
                    'ì—°ë½ì²˜': '010-1234-5678',
                    'ì´ë©”ì¼': 'hong@gakorea.com',
                    'ê¸‰ì—¬ê³„ì¢Œ': 'ì‹ í•œì€í–‰ 110-123-456789',
                    'ì§‘ì£¼ì†Œ': 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬'
                }
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(template);
            
            // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = [
                {wch: 12}, {wch: 15}, {wch: 10}, {wch: 10}, {wch: 10},
                {wch: 12}, {wch: 20}, {wch: 18}, {wch: 25}, {wch: 12},
                {wch: 10}, {wch: 12}, {wch: 8}, {wch: 12}, {wch: 12},
                {wch: 15}, {wch: 12}, {wch: 20}, {wch: 15}, {wch: 15},
                {wch: 12}, {wch: 15}, {wch: 25}, {wch: 30}, {wch: 30}
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'ì¸ì‚¬ì •ë³´');
            XLSX.writeFile(wb, 'GA_KOREA_ì¸ì‚¬ì •ë³´_ì–‘ì‹.xlsx');
        }

        // ===== ì—‘ì…€ ì—…ë¡œë“œ =====
        
        // ì—‘ì…€ ë‚ ì§œ ë³€í™˜ í•¨ìˆ˜ (5ìë¦¬ ìˆ«ì â†’ YYYY-MM-DD)
        function excelDateToJSDate(excelDate) {
            if (!excelDate) return '';
            
            // ì´ë¯¸ ë‚ ì§œ í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
            if (typeof excelDate === 'string' && excelDate.includes('-')) {
                return excelDate;
            }
            
            // ìˆ«ìì¸ ê²½ìš° (ì—‘ì…€ ë‚ ì§œ ì‹œë¦¬ì–¼)
            if (typeof excelDate === 'number') {
                // ì—‘ì…€ ë‚ ì§œëŠ” 1900ë…„ 1ì›” 1ì¼ì„ ê¸°ì¤€ìœ¼ë¡œ í•œ ì¼ìˆ˜
                const date = new Date((excelDate - 25569) * 86400 * 1000);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            return String(excelDate);
        }
        
        // ì‚¬ë²ˆ ìë™ ìƒì„± í•¨ìˆ˜
        function generateEmployeeId() {
            const year = new Date().getFullYear().toString().slice(2);
            const month = String(new Date().getMonth() + 1).padStart(2, '0');
            const random = String(Math.floor(Math.random() * 10000)).padStart(4, '0');
            return year + month + random;
        }
        
        window.handleExcelUpload = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading();

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                console.log('ì—‘ì…€ ë°ì´í„°:', jsonData);

                if (jsonData.length === 0) {
                    alert('ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    hideLoading();
                    return;
                }

                // ë²•ì¸, ë¶€ì„œ ë§¤í•‘ ë°ì´í„° ë¡œë“œ
                const companiesSnap = await window.getDocs(window.collection(window.db, 'companies'));
                const companyMap = {};
                const companyNameToCode = {};
                companiesSnap.forEach(doc => {
                    const c = doc.data();
                    companyMap[c.code] = c.name;
                    companyNameToCode[c.name] = c.code;
                });

                const deptsSnap = await window.getDocs(window.collection(window.db, 'departments'));
                const deptMap = {};
                deptsSnap.forEach(doc => {
                    const d = doc.data();
                    deptMap[d.name] = d.code;
                });

                // ì‹ ê·œ ë²•ì¸ ìë™ ìƒì„±
                const newCompanies = new Set();
                for (const row of jsonData) {
                    const companyName = row['ì†Œì†ë²•ì¸(ê¸‰ì—¬ê¸°ì¤€)'] || row['ì†Œì†ë²•ì¸'] || row['ë²•ì¸'];
                    if (companyName && !companyNameToCode[companyName]) {
                        newCompanies.add(companyName);
                    }
                }

                if (newCompanies.size > 0) {
                    const createCompanies = confirm(
                        `ë‹¤ìŒ ë²•ì¸ì´ ì‹œìŠ¤í…œì— ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\nìë™ìœ¼ë¡œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${Array.from(newCompanies).join(', ')}`
                    );
                    
                    if (createCompanies) {
                        for (const companyName of newCompanies) {
                            const newCode = 'C' + String(Math.floor(Math.random() * 900 + 100)).padStart(3, '0');
                            await window.setDoc(window.doc(window.db, 'companies', newCode), {
                                code: newCode,
                                name: companyName,
                                businessNumber: '',
                                ceo: ''
                            });
                            companyNameToCode[companyName] = newCode;
                            console.log(`ë²•ì¸ ìƒì„±: ${companyName} (${newCode})`);
                        }
                    } else {
                        hideLoading();
                        return;
                    }
                }

                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                for (let i = 0; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    
                    try {
                        // í•„ìˆ˜ í•„ë“œ ê²€ì¦ (ì„±ëª…ë§Œ í•„ìˆ˜)
                        if (!row['ì„±ëª…']) {
                            errors.push(`${i+2}í–‰: í•„ìˆ˜ í•­ëª© ëˆ„ë½ (ì„±ëª…)`);
                            errorCount++;
                            continue;
                        }

                        // ì‚¬ë²ˆ ìƒì„± (ì—†ìœ¼ë©´ ìë™ ìƒì„±)
                        let employeeId = row['ì‚¬ë²ˆ'] || generateEmployeeId();
                        
                        // ë²•ì¸ ì½”ë“œ ì°¾ê¸°
                        const companyCode = companyNameToCode[row['ì†Œì†ë²•ì¸(ê¸‰ì—¬ê¸°ì¤€)'] || row['ì†Œì†ë²•ì¸']] || 'C001';
                        
                        // ë¶€ì„œ ì½”ë“œ ì°¾ê¸°
                        const departmentCode = deptMap[row['ë¶€ì„œ']] || '';

                        // ê¸‰ì—¬ê³„ì¢Œ ë¶„ë¦¬ (ì€í–‰ëª… + ê³„ì¢Œë²ˆí˜¸)
                        let bankName = '';
                        let accountNumber = '';
                        if (row['ê¸‰ì—¬ê³„ì¢Œ']) {
                            const accountParts = String(row['ê¸‰ì—¬ê³„ì¢Œ']).split(' ');
                            if (accountParts.length >= 2) {
                                bankName = accountParts[0];
                                accountNumber = accountParts.slice(1).join(' ');
                            } else {
                                accountNumber = row['ê¸‰ì—¬ê³„ì¢Œ'];
                            }
                        }

                        // ë°ì´í„° ë§¤í•‘ (ì¸ì‚¬ì •ë³´ ì–‘ì‹ì— ë§ì¶¤)
                        const employeeData = {
                            employeeId: String(employeeId).trim(),
                            name: row['ì„±ëª…'] || '',
                            nameEn: row['ì˜ë¬¸ëª…'] || '',
                            nationality: row['ë‚´ì™¸êµ­ì¸'] || 'ë‚´êµ­ì¸',
                            gender: row['ì„±ë³„'] || '',
                            birthDate: excelDateToJSDate(row['ìƒë…„ì›”ì¼']),
                            residentNumber: row['ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸'] || '',
                            mobile: row['ì—°ë½ì²˜'] || row['íœ´ëŒ€ì „í™”'] || '',
                            phone: row['ì „í™”ë²ˆí˜¸'] || '',
                            address: row['ì§‘ì£¼ì†Œ'] || row['ì£¼ì†Œ'] || '',
                            companyEmail: row['ì´ë©”ì¼'] || row['ì´ë©”ì¼(íšŒì‚¬)'] || '',
                            personalEmail: row['ì´ë©”ì¼(ê°œì¸)'] || '',
                            bankName: bankName,
                            accountNumber: accountNumber,
                            accountHolder: row['ì˜ˆê¸ˆì£¼'] || row['ì„±ëª…'] || '',
                            education: row['ìµœì¢…í•™ë ¥'] || '',
                            schoolName: row['í•™êµëª…'] || '',
                            major: row['ì „ê³µ'] || '',
                            graduationDate: excelDateToJSDate(row['ì¡¸ì—…ì¼']),
                            maritalStatus: row['ê²°í˜¼ì—¬ë¶€'] || 'ë¯¸í˜¼',
                            numberOfChildren: String(row['ìë…€ìˆ˜'] || '0'),
                            emergencyContact: row['ë¹„ìƒì—°ë½ì²˜'] || '',
                            emergencyRelation: row['ë¹„ìƒì—°ë½ì²˜ê´€ê³„'] || '',
                            hireDate: excelDateToJSDate(row['ìµœì´ˆì…ì‚¬ì¼'] || row['ì…ì‚¬ì¼']),
                            groupHireDate: excelDateToJSDate(row['ê·¸ë£¹ì…ì‚¬ì¼']),
                            resignDate: excelDateToJSDate(row['í‡´ì‚¬ì¼']),
                            workStatus: row['ì¬ì§ìƒíƒœ'] || 'ì¬ì§',
                            companyCode: companyCode,
                            workLocation: row['ê·¼ë¬´ì§€'] || '',
                            departmentCode: departmentCode,
                            employmentType: row['ê³ ìš©í˜•íƒœ'] || '',
                            position: row['ì§ê¸‰'] || '',
                            jobTitle: row['ì§ìœ„'] || row['ì§ì±…'] || '',
                            jobRole: row['ì§ë¬´'] || '',
                            workType: row['ê·¼ë¬´í˜•íƒœ'] || '',
                            salaryGrade: row['ê¸‰ì—¬ë“±ê¸‰'] || '',
                            baseSalary: String(row['ê¸°ë³¸ê¸‰'] || ''),
                            annualSalary: String(row['ì—°ë´‰'] || '').replace(/,/g, ''),
                            contractPeriod: row['ê³„ì•½ê¸°ê°„'] || '',
                            promotionDate: excelDateToJSDate(row['ìµœì¢…ìŠ¹ì§„ì¼']),
                            rewards: row['ìƒë²Œ'] || '',
                            nationalPension: (row['êµ­ë¯¼ì—°ê¸ˆ'] === 'O' || row['êµ­ë¯¼ì—°ê¸ˆ'] === 'o'),
                            healthInsurance: (row['ê±´ê°•ë³´í—˜'] === 'O' || row['ê±´ê°•ë³´í—˜'] === 'o'),
                            employmentInsurance: (row['ê³ ìš©ë³´í—˜'] === 'O' || row['ê³ ìš©ë³´í—˜'] === 'o'),
                            industrialAccident: (row['ì‚°ì¬ë³´í—˜'] === 'O' || row['ì‚°ì¬ë³´í—˜'] === 'o'),
                            notes: row['ë¹„ê³ '] || ''
                        };

                        await window.setDoc(window.doc(window.db, 'employees', employeeData.employeeId), employeeData);
                        successCount++;
                        
                    } catch (error) {
                        console.error(`${i+2}í–‰ ì €ì¥ ì˜¤ë¥˜:`, error);
                        errors.push(`${i+2}í–‰: ${error.message}`);
                        errorCount++;
                    }
                }

                hideLoading();

                let resultMessage = `ì—…ë¡œë“œ ì™„ë£Œ!\n\nì„±ê³µ: ${successCount}ê±´\nì‹¤íŒ¨: ${errorCount}ê±´`;
                if (errors.length > 0) {
                    resultMessage += '\n\nì˜¤ë¥˜ ë‚´ì—­:\n' + errors.slice(0, 5).join('\n');
                    if (errors.length > 5) {
                        resultMessage += `\n... ì™¸ ${errors.length - 5}ê±´`;
                    }
                }

                alert(resultMessage);
                
                // ì§ì› ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadEmployees();

            } catch (error) {
                hideLoading();
                console.error('ì—‘ì…€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
            }

            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            event.target.value = '';
        }

        // ===== HR ëŒ€ì‹œë³´ë“œ =====
        async function loadDashboard() {
            showLoading();
            
            try {
                // ëª¨ë“  ì§ì› ë°ì´í„° ë¡œë“œ
                const employeesSnap = await window.getDocs(window.collection(window.db, 'employees'));
                const employees = [];
                employeesSnap.forEach(doc => {
                    employees.push({ id: doc.id, ...doc.data() });
                });
                
                // ë²•ì¸ ë°ì´í„° ë¡œë“œ
                const companiesSnap = await window.getDocs(window.collection(window.db, 'companies'));
                const companies = {};
                companiesSnap.forEach(doc => {
                    const c = doc.data();
                    companies[c.code] = c.name;
                });
                
                // ë¶€ì„œ ë°ì´í„° ë¡œë“œ
                const deptsSnap = await window.getDocs(window.collection(window.db, 'departments'));
                const depts = {};
                deptsSnap.forEach(doc => {
                    const d = doc.data();
                    depts[d.code] = d.name;
                });
                
                const currentDate = new Date();
                const currentMonth = currentDate.getFullYear() + '-' + String(currentDate.getMonth() + 1).padStart(2, '0');
                
                // ===== ìƒë‹¨ ìš”ì•½ ì¹´ë“œ =====
                
                // 1. ì „ì²´ ì§ì›
                document.getElementById('total-employees').textContent = employees.length;
                
                // 2. ì´ë²ˆ ë‹¬ ì…ì‚¬ì
                const newHires = employees.filter(emp => emp.hireDate && emp.hireDate.startsWith(currentMonth)).length;
                document.getElementById('new-hires').textContent = newHires;
                
                // 3. ì´ë²ˆ ë‹¬ í‡´ì‚¬ì (resignDate í•„ë“œ ê¸°ì¤€)
                const resignations = employees.filter(emp => emp.resignDate && emp.resignDate.startsWith(currentMonth)).length;
                document.getElementById('resignations').textContent = resignations;
                
                // 4. ì±„ìš© ì§„í–‰ í¬ì§€ì…˜ (ì„ì‹œ ë°ì´í„°)
                document.getElementById('open-positions').textContent = '0';
                
                // 5. ì¸ì‚¬íŒ€ KPI ë‹¬ì„±ë¥  (ì„ì‹œ ë°ì´í„°)
                document.getElementById('hr-kpi').textContent = '0%';
                
                // ===== ì¤‘ë‹¨ ì˜ì—­ =====
                
                // ì±„ìš© ì§„í–‰ í˜„í™©
                document.getElementById('recruitment-status').innerHTML = `
                    <div style="color: #6b7280; text-align: center; padding: 40px 20px;">
                        <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“</div>
                        <div style="font-size: 13px;">ì±„ìš© ì§„í–‰ ì¤‘ì¸ í¬ì§€ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
                
                // ì¡°ì§ ê±´ê°•ë„ & ë¦¬ìŠ¤í¬
                const avgTenure = calculateAvgTenure(employees, currentDate);
                const highTurnoverDepts = calculateHighTurnover(employees, depts, currentDate);
                
                let healthHTML = '<div style="display: flex; flex-direction: column; gap: 12px;">';
                
                // í‰ê·  ê·¼ì†ì—°ìˆ˜
                healthHTML += `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #f9fafb; border-radius: 6px;">
                        <span style="font-size: 16px;">â±ï¸</span>
                        <div style="flex: 1;">
                            <div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">í‰ê·  ê·¼ì†ì—°ìˆ˜</div>
                            <div style="font-size: 16px; font-weight: 600; color: #1f2937;">${avgTenure}ë…„</div>
                        </div>
                    </div>
                `;
                
                // ì´ì§ ìœ„í—˜ ë¶€ì„œ
                if (highTurnoverDepts.length > 0) {
                    healthHTML += `
                        <div style="display: flex; align-items: start; gap: 8px; padding: 10px; background: #fef2f2; border-radius: 6px; border-left: 3px solid #dc2626;">
                            <span style="font-size: 16px;">âš ï¸</span>
                            <div style="flex: 1;">
                                <div style="font-size: 11px; color: #991b1b; margin-bottom: 4px; font-weight: 600;">ì´ì§ ìœ„í—˜ ë¶€ì„œ</div>
                                <div style="font-size: 11px; color: #6b7280;">${highTurnoverDepts.join(', ')}</div>
                            </div>
                        </div>
                    `;
                } else {
                    healthHTML += `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #f0fdf4; border-radius: 6px;">
                            <span style="font-size: 16px;">âœ…</span>
                            <div style="font-size: 11px; color: #166534;">ì¡°ì§ ê±´ê°•ë„ ì–‘í˜¸</div>
                        </div>
                    `;
                }
                
                healthHTML += '</div>';
                document.getElementById('org-health').innerHTML = healthHTML;
                
                // ëª©í‘œ ë‹¬ì„±ë¥ 
                document.getElementById('goal-achievement').innerHTML = `
                    <div style="color: #6b7280; text-align: center; padding: 40px 20px;">
                        <div style="font-size: 32px; margin-bottom: 10px;">ğŸ¯</div>
                        <div style="font-size: 13px;">ëª©í‘œ ë°ì´í„° ì¤€ë¹„ ì¤‘</div>
                    </div>
                `;
                
                // ===== í•˜ë‹¨ ì°¨íŠ¸ =====
                
                // ë¶€ì„œë³„ ì¸ì› í˜„í™©
                const deptCounts = {};
                employees.forEach(emp => {
                    const deptName = depts[emp.departmentCode] || emp.departmentCode || 'ë¯¸ì§€ì •';
                    deptCounts[deptName] = (deptCounts[deptName] || 0) + 1;
                });
                
                let deptChartHTML = '<div style="display: flex; flex-direction: column; gap: 8px;">';
                Object.entries(deptCounts).sort((a, b) => b[1] - a[1]).forEach(([dept, count]) => {
                    const percentage = ((count / employees.length) * 100).toFixed(1);
                    deptChartHTML += `
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-size: 12px; color: #374151;">${dept}</span>
                                <span style="font-size: 12px; font-weight: 600; color: #1f2937;">${count}ëª… (${percentage}%)</span>
                            </div>
                            <div style="background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: #3b82f6; height: 100%; width: ${percentage}%;"></div>
                            </div>
                        </div>
                    `;
                });
                deptChartHTML += '</div>';
                document.getElementById('dept-chart').innerHTML = deptChartHTML;
                
                // ì§ê¸‰ë³„ ì¸ì› í˜„í™©
                const positionCounts = {};
                employees.forEach(emp => {
                    const position = emp.position || 'ë¯¸ì§€ì •';
                    positionCounts[position] = (positionCounts[position] || 0) + 1;
                });
                
                let positionChartHTML = '<div style="display: flex; flex-direction: column; gap: 8px;">';
                Object.entries(positionCounts).sort((a, b) => b[1] - a[1]).forEach(([position, count]) => {
                    const percentage = ((count / employees.length) * 100).toFixed(1);
                    positionChartHTML += `
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-size: 12px; color: #374151;">${position}</span>
                                <span style="font-size: 12px; font-weight: 600; color: #1f2937;">${count}ëª… (${percentage}%)</span>
                            </div>
                            <div style="background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: #8b5cf6; height: 100%; width: ${percentage}%;"></div>
                            </div>
                        </div>
                    `;
                });
                positionChartHTML += '</div>';
                document.getElementById('position-chart').innerHTML = positionChartHTML;
                
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì˜¤ë¥˜: ' + error.message);
            }
            
            hideLoading();
        }
        
        // í—¬í¼ í•¨ìˆ˜ë“¤
        function calculateAvgTenure(employees, currentDate) {
            let totalTenure = 0;
            let count = 0;
            employees.forEach(emp => {
                if (emp.hireDate) {
                    const hireDate = new Date(emp.hireDate);
                    const years = (currentDate - hireDate) / (1000 * 60 * 60 * 24 * 365);
                    totalTenure += years;
                    count++;
                }
            });
            return count > 0 ? (totalTenure / count).toFixed(1) : '0';
        }
        
        function calculateHighTurnover(employees, depts, currentDate) {
            // ìµœê·¼ 6ê°œì›” ì´ë‚´ í‡´ì‚¬ìê°€ ë§ì€ ë¶€ì„œ ì°¾ê¸°
            const sixMonthsAgo = new Date(currentDate);
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            
            const deptResignations = {};
            employees.forEach(emp => {
                if (emp.resignDate) {
                    const resignDate = new Date(emp.resignDate);
                    if (resignDate >= sixMonthsAgo) {
                        const deptName = depts[emp.departmentCode] || emp.departmentCode || 'ë¯¸ì§€ì •';
                        deptResignations[deptName] = (deptResignations[deptName] || 0) + 1;
                    }
                }
            });
            
            // 2ëª… ì´ìƒ í‡´ì‚¬í•œ ë¶€ì„œ
            return Object.entries(deptResignations)
                .filter(([_, count]) => count >= 2)
                .map(([dept, _]) => dept);
        }
                alert('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì˜¤ë¥˜: ' + error.message);
            }
            
            hideLoading();
        }

        // ===== ì„ì§ì› ëª…ë¶€ =====
        window.loadRoster = async function() {
            showLoading();
            
            // í˜„ì¬ í•„í„° ê°’ ì €ì¥
            const companyFilter = document.getElementById('roster-company-filter').value;
            const locationFilter = document.getElementById('roster-location-filter').value;
            const positionFilter = document.getElementById('roster-position-filter').value;
            const jobTitleFilter = document.getElementById('roster-jobtitle-filter').value;
            
            // í•„í„° ì˜µì…˜ ë¡œë“œ
            const companiesSnap = await window.getDocs(window.collection(window.db, 'companies'));
            const companies = {};
            companiesSnap.forEach(doc => {
                const c = doc.data();
                companies[c.code] = c.name;
            });
            
            const deptsSnap = await window.getDocs(window.collection(window.db, 'departments'));
            const depts = {};
            deptsSnap.forEach(doc => {
                const d = doc.data();
                depts[d.code] = d.name;
            });
            
            // ì§ì› ë°ì´í„° ë¡œë“œ
            const employeesSnap = await window.getDocs(window.collection(window.db, 'employees'));
            let employees = [];
            const locations = new Set();
            const positions = new Set();
            const jobTitles = new Set();
            
            employeesSnap.forEach(doc => {
                const emp = doc.data();
                employees.push(emp);
                if (emp.workLocation) locations.add(emp.workLocation);
                if (emp.position) positions.add(emp.position);
                if (emp.jobTitle) jobTitles.add(emp.jobTitle);
            });
            
            // ë²•ì¸ í•„í„° ì—…ë°ì´íŠ¸ (ê°’ ìœ ì§€í•˜ë©´ì„œ ì¬ìƒì„±)
            const companySelect = document.getElementById('roster-company-filter');
            companySelect.innerHTML = '<option value="">ì „ì²´ ë²•ì¸</option>';
            Object.entries(companies).forEach(([code, name]) => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = name;
                companySelect.appendChild(option);
            });
            companySelect.value = companyFilter;
            
            // ê·¼ë¬´ì§€ í•„í„° ì—…ë°ì´íŠ¸
            const locationSelect = document.getElementById('roster-location-filter');
            locationSelect.innerHTML = '<option value="">ì „ì²´ ê·¼ë¬´ì§€</option>';
            Array.from(locations).sort().forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationSelect.appendChild(option);
            });
            locationSelect.value = locationFilter;
            
            // ì§ê¸‰ í•„í„° ì—…ë°ì´íŠ¸
            const positionSelect = document.getElementById('roster-position-filter');
            positionSelect.innerHTML = '<option value="">ì „ì²´ ì§ê¸‰</option>';
            const positionOrder = ['ì¸í„´', 'ì‚¬ì›', 'ì£¼ì„', 'ëŒ€ë¦¬', 'ê³¼ì¥', 'ì°¨ì¥', 'ë¶€ì¥', 'ì´ì‚¬'];
            const sortedPositions = Array.from(positions).sort((a, b) => {
                const idxA = positionOrder.indexOf(a);
                const idxB = positionOrder.indexOf(b);
                if (idxA === -1 && idxB === -1) return a.localeCompare(b);
                if (idxA === -1) return 1;
                if (idxB === -1) return -1;
                return idxA - idxB;
            });
            sortedPositions.forEach(pos => {
                const option = document.createElement('option');
                option.value = pos;
                option.textContent = pos;
                positionSelect.appendChild(option);
            });
            positionSelect.value = positionFilter;
            
            // ì§ìœ„ í•„í„° ì—…ë°ì´íŠ¸
            const jobTitleSelect = document.getElementById('roster-jobtitle-filter');
            jobTitleSelect.innerHTML = '<option value="">ì „ì²´ ì§ìœ„</option>';
            Array.from(jobTitles).sort().forEach(title => {
                const option = document.createElement('option');
                option.value = title;
                option.textContent = title;
                jobTitleSelect.appendChild(option);
            });
            jobTitleSelect.value = jobTitleFilter;
            
            // í•„í„°ë§
            if (companyFilter) {
                // GA KOREA(C001)ëŠ” í†µí•©ë²•ì¸ìœ¼ë¡œ ëª¨ë“  ì§ì› ì¡°íšŒ
                if (companyFilter !== 'C001') {
                    employees = employees.filter(e => e.companyCode === companyFilter);
                }
            }
            if (locationFilter) {
                employees = employees.filter(e => e.workLocation === locationFilter);
            }
            if (positionFilter) {
                employees = employees.filter(e => e.position === positionFilter);
            }
            if (jobTitleFilter) {
                employees = employees.filter(e => e.jobTitle === jobTitleFilter);
            }
            
            // ì •ë ¬ ê¸°ì¤€ ì ìš©
            const settingsDoc = await window.getDoc(window.doc(window.db, 'settings', 'master'));
            let settings = {
                positions: [],
                jobTitles: [],
                jobRoles: [],
                rosterSort: { sort1: 'name', sort2: '', sort3: '' }
            };
            
            if (settingsDoc.exists()) {
                settings = { ...settings, ...settingsDoc.data() };
            }
            
            // ì„ì›/ìë¬¸/ê³ ë¬¸ ìš°ì„  ì •ë ¬
            const vipPositions = ['ì„ì›', 'ìë¬¸', 'ê³ ë¬¸'];
            
            // 3ë‹¨ê³„ ì •ë ¬
            employees.sort((a, b) => {
                // 1. ì„ì›/ìë¬¸/ê³ ë¬¸ ìš°ì„ 
                const aIsVip = vipPositions.includes(a.position);
                const bIsVip = vipPositions.includes(b.position);
                
                if (aIsVip && !bIsVip) return -1;
                if (!aIsVip && bIsVip) return 1;
                
                // 2. ì •ë ¬ ê¸°ì¤€ ì ìš©
                const sortKeys = [
                    settings.rosterSort?.sort1 || 'name',
                    settings.rosterSort?.sort2 || '',
                    settings.rosterSort?.sort3 || ''
                ];
                
                for (const sortKey of sortKeys) {
                    if (!sortKey) continue;
                    
                    let result = 0;
                    
                    if (sortKey === 'name') {
                        result = (a.name || '').localeCompare(b.name || '');
                    } else if (sortKey === 'hireDate') {
                        result = (a.hireDate || '').localeCompare(b.hireDate || '');
                    } else if (sortKey === 'position') {
                        const order = settings.positions || [];
                        const idxA = order.indexOf(a.position || '');
                        const idxB = order.indexOf(b.position || '');
                        if (idxA === -1 && idxB === -1) result = (a.position || '').localeCompare(b.position || '');
                        else if (idxA === -1) result = 1;
                        else if (idxB === -1) result = -1;
                        else result = idxA - idxB;
                    } else if (sortKey === 'jobTitle') {
                        const order = settings.jobTitles || [];
                        const idxA = order.indexOf(a.jobTitle || '');
                        const idxB = order.indexOf(b.jobTitle || '');
                        if (idxA === -1 && idxB === -1) result = (a.jobTitle || '').localeCompare(b.jobTitle || '');
                        else if (idxA === -1) result = 1;
                        else if (idxB === -1) result = -1;
                        else result = idxA - idxB;
                    } else if (sortKey === 'jobRole') {
                        const order = settings.jobRoles || [];
                        const idxA = order.indexOf(a.jobRole || '');
                        const idxB = order.indexOf(b.jobRole || '');
                        if (idxA === -1 && idxB === -1) result = (a.jobRole || '').localeCompare(b.jobRole || '');
                        else if (idxA === -1) result = 1;
                        else if (idxB === -1) result = -1;
                        else result = idxA - idxB;
                    } else if (sortKey === 'department') {
                        result = (depts[a.departmentCode] || '').localeCompare(depts[b.departmentCode] || '');
                    } else if (sortKey === 'location') {
                        // ì‹œìŠ¤í…œ ê´€ë¦¬ìì—ì„œ ì„¤ì •í•œ ê·¼ë¬´ì§€ ìˆœì„œëŒ€ë¡œ ì •ë ¬
                        const order = settings.locations || [];
                        const idxA = order.indexOf(a.workLocation || '');
                        const idxB = order.indexOf(b.workLocation || '');
                        if (idxA === -1 && idxB === -1) result = (a.workLocation || '').localeCompare(b.workLocation || '');
                        else if (idxA === -1) result = 1;
                        else if (idxB === -1) result = -1;
                        else result = idxA - idxB;
                    }
                    
                    if (result !== 0) return result;
                }
                
                return 0;
            });
            
            // í…Œì´ë¸” ë Œë”ë§
            const tbody = document.getElementById('roster-tbody');
            if (employees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="19" style="padding: 40px; text-align: center; color: #999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            } else {
                tbody.innerHTML = employees.map((emp, index) => {
                    // ë‚˜ì´ ê³„ì‚°
                    const age = emp.birthDate ? new Date().getFullYear() - new Date(emp.birthDate).getFullYear() : '-';
                    
                    // ê·¼ì†ê¸°ê°„ ê³„ì‚°
                    let tenure = '-';
                    if (emp.hireDate) {
                        const hireDate = new Date(emp.hireDate);
                        const today = new Date();
                        const years = today.getFullYear() - hireDate.getFullYear();
                        const months = today.getMonth() - hireDate.getMonth();
                        tenure = `${years}ë…„ ${months}ê°œì›”`;
                    }
                    
                    // ì—°ë´‰ í¬ë§·íŒ… (ì²œ ë‹¨ìœ„ ì½¤ë§ˆ)
                    const salary = emp.annualSalary ? Number(emp.annualSalary).toLocaleString() : '-';
                    
                    return `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; text-align: center; white-space: nowrap;">${index + 1}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">${emp.workLocation || '-'}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">${depts[emp.departmentCode] || '-'}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; font-weight: bold; white-space: nowrap;">${emp.name || '-'}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">${emp.jobTitle || '-'}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">${emp.position || '-'}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">${emp.jobRole || '-'}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">${companies[emp.companyCode] || '-'}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">${emp.residentNumber || '-'}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">${emp.birthDate || '-'}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; text-align: center; white-space: nowrap;">${age}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; text-align: center; white-space: nowrap;">${emp.gender || '-'}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">${emp.hireDate || '-'}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">${tenure}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; text-align: right; white-space: nowrap;">${salary}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">${emp.education || '-'}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">${emp.mobile || '-'}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">${emp.companyEmail || emp.personalEmail || '-'}</td>
                        <td style="padding: 4px 6px; border: 1px solid #ddd; font-size: 11px; white-space: nowrap;">${emp.address || '-'}</td>
                    </tr>
                `;
                }).join('');
            }
            
            hideLoading();
        }

        window.exportRoster = function() {
            const table = document.getElementById('roster-table');
            let csv = [];
            
            for (let row of table.rows) {
                let rowData = [];
                for (let cell of row.cells) {
                    rowData.push('"' + cell.textContent.replace(/"/g, '""') + '"');
                }
                csv.push(rowData.join(','));
            }
            
            const csvContent = csv.join('\n');
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ì„ì§ì›ëª…ë¶€_' + new Date().toISOString().slice(0,10) + '.csv';
            link.click();
        }

        // ===== ì—°ë´‰ì •ë³´ =====
        
        // ìˆ˜ì‹ ì…ë ¥ ì¤‘ì¸ ì…€ ì¶”ì 
        let activeFormulaCell = null;
        
        // ì…€ í´ë¦­ í•¸ë“¤ëŸ¬
        window.handleCellClick = function(event, employeeId, field) {
            const input = event.target;
            
            // í¬ì»¤ìŠ¤ ì‹œ ìˆ˜ì‹ ì…ë ¥ ëª¨ë“œ í™œì„±í™”
            if (input.value.startsWith('=') || input.selectionStart === 0) {
                activeFormulaCell = { employeeId, field, input };
            }
        }
        
        // ì…€ ì°¸ì¡° ì¶”ê°€
        window.addCellReference = function(event, employeeId, cellName) {
            event.stopPropagation();
            
            if (!activeFormulaCell) return;
            
            const input = activeFormulaCell.input;
            const cursorPos = input.selectionStart;
            const currentValue = input.value;
            
            // ìˆ˜ì‹ì´ ì•„ë‹ˆë©´ =ë¡œ ì‹œì‘í•˜ê²Œ ë§Œë“¤ê¸°
            let newValue = currentValue;
            if (!currentValue.startsWith('=')) {
                newValue = '=' + cellName;
            } else {
                // ì»¤ì„œ ìœ„ì¹˜ì— ì…€ ì´ë¦„ ì‚½ì…
                newValue = currentValue.slice(0, cursorPos) + cellName + currentValue.slice(cursorPos);
            }
            
            input.value = newValue;
            input.focus();
            
            // ì»¤ì„œë¥¼ ì‚½ì…ëœ í…ìŠ¤íŠ¸ ë’¤ë¡œ ì´ë™
            const newCursorPos = cursorPos + cellName.length + (currentValue.startsWith('=') ? 0 : 1);
            input.setSelectionRange(newCursorPos, newCursorPos);
            
            // ì‹¤ì‹œê°„ ê³„ì‚° ì—…ë°ì´íŠ¸
            updateSalaryCell(activeFormulaCell.employeeId, activeFormulaCell.field, newValue);
        }
        
        // ìˆ˜ì‹ í‰ê°€ í•¨ìˆ˜
        function evaluateFormula(formula, rowData) {
            if (!formula || !formula.toString().startsWith('=')) {
                return Number(formula || 0);
            }
            
            try {
                // ìˆ˜ì‹ì—ì„œ = ì œê±°
                let expr = formula.substring(1).trim();
                
                // ì…€ ì°¸ì¡° ì²˜ë¦¬ (ì˜ˆ: í†µìƒì„ê¸ˆ, ê¸°ë³¸ê¸‰, ì‹œê°„ ë“±)
                const replacements = {
                    'í†µìƒì„ê¸ˆ': rowData.regularWage || 0,
                    'ê¸°ë³¸ê¸‰': rowData.baseSalary || 0,
                    'ì°¨ëŸ‰ë³´ì¡°ë¹„': rowData.carAllowance || 0,
                    'ê¸°íƒ€ìˆ˜ë‹¹': rowData.otherAllowance || 0,
                    'ê³ ì •ìƒì—¬': rowData.fixedBonus || 0,
                    'ì—°ì¥ê·¼ë¡œì‹œê°„': rowData.overtimeHours || 0,
                    'íœ´ì¼ê·¼ë¡œì¼': rowData.holidayDays || 0,
                    'íœ´ì¼ê·¼ë¡œì‹œê°„': rowData.holidayHours || 0,
                    'ì•¼ê°„ê·¼ë¡œì‹œê°„': rowData.nightHours || 0,
                    'ì‹œê°„': rowData.overtimeHours || 0
                };
                
                for (const [key, value] of Object.entries(replacements)) {
                    const regex = new RegExp(key, 'g');
                    expr = expr.replace(regex, value);
                }
                
                // ê°„ë‹¨í•œ ìˆ˜ì‹ í‰ê°€ (*, /, +, -)
                return eval(expr);
            } catch (e) {
                console.error('ìˆ˜ì‹ ì˜¤ë¥˜:', formula, e);
                return 0;
            }
        }
        
        // ì…€ ê°’ ì—…ë°ì´íŠ¸
        window.updateSalaryCell = function(employeeId, field, value) {
            // ì‹¤ì‹œê°„ìœ¼ë¡œ ê³„ì‚°ëœ ê°’ ì—…ë°ì´íŠ¸
            const row = document.querySelector(`tr[data-employee-id="${employeeId}"]`);
            if (!row) return;
            
            // ì›” ê¸‰ì—¬ ê³„ ë‹¤ì‹œ ê³„ì‚°
            const cells = row.querySelectorAll('input[type="text"]');
            const data = {};
            cells.forEach(input => {
                const f = input.dataset.field;
                if (f) {
                    data[f] = input.value;
                }
            });
            
            // ìˆ˜ì‹ í‰ê°€
            const regularWage = evaluateFormula(data.regularWage, data);
            const baseSalary = evaluateFormula(data.baseSalary, data);
            const carAllowance = evaluateFormula(data.carAllowance, data);
            const otherAllowance = evaluateFormula(data.otherAllowance, data);
            const overtimePay = evaluateFormula(data.overtimePay, data);
            const holidayPay = evaluateFormula(data.holidayPay, data);
            const nightPay = evaluateFormula(data.nightPay, data);
            const fixedBonus = evaluateFormula(data.fixedBonus, data);
            
            const monthlyTotal = baseSalary + carAllowance + otherAllowance + overtimePay + holidayPay + nightPay + fixedBonus;
            
            // ì›” ê¸‰ì—¬ ê³„ ì…€ ì—…ë°ì´íŠ¸
            const monthlyCellIdx = 15; // ì›” ê¸‰ì—¬ ê³„ëŠ” 16ë²ˆì§¸ ì»¬ëŸ¼ (0-based index 15)
            row.cells[monthlyCellIdx].textContent = monthlyTotal.toLocaleString();
        }
        
        window.saveSalaryChanges = async function() {
            showLoading();
            
            const table = document.getElementById('salary-table');
            const rows = table.querySelectorAll('tbody tr[data-employee-id]');
            
            for (let row of rows) {
                const empId = row.dataset.employeeId;
                if (!empId) continue;
                
                const inputs = row.querySelectorAll('input[type="text"]');
                const data = {};
                
                inputs.forEach(input => {
                    const field = input.dataset.field;
                    if (field) {
                        data[field] = input.value;
                    }
                });
                
                await window.setDoc(window.doc(window.db, 'employees', empId), data, { merge: true });
            }
            
            hideLoading();
            alert('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            
            // ìˆ˜ì • ëª¨ë“œ ì¢…ë£Œ
            salaryEditMode = false;
            document.getElementById('salary-edit-btn').style.display = '';
            document.getElementById('salary-save-btn').style.display = 'none';
            document.getElementById('salary-cancel-btn').style.display = 'none';
            
            loadSalaryInfo();
        }
        
        // ì—°ë´‰ì •ë³´ ìˆ˜ì • ëª¨ë“œ ìƒíƒœ
        let salaryEditMode = false;
        // ì—°ë´‰ì •ë³´ ì „ì²´ ë°ì´í„° ì €ì¥ (í•„í„°ìš©)
        let allSalaryEmployees = [];
        let salaryCompanies = {};
        let salaryDepts = {};
        let salarySettings = {};
        
        // ì—°ë´‰ì •ë³´ ìˆ˜ì • ëª¨ë“œ í™œì„±í™”
        window.enableSalaryEdit = function() {
            if (confirm('ì—°ë´‰ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                salaryEditMode = true;
                document.getElementById('salary-edit-btn').style.display = 'none';
                document.getElementById('salary-save-btn').style.display = '';
                document.getElementById('salary-cancel-btn').style.display = '';
                
                // ì…ë ¥ í•„ë“œ í™œì„±í™”
                document.querySelectorAll('#salary-tbody input.salary-cell').forEach(input => {
                    input.disabled = false;
                    input.style.background = '#fff';
                });
            }
        }
        
        // ì—°ë´‰ì •ë³´ ìˆ˜ì • ì·¨ì†Œ
        window.cancelSalaryEdit = function() {
            salaryEditMode = false;
            document.getElementById('salary-edit-btn').style.display = '';
            document.getElementById('salary-save-btn').style.display = 'none';
            document.getElementById('salary-cancel-btn').style.display = 'none';
            
            // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ (ë³€ê²½ì‚¬í•­ ì·¨ì†Œ)
            loadSalaryInfo();
        }
        
        async function loadSalaryInfo() {
            showLoading();
            
            // ë²•ì¸ ë°ì´í„° ë¡œë“œ
            const companiesSnap = await window.getDocs(window.collection(window.db, 'companies'));
            salaryCompanies = {};
            companiesSnap.forEach(doc => {
                const c = doc.data();
                salaryCompanies[c.code] = c.name;
            });
            
            // ë¶€ì„œ ë°ì´í„° ë¡œë“œ
            const deptsSnap = await window.getDocs(window.collection(window.db, 'departments'));
            salaryDepts = {};
            deptsSnap.forEach(doc => {
                const d = doc.data();
                salaryDepts[d.code] = d.name;
            });
            
            // ì§ì› ë°ì´í„° ë¡œë“œ
            const employeesSnap = await window.getDocs(window.collection(window.db, 'employees'));
            allSalaryEmployees = [];
            const locations = new Set();
            const positions = new Set();
            
            employeesSnap.forEach(doc => {
                const emp = doc.data();
                emp.id = doc.id;
                allSalaryEmployees.push(emp);
                if (emp.workLocation) locations.add(emp.workLocation);
                if (emp.position) positions.add(emp.position);
            });
            
            // ë²•ì¸ í•„í„° ì—…ë°ì´íŠ¸
            const companySelect = document.getElementById('salary-company-filter');
            const currentCompanyValue = companySelect.value;
            companySelect.innerHTML = '<option value="">ì „ì²´ ë²•ì¸</option>';
            Object.entries(salaryCompanies).forEach(([code, name]) => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = name;
                companySelect.appendChild(option);
            });
            companySelect.value = currentCompanyValue;
            
            // ê·¼ë¬´ì§€ í•„í„° ì—…ë°ì´íŠ¸
            const locationSelect = document.getElementById('salary-location-filter');
            const currentLocationValue = locationSelect.value;
            locationSelect.innerHTML = '<option value="">ì „ì²´ ê·¼ë¬´ì§€</option>';
            Array.from(locations).sort().forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                locationSelect.appendChild(option);
            });
            locationSelect.value = currentLocationValue;
            
            // ì§ê¸‰ í•„í„° ì—…ë°ì´íŠ¸
            const positionSelect = document.getElementById('salary-position-filter');
            const currentPositionValue = positionSelect.value;
            positionSelect.innerHTML = '<option value="">ì „ì²´ ì§ê¸‰</option>';
            const positionOrder = ['ì¸í„´', 'ì‚¬ì›', 'ì£¼ì„', 'ëŒ€ë¦¬', 'ê³¼ì¥', 'ì°¨ì¥', 'ë¶€ì¥', 'ì´ì‚¬'];
            const sortedPositions = Array.from(positions).sort((a, b) => {
                const idxA = positionOrder.indexOf(a);
                const idxB = positionOrder.indexOf(b);
                if (idxA === -1 && idxB === -1) return a.localeCompare(b);
                if (idxA === -1) return 1;
                if (idxB === -1) return -1;
                return idxA - idxB;
            });
            sortedPositions.forEach(pos => {
                const option = document.createElement('option');
                option.value = pos;
                option.textContent = pos;
                positionSelect.appendChild(option);
            });
            positionSelect.value = currentPositionValue;
            
            // ì§ìœ„ í•„í„° ì—…ë°ì´íŠ¸
            const jobTitles = new Set();
            allSalaryEmployees.forEach(emp => {
                if (emp.jobTitle) jobTitles.add(emp.jobTitle);
            });
            const jobTitleSelect = document.getElementById('salary-jobtitle-filter');
            const currentJobTitleValue = jobTitleSelect.value;
            jobTitleSelect.innerHTML = '<option value="">ì „ì²´ ì§ìœ„</option>';
            Array.from(jobTitles).sort().forEach(title => {
                const option = document.createElement('option');
                option.value = title;
                option.textContent = title;
                jobTitleSelect.appendChild(option);
            });
            jobTitleSelect.value = currentJobTitleValue;
            
            // ì •ë ¬ ì„¤ì • ë¡œë“œ
            const settingsDoc = await window.getDoc(window.doc(window.db, 'settings', 'master'));
            salarySettings = {
                positions: [],
                jobTitles: [],
                jobRoles: [],
                locations: [],
                rosterSort: { sort1: 'name', sort2: '', sort3: '' }
            };
            
            if (settingsDoc.exists()) {
                salarySettings = { ...salarySettings, ...settingsDoc.data() };
            }
            
            hideLoading();
            
            // í•„í„° ì ìš©í•˜ì—¬ í…Œì´ë¸” ë Œë”ë§
            filterSalaryInfo();
        }
        
        // í•„í„° ì ìš© í•¨ìˆ˜ (ë³„ë„ ë¶„ë¦¬)
        window.filterSalaryInfo = function() {
            const companyFilter = document.getElementById('salary-company-filter').value;
            const locationFilter = document.getElementById('salary-location-filter').value;
            const positionFilter = document.getElementById('salary-position-filter').value;
            const jobTitleFilter = document.getElementById('salary-jobtitle-filter').value;
            
            let employees = [...allSalaryEmployees];
            
            // í•„í„°ë§
            if (companyFilter) {
                if (companyFilter !== 'C001') {
                    employees = employees.filter(e => e.companyCode === companyFilter);
                }
            }
            if (locationFilter) {
                employees = employees.filter(e => e.workLocation === locationFilter);
            }
            if (positionFilter) {
                employees = employees.filter(e => e.position === positionFilter);
            }
            if (jobTitleFilter) {
                employees = employees.filter(e => e.jobTitle === jobTitleFilter);
            }
            
            // ì„ì›/ìë¬¸/ê³ ë¬¸ ìš°ì„  ì •ë ¬
            const vipPositions = ['ì„ì›', 'ìë¬¸', 'ê³ ë¬¸'];
            
            // 3ë‹¨ê³„ ì •ë ¬
            employees.sort((a, b) => {
                // 1. ì„ì›/ìë¬¸/ê³ ë¬¸ ìš°ì„ 
                const aIsVip = vipPositions.includes(a.position);
                const bIsVip = vipPositions.includes(b.position);
                
                if (aIsVip && !bIsVip) return -1;
                if (!aIsVip && bIsVip) return 1;
                
                // 2. ì •ë ¬ ê¸°ì¤€ ì ìš©
                const sortKeys = [
                    salarySettings.rosterSort?.sort1 || 'name',
                    salarySettings.rosterSort?.sort2 || '',
                    salarySettings.rosterSort?.sort3 || ''
                ];
                
                for (const sortKey of sortKeys) {
                    if (!sortKey) continue;
                    
                    let result = 0;
                    
                    if (sortKey === 'name') {
                        result = (a.name || '').localeCompare(b.name || '');
                    } else if (sortKey === 'hireDate') {
                        result = (a.hireDate || '').localeCompare(b.hireDate || '');
                    } else if (sortKey === 'position') {
                        const order = salarySettings.positions || [];
                        const idxA = order.indexOf(a.position || '');
                        const idxB = order.indexOf(b.position || '');
                        if (idxA === -1 && idxB === -1) result = (a.position || '').localeCompare(b.position || '');
                        else if (idxA === -1) result = 1;
                        else if (idxB === -1) result = -1;
                        else result = idxA - idxB;
                    } else if (sortKey === 'jobTitle') {
                        const order = salarySettings.jobTitles || [];
                        const idxA = order.indexOf(a.jobTitle || '');
                        const idxB = order.indexOf(b.jobTitle || '');
                        if (idxA === -1 && idxB === -1) result = (a.jobTitle || '').localeCompare(b.jobTitle || '');
                        else if (idxA === -1) result = 1;
                        else if (idxB === -1) result = -1;
                        else result = idxA - idxB;
                    } else if (sortKey === 'jobRole') {
                        const order = salarySettings.jobRoles || [];
                        const idxA = order.indexOf(a.jobRole || '');
                        const idxB = order.indexOf(b.jobRole || '');
                        if (idxA === -1 && idxB === -1) result = (a.jobRole || '').localeCompare(b.jobRole || '');
                        else if (idxA === -1) result = 1;
                        else if (idxB === -1) result = -1;
                        else result = idxA - idxB;
                    } else if (sortKey === 'department') {
                        result = (salaryDepts[a.departmentCode] || '').localeCompare(salaryDepts[b.departmentCode] || '');
                    } else if (sortKey === 'location') {
                        const order = salarySettings.locations || [];
                        const idxA = order.indexOf(a.workLocation || '');
                        const idxB = order.indexOf(b.workLocation || '');
                        if (idxA === -1 && idxB === -1) result = (a.workLocation || '').localeCompare(b.workLocation || '');
                        else if (idxA === -1) result = 1;
                        else if (idxB === -1) result = -1;
                        else result = idxA - idxB;
                    }
                    
                    if (result !== 0) return result;
                }
                
                return 0;
            });
            
            // í…Œì´ë¸” ë Œë”ë§
            renderSalaryTable(employees);
        }
        
        // í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜
        function renderSalaryTable(employees) {
            const tbody = document.getElementById('salary-tbody');
            const isEditMode = salaryEditMode;
            
            if (employees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="22" style="padding: 40px; text-align: center; color: #999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            } else {
                tbody.innerHTML = employees.map((emp, index) => {
                    // ìˆ«ì ê°’ìœ¼ë¡œ ë³€í™˜ (í†µìƒì„ê¸ˆì€ ì •ìˆ˜ë¡œ)
                    const regularWage = Math.floor(Number(emp.regularWage) || 0);
                    const baseSalary = Number(emp.baseSalary) || 0;
                    const carAllowance = Number(emp.carAllowance) || 0;
                    const otherAllowance = Number(emp.otherAllowance) || 0;
                    const overtimePay = Number(emp.overtimePay) || 0;
                    const holidayPay = Number(emp.holidayPay) || 0;
                    const nightPay = Number(emp.nightPay) || 0;
                    const fixedBonus = Number(emp.fixedBonus) || 0;
                    
                    const monthlyTotal = baseSalary + carAllowance + otherAllowance + overtimePay + holidayPay + nightPay + fixedBonus;
                    const annualSalary = Number(emp.annualSalary) || (monthlyTotal * 12);
                    
                    const inputStyle = isEditMode 
                        ? 'background: #fff;' 
                        : 'background: #f5f5f5; cursor: not-allowed;';
                    const disabledAttr = isEditMode ? '' : 'disabled';
                    
                    // í†µìƒì„ê¸ˆ í‘œì‹œê°’ (ì •ìˆ˜ë¡œ)
                    const regularWageDisplay = emp.regularWage ? Math.floor(Number(emp.regularWage)) : '';
                    
                    return `
                    <tr style="border-bottom: 1px solid #eee;" data-employee-id="${emp.id}">
                        <td style="padding: 4px; border: 1px solid #ddd; font-size: 11px; text-align: center; background: #f9f9f9;">${index + 1}</td>
                        <td style="padding: 4px; border: 1px solid #ddd; font-size: 11px; background: #f9f9f9;">${emp.workLocation || '-'}</td>
                        <td style="padding: 4px; border: 1px solid #ddd; font-size: 11px; background: #f9f9f9;">${salaryDepts[emp.departmentCode] || '-'}</td>
                        <td style="padding: 4px; border: 1px solid #ddd; font-size: 11px; font-weight: bold; background: #f9f9f9;">${emp.name || '-'}</td>
                        <td style="padding: 4px; border: 1px solid #ddd; font-size: 11px; background: #f9f9f9;">${emp.jobTitle || '-'}</td>
                        <td style="padding: 4px; border: 1px solid #ddd; font-size: 11px; background: #f9f9f9;">${salaryCompanies[emp.companyCode] || '-'}</td>
                        <td style="padding: 4px; border: 1px solid #ddd; font-size: 11px; background: #f9f9f9;">${emp.hireDate || '-'}</td>
                        <td style="padding: 0; border: 1px solid #ddd;"><input type="number" class="salary-cell" style="width: 90px; font-size: 11px; padding: 4px; border: none; text-align: right; ${inputStyle}" value="${regularWageDisplay}" data-field="regularWage" onchange="updateSalaryCell('${emp.id}', 'regularWage', this.value)" ${disabledAttr}></td>
                        <td style="padding: 0; border: 1px solid #ddd;"><input type="number" class="salary-cell" style="width: 90px; font-size: 11px; padding: 4px; border: none; text-align: right; ${inputStyle}" value="${emp.baseSalary || ''}" data-field="baseSalary" onchange="updateSalaryCell('${emp.id}', 'baseSalary', this.value)" ${disabledAttr}></td>
                        <td style="padding: 0; border: 1px solid #ddd;"><input type="number" class="salary-cell" style="width: 90px; font-size: 11px; padding: 4px; border: none; text-align: right; ${inputStyle}" value="${emp.carAllowance || ''}" data-field="carAllowance" onchange="updateSalaryCell('${emp.id}', 'carAllowance', this.value)" ${disabledAttr}></td>
                        <td style="padding: 0; border: 1px solid #ddd;"><input type="number" class="salary-cell" style="width: 90px; font-size: 11px; padding: 4px; border: none; text-align: right; ${inputStyle}" value="${emp.otherAllowance || ''}" data-field="otherAllowance" onchange="updateSalaryCell('${emp.id}', 'otherAllowance', this.value)" ${disabledAttr}></td>
                        <td style="padding: 0; border: 1px solid #ddd;"><input type="number" class="salary-cell" style="width: 90px; font-size: 11px; padding: 4px; border: none; text-align: right; ${inputStyle}" value="${emp.overtimePay || ''}" data-field="overtimePay" onchange="updateSalaryCell('${emp.id}', 'overtimePay', this.value)" ${disabledAttr}></td>
                        <td style="padding: 0; border: 1px solid #ddd;"><input type="number" class="salary-cell" style="width: 90px; font-size: 11px; padding: 4px; border: none; text-align: right; ${inputStyle}" value="${emp.holidayPay || ''}" data-field="holidayPay" onchange="updateSalaryCell('${emp.id}', 'holidayPay', this.value)" ${disabledAttr}></td>
                        <td style="padding: 0; border: 1px solid #ddd;"><input type="number" class="salary-cell" style="width: 90px; font-size: 11px; padding: 4px; border: none; text-align: right; ${inputStyle}" value="${emp.nightPay || ''}" data-field="nightPay" onchange="updateSalaryCell('${emp.id}', 'nightPay', this.value)" ${disabledAttr}></td>
                        <td style="padding: 0; border: 1px solid #ddd;"><input type="number" class="salary-cell" style="width: 90px; font-size: 11px; padding: 4px; border: none; text-align: right; ${inputStyle}" value="${emp.fixedBonus || ''}" data-field="fixedBonus" onchange="updateSalaryCell('${emp.id}', 'fixedBonus', this.value)" ${disabledAttr}></td>
                        <td style="padding: 4px; border: 1px solid #ddd; font-size: 11px; text-align: right; font-weight: bold; background: #fffbcc;">${monthlyTotal.toLocaleString()}</td>
                        <td style="padding: 0; border: 1px solid #ddd;"><input type="number" class="salary-cell" style="width: 100px; font-size: 11px; padding: 4px; border: none; text-align: right; font-weight: bold; ${inputStyle}" value="${emp.annualSalary || ''}" data-field="annualSalary" onchange="updateSalaryCell('${emp.id}', 'annualSalary', this.value)" ${disabledAttr}></td>
                        <td style="padding: 0; border: 1px solid #ddd;"><input type="number" class="salary-cell" style="width: 90px; font-size: 11px; padding: 4px; border: none; text-align: right; ${inputStyle}" value="${emp.taxFree || ''}" data-field="taxFree" onchange="updateSalaryCell('${emp.id}', 'taxFree', this.value)" ${disabledAttr}></td>
                        <td style="padding: 0; border: 1px solid #ddd;"><input type="number" class="salary-cell" style="width: 60px; font-size: 11px; padding: 4px; border: none; text-align: center; ${inputStyle}" value="${emp.overtimeHours || ''}" data-field="overtimeHours" onchange="updateSalaryCell('${emp.id}', 'overtimeHours', this.value)" ${disabledAttr}></td>
                        <td style="padding: 0; border: 1px solid #ddd;"><input type="number" class="salary-cell" style="width: 60px; font-size: 11px; padding: 4px; border: none; text-align: center; ${inputStyle}" value="${emp.holidayDays || ''}" data-field="holidayDays" onchange="updateSalaryCell('${emp.id}', 'holidayDays', this.value)" ${disabledAttr}></td>
                        <td style="padding: 0; border: 1px solid #ddd;"><input type="number" class="salary-cell" style="width: 60px; font-size: 11px; padding: 4px; border: none; text-align: center; ${inputStyle}" value="${emp.holidayHours || ''}" data-field="holidayHours" onchange="updateSalaryCell('${emp.id}', 'holidayHours', this.value)" ${disabledAttr}></td>
                        <td style="padding: 0; border: 1px solid #ddd;"><input type="number" class="salary-cell" style="width: 60px; font-size: 11px; padding: 4px; border: none; text-align: center; ${inputStyle}" value="${emp.nightHours || ''}" data-field="nightHours" onchange="updateSalaryCell('${emp.id}', 'nightHours', this.value)" ${disabledAttr}></td>
                    </tr>
                    `;
                }).join('');
            }
        }

        window.exportSalary = function() {
            const table = document.getElementById('salary-table');
            let csv = [];
            
            for (let row of table.rows) {
                let rowData = [];
                for (let cell of row.cells) {
                    rowData.push('"' + cell.textContent.replace(/"/g, '""') + '"');
                }
                csv.push(rowData.join(','));
            }
            
            const csvContent = csv.join('\n');
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ì—°ë´‰ì •ë³´_' + new Date().toISOString().slice(0,10) + '.csv';
            link.click();
        }

        // ===== ì—°ë´‰ì •ë³´ ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ =====
        window.downloadSalaryTemplate = async function() {
            showLoading();
            
            // ì§ì› ë°ì´í„° ë¡œë“œ
            const employeesSnap = await window.getDocs(window.collection(window.db, 'employees'));
            const employees = [];
            employeesSnap.forEach(doc => {
                const emp = doc.data();
                emp.id = doc.id;
                employees.push(emp);
            });
            
            // ë²•ì¸ ë°ì´í„° ë¡œë“œ
            const companiesSnap = await window.getDocs(window.collection(window.db, 'companies'));
            const companies = {};
            companiesSnap.forEach(doc => {
                const c = doc.data();
                companies[c.code] = c.name;
            });
            
            // ë¶€ì„œ ë°ì´í„° ë¡œë“œ
            const deptsSnap = await window.getDocs(window.collection(window.db, 'departments'));
            const depts = {};
            deptsSnap.forEach(doc => {
                const d = doc.data();
                depts[d.code] = d.name;
            });
            
            // ì–‘ì‹ ë°ì´í„° ìƒì„±
            const template = employees.map(emp => ({
                'ì‚¬ë²ˆ': emp.id || '',
                'ì„±ëª…': emp.name || '',
                'ê·¼ë¬´ì§€': emp.workLocation || '',
                'ë²•ì¸ëª…': companies[emp.companyCode] || '',
                'ì…ì‚¬ì¼': emp.hireDate || '',
                'ì§ìœ„': emp.jobTitle || '',
                'ë¶€ì„œ': depts[emp.departmentCode] || '',
                'í†µìƒì„ê¸ˆ': emp.regularWage || '',
                'ê¸°ë³¸ê¸‰': emp.baseSalary || '',
                'ì°¨ëŸ‰ë³´ì¡°ë¹„': emp.carAllowance || '',
                'ê¸°íƒ€ìˆ˜ë‹¹': emp.otherAllowance || '',
                'ì—°ì¥ê·¼ë¡œìˆ˜ë‹¹': emp.overtimePay || '',
                'íœ´ì¼ê·¼ë¡œìˆ˜ë‹¹': emp.holidayPay || '',
                'ì•¼ê°„ê·¼ë¡œìˆ˜ë‹¹': emp.nightPay || '',
                'ê³ ì •ìƒì—¬': emp.fixedBonus || '',
                'ì—°ë´‰': emp.annualSalary || '',
                'ë¹„ê³¼ì„¸': emp.taxFree || '',
                'ì—°ì¥ê·¼ë¡œì‹œê°„': emp.overtimeHours || '',
                'íœ´ì¼ê·¼ë¡œì¼': emp.holidayDays || '',
                'íœ´ì¼ê·¼ë¡œì‹œê°„': emp.holidayHours || '',
                'ì•¼ê°„ê·¼ë¡œì‹œê°„': emp.nightHours || ''
            }));
            
            if (template.length === 0) {
                // ë¹ˆ ì–‘ì‹ ìƒì„±
                template.push({
                    'ì‚¬ë²ˆ': '(ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”)',
                    'ì„±ëª…': '',
                    'ê·¼ë¬´ì§€': '',
                    'ë²•ì¸ëª…': '',
                    'ì…ì‚¬ì¼': '',
                    'ì§ìœ„': '',
                    'ë¶€ì„œ': '',
                    'í†µìƒì„ê¸ˆ': '',
                    'ê¸°ë³¸ê¸‰': '',
                    'ì°¨ëŸ‰ë³´ì¡°ë¹„': '',
                    'ê¸°íƒ€ìˆ˜ë‹¹': '',
                    'ì—°ì¥ê·¼ë¡œìˆ˜ë‹¹': '',
                    'íœ´ì¼ê·¼ë¡œìˆ˜ë‹¹': '',
                    'ì•¼ê°„ê·¼ë¡œìˆ˜ë‹¹': '',
                    'ê³ ì •ìƒì—¬': '',
                    'ì—°ë´‰': '',
                    'ë¹„ê³¼ì„¸': '',
                    'ì—°ì¥ê·¼ë¡œì‹œê°„': '',
                    'íœ´ì¼ê·¼ë¡œì¼': '',
                    'íœ´ì¼ê·¼ë¡œì‹œê°„': '',
                    'ì•¼ê°„ê·¼ë¡œì‹œê°„': ''
                });
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(template);
            
            // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = [
                {wch: 12}, {wch: 10}, {wch: 10}, {wch: 15}, {wch: 12},
                {wch: 10}, {wch: 12}, {wch: 12}, {wch: 12}, {wch: 12},
                {wch: 12}, {wch: 12}, {wch: 12}, {wch: 12}, {wch: 12},
                {wch: 12}, {wch: 12}, {wch: 12}, {wch: 12}, {wch: 12}, {wch: 12}
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'ì—°ë´‰ì •ë³´');
            XLSX.writeFile(wb, 'GA_KOREA_ì—°ë´‰ì •ë³´_ì–‘ì‹.xlsx');
            
            hideLoading();
        }

        // ===== ì—°ë´‰ì •ë³´ ì—‘ì…€ ì—…ë¡œë“œ =====
        window.handleSalaryExcelUpload = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading();

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                console.log('ì—°ë´‰ì •ë³´ ì—‘ì…€ ë°ì´í„°:', jsonData);

                if (jsonData.length === 0) {
                    alert('ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    hideLoading();
                    return;
                }

                let updatedCount = 0;
                let errorCount = 0;

                for (const row of jsonData) {
                    const empId = row['ì‚¬ë²ˆ'];
                    if (!empId || empId === '(ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”)') {
                        errorCount++;
                        continue;
                    }

                    // í•´ë‹¹ ì§ì› ë°ì´í„° ì¡°íšŒ
                    const empDocRef = window.doc(window.db, 'employees', String(empId));
                    const empDoc = await window.getDoc(empDocRef);
                    
                    if (!empDoc.exists()) {
                        console.warn(`ì‚¬ë²ˆ ${empId} ì§ì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                        errorCount++;
                        continue;
                    }

                    // ì—°ë´‰ì •ë³´ ì—…ë°ì´íŠ¸
                    const updateData = {
                        regularWage: row['í†µìƒì„ê¸ˆ'] || '',
                        baseSalary: row['ê¸°ë³¸ê¸‰'] || '',
                        carAllowance: row['ì°¨ëŸ‰ë³´ì¡°ë¹„'] || '',
                        otherAllowance: row['ê¸°íƒ€ìˆ˜ë‹¹'] || '',
                        overtimePay: row['ì—°ì¥ê·¼ë¡œìˆ˜ë‹¹'] || '',
                        holidayPay: row['íœ´ì¼ê·¼ë¡œìˆ˜ë‹¹'] || '',
                        nightPay: row['ì•¼ê°„ê·¼ë¡œìˆ˜ë‹¹'] || '',
                        fixedBonus: row['ê³ ì •ìƒì—¬'] || '',
                        annualSalary: row['ì—°ë´‰'] || '',
                        taxFree: row['ë¹„ê³¼ì„¸'] || '',
                        overtimeHours: row['ì—°ì¥ê·¼ë¡œì‹œê°„'] || '',
                        holidayDays: row['íœ´ì¼ê·¼ë¡œì¼'] || '',
                        holidayHours: row['íœ´ì¼ê·¼ë¡œì‹œê°„'] || '',
                        nightHours: row['ì•¼ê°„ê·¼ë¡œì‹œê°„'] || ''
                    };

                    await window.setDoc(empDocRef, updateData, { merge: true });
                    updatedCount++;
                }

                hideLoading();
                
                let message = `âœ… ì—°ë´‰ì •ë³´ ì—…ë¡œë“œ ì™„ë£Œ!\n\n`;
                message += `ì—…ë°ì´íŠ¸: ${updatedCount}ëª…\n`;
                if (errorCount > 0) {
                    message += `ì‹¤íŒ¨: ${errorCount}ê±´ (ì‚¬ë²ˆ ì˜¤ë¥˜ ë˜ëŠ” ë¯¸ë“±ë¡ ì§ì›)`;
                }
                alert(message);
                
                loadSalaryInfo();
                
            } catch (error) {
                console.error('ì—°ë´‰ì •ë³´ ì—‘ì…€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('âŒ ì—…ë¡œë“œ ì˜¤ë¥˜: ' + error.message);
                hideLoading();
            }
            
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            event.target.value = '';
        }

        // ===== ë²•ì¸ ê´€ë¦¬ =====
        async function loadCompanyManagement() {
            showLoading();
            
            // ë²•ì¸ ëª©ë¡ ë¡œë“œ
            const companiesSnap = await window.getDocs(window.collection(window.db, 'companies'));
            const companies = [];
            companiesSnap.forEach(doc => companies.push(doc.data()));
            
            const companyList = document.getElementById('company-list');
            if (companies.length === 0) {
                companyList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">ë“±ë¡ëœ ë²•ì¸ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            } else {
                companyList.innerHTML = companies.map(c => `
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 10px; color: #1976d2;">${c.name}</h3>
                        <p style="margin: 5px 0; font-size: 12px; color: #666;">ë²•ì¸ì½”ë“œ: ${c.code}</p>
                        <p style="margin: 5px 0; font-size: 12px; color: #666;">ì‚¬ì—…ìë²ˆí˜¸: ${c.businessNumber || '-'}</p>
                        <p style="margin: 5px 0; font-size: 12px; color: #666;">ëŒ€í‘œì: ${c.ceo || '-'}</p>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-outline" onclick="editCompany('${c.code}')" style="flex: 1; padding: 8px;">ìˆ˜ì •</button>
                            <button class="btn btn-secondary" onclick="deleteCompany('${c.code}')" style="flex: 1; padding: 8px;">ì‚­ì œ</button>
                        </div>
                    </div>
                `).join('');
            }
            
            // ë¶€ì„œ ëª©ë¡ ë¡œë“œ
            const deptsSnap = await window.getDocs(window.collection(window.db, 'departments'));
            const depts = [];
            deptsSnap.forEach(doc => depts.push({id: doc.id, ...doc.data()}));
            
            const deptTbody = document.getElementById('dept-list');
            if (depts.length === 0) {
                deptTbody.innerHTML = '<tr><td colspan="3" style="padding: 20px; text-align: center; color: #999;">ë“±ë¡ëœ ë¶€ì„œê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            } else {
                deptTbody.innerHTML = depts.map(d => `
                    <tr>
                        <td style="padding: 12px; border: 1px solid #ddd;">${d.name}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">${d.location || '-'}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">
                            <button class="btn btn-outline" onclick="editDept('${d.id}')" style="padding: 6px 12px; margin-right: 5px;">ìˆ˜ì •</button>
                            <button class="btn btn-secondary" onclick="deleteDept('${d.id}')" style="padding: 6px 12px;">ì‚­ì œ</button>
                        </td>
                    </tr>
                `).join('');
            }
            
            hideLoading();
        }

        window.showAddCompanyForm = function() {
            const code = 'C' + String(Math.floor(Math.random() * 900 + 100)).padStart(3, '0');
            
            if (confirm('ìƒˆ ë²•ì¸ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const name = prompt('ë²•ì¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', '');
                if (!name) return;
                
                const businessNumber = prompt('ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', '');
                const ceo = prompt('ëŒ€í‘œìëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', '');
                
                showLoading();
                window.setDoc(window.doc(window.db, 'companies', code), {
                    code: code,
                    name: name,
                    businessNumber: businessNumber || '',
                    ceo: ceo || ''
                }).then(() => {
                    alert('ë²•ì¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadCompanyManagement();
                }).catch(error => {
                    alert('ì˜¤ë¥˜: ' + error.message);
                    hideLoading();
                });
            }
        }

        window.editCompany = async function(code) {
            const docRef = window.doc(window.db, 'companies', code);
            const docSnap = await window.getDoc(docRef);
            if (!docSnap.exists()) return;
            
            const company = docSnap.data();
            const name = prompt('ë²•ì¸ëª…:', company.name);
            if (!name) return;
            
            const businessNumber = prompt('ì‚¬ì—…ìë²ˆí˜¸:', company.businessNumber || '');
            const ceo = prompt('ëŒ€í‘œìëª…:', company.ceo || '');
            
            showLoading();
            window.setDoc(docRef, {
                code: code,
                name: name,
                businessNumber: businessNumber || '',
                ceo: ceo || ''
            }).then(() => {
                alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadCompanyManagement();
            }).catch(error => {
                alert('ì˜¤ë¥˜: ' + error.message);
                hideLoading();
            });
        }

        window.deleteCompany = async function(code) {
            if (!confirm('ì´ ë²•ì¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê´€ë ¨ ë¶€ì„œì™€ ì§ì› ë°ì´í„°ë„ ì˜í–¥ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) return;
            
            showLoading();
            await window.deleteDoc(window.doc(window.db, 'companies', code));
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadCompanyManagement();
        }

        window.showAddDeptForm = async function() {
            const name = prompt('ë¶€ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', '');
            if (!name) return;
            
            const location = prompt('ê·¼ë¬´ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë³¸ì‚¬, ì„œìš¸, ê³¨ë“œCC ë“±):', '');
            if (!location) return;
            
            const code = 'D' + Date.now().toString().slice(-6); // íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ê³ ìœ  ì½”ë“œ ìƒì„±
            
            showLoading();
            window.setDoc(window.doc(window.db, 'departments', code), {
                code: code,
                name: name,
                location: location,
                companyCode: 'C001' // ê¸°ë³¸ê°’ìœ¼ë¡œ GA KOREA ì„¤ì •
            }).then(() => {
                alert('ë¶€ì„œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadCompanyManagement();
            }).catch(error => {
                alert('ì˜¤ë¥˜: ' + error.message);
                hideLoading();
            });
        }

        window.editDept = async function(code) {
            const docRef = window.doc(window.db, 'departments', code);
            const docSnap = await window.getDoc(docRef);
            if (!docSnap.exists()) return;
            
            const dept = docSnap.data();
            const name = prompt('ë¶€ì„œëª…:', dept.name);
            if (!name) return;
            
            const location = prompt('ê·¼ë¬´ì§€ (ì˜ˆ: ë³¸ì‚¬, ì„œìš¸, ê³¨ë“œCC ë“±):', dept.location || '');
            if (!location) return;
            
            showLoading();
            window.setDoc(docRef, {
                code: code,
                name: name,
                location: location,
                companyCode: dept.companyCode || 'C001' // ê¸°ì¡´ ê°’ ìœ ì§€
            }).then(() => {
                alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadCompanyManagement();
            }).catch(error => {
                alert('ì˜¤ë¥˜: ' + error.message);
                hideLoading();
            });
        }

        window.deleteDept = async function(code) {
            if (!confirm('ì´ ë¶€ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            showLoading();
            await window.deleteDoc(window.doc(window.db, 'departments', code));
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadCompanyManagement();
        }

        // ===== ì‹œìŠ¤í…œ ê´€ë¦¬ì ê´€ë¦¬ =====
        async function loadAdminManagement() {
            showLoading();
            
            // ì„¤ì •ê°’ ë¡œë“œ
            await loadSettings();
            
            // ì •ë ¬ ê¸°ì¤€ ë¡œë“œ
            const settingsDoc = await window.getDoc(window.doc(window.db, 'settings', 'master'));
            if (settingsDoc.exists()) {
                const settings = settingsDoc.data();
                if (settings.rosterSort) {
                    document.getElementById('roster-sort-1').value = settings.rosterSort.sort1 || '';
                    document.getElementById('roster-sort-2').value = settings.rosterSort.sort2 || '';
                    document.getElementById('roster-sort-3').value = settings.rosterSort.sort3 || '';
                }
            }
            
            // ê´€ë¦¬ì ê³„ì • ë¡œë“œ
            const usersSnap = await window.getDocs(window.collection(window.db, 'users'));
            const users = [];
            usersSnap.forEach(doc => users.push({id: doc.id, ...doc.data()}));
            
            const list = document.getElementById('admin-accounts-list');
            list.innerHTML = users.map(u => `
                <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${u.name || u.username}</strong>
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                ${u.username} | ${u.role === 'admin' ? 'ì‹œìŠ¤í…œ ê´€ë¦¬ì' : 'ì¼ë°˜ ê´€ë¦¬ì'}
                                ${u.active ? '' : ' (ë¹„í™œì„±)'}
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-outline" onclick="editAdmin('${u.id}')" style="padding: 6px 12px; margin-right: 5px;">ìˆ˜ì •</button>
                            ${u.id === 'admin' ? '' : `<button class="btn btn-secondary" onclick="deleteAdmin('${u.id}')" style="padding: 6px 12px;">ì‚­ì œ</button>`}
                        </div>
                    </div>
                </div>
            `).join('');
            
            hideLoading();
        }

        // ===== ì„¤ì •ê°’ ê´€ë¦¬ =====
        async function loadSettings() {
            // Firebaseì—ì„œ ì„¤ì •ê°’ ë¡œë“œ ë˜ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©
            const settingsDoc = await window.getDoc(window.doc(window.db, 'settings', 'master'));
            
            let settings = {
                positions: ['ì¸í„´', 'ì‚¬ì›', 'ì£¼ì„', 'ëŒ€ë¦¬', 'ê³¼ì¥', 'ì°¨ì¥', 'ë¶€ì¥', 'ì´ì‚¬'],
                jobTitles: ['íŒ€ì›', 'ì£¼ì„', 'ëŒ€ë¦¬', 'íŒ€ì¥', 'íŒŒíŠ¸ì¥', 'ì‹¤ì¥', 'ë³¸ë¶€ì¥'],
                jobRoles: ['íšŒì¥', 'ëŒ€í‘œì´ì‚¬', 'ë¶€ì‚¬ì¥', 'ì „ë¬´', 'ìƒë¬´', 'ì´ì‚¬', 'ê°ì‚¬'],
                locations: ['ë³¸ì‚¬', 'ì„œìš¸', 'ê³¨ë“œCC', 'ì½”ë¦¬ì•„CC', '3.5í™€'],
                employmentTypes: ['ì •ê·œì§', 'ê³„ì•½ì§', 'ì¸í„´', 'íŒŒê²¬ì§']
            };
            
            if (settingsDoc.exists()) {
                settings = {...settings, ...settingsDoc.data()};
            } else {
                // ê¸°ë³¸ ì„¤ì • ì €ì¥
                await window.setDoc(window.doc(window.db, 'settings', 'master'), settings);
            }
            
            renderSettings(settings);
        }

        function renderSettings(settings) {
            // ì§ê¸‰
            document.getElementById('position-list').innerHTML = settings.positions.map((item, idx) => `
                <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f0f0f0;">
                    <span>${item}</span>
                    <div>
                        ${idx > 0 ? `<button onclick="moveSettingItem('position', ${idx}, -1)" style="background: none; border: none; cursor: pointer; padding: 2px 6px;">â†‘</button>` : ''}
                        ${idx < settings.positions.length - 1 ? `<button onclick="moveSettingItem('position', ${idx}, 1)" style="background: none; border: none; cursor: pointer; padding: 2px 6px;">â†“</button>` : ''}
                        <button onclick="deleteSettingItem('position', ${idx})" style="background: none; border: none; cursor: pointer; color: #f44336; padding: 2px 6px;">âœ•</button>
                    </div>
                </div>
            `).join('');
            
            // ì§ìœ„
            document.getElementById('jobtitle-list').innerHTML = settings.jobTitles.map((item, idx) => `
                <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f0f0f0;">
                    <span>${item}</span>
                    <div>
                        ${idx > 0 ? `<button onclick="moveSettingItem('jobTitle', ${idx}, -1)" style="background: none; border: none; cursor: pointer; padding: 2px 6px;">â†‘</button>` : ''}
                        ${idx < settings.jobTitles.length - 1 ? `<button onclick="moveSettingItem('jobTitle', ${idx}, 1)" style="background: none; border: none; cursor: pointer; padding: 2px 6px;">â†“</button>` : ''}
                        <button onclick="deleteSettingItem('jobTitle', ${idx})" style="background: none; border: none; cursor: pointer; color: #f44336; padding: 2px 6px;">âœ•</button>
                    </div>
                </div>
            `).join('');
            
            // ì§ì±…
            document.getElementById('jobrole-list').innerHTML = (settings.jobRoles || []).map((item, idx) => `
                <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f0f0f0;">
                    <span>${item}</span>
                    <div>
                        ${idx > 0 ? `<button onclick="moveSettingItem('jobRole', ${idx}, -1)" style="background: none; border: none; cursor: pointer; padding: 2px 6px;">â†‘</button>` : ''}
                        ${idx < (settings.jobRoles || []).length - 1 ? `<button onclick="moveSettingItem('jobRole', ${idx}, 1)" style="background: none; border: none; cursor: pointer; padding: 2px 6px;">â†“</button>` : ''}
                        <button onclick="deleteSettingItem('jobRole', ${idx})" style="background: none; border: none; cursor: pointer; color: #f44336; padding: 2px 6px;">âœ•</button>
                    </div>
                </div>
            `).join('');
            
            // ê·¼ë¬´ì§€
            document.getElementById('location-list').innerHTML = settings.locations.map((item, idx) => `
                <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f0f0f0;">
                    <span>${item}</span>
                    <div>
                        ${idx > 0 ? `<button onclick="moveSettingItem('location', ${idx}, -1)" style="background: none; border: none; cursor: pointer; padding: 2px 6px;">â†‘</button>` : ''}
                        ${idx < settings.locations.length - 1 ? `<button onclick="moveSettingItem('location', ${idx}, 1)" style="background: none; border: none; cursor: pointer; padding: 2px 6px;">â†“</button>` : ''}
                        <button onclick="deleteSettingItem('location', ${idx})" style="background: none; border: none; cursor: pointer; color: #f44336; padding: 2px 6px;">âœ•</button>
                    </div>
                </div>
            `).join('');
            
            // ê³ ìš©í˜•íƒœ
            document.getElementById('employmenttype-list').innerHTML = settings.employmentTypes.map((item, idx) => `
                <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f0f0f0;">
                    <span>${item}</span>
                    <button onclick="deleteSettingItem('employmentType', ${idx})" style="background: none; border: none; cursor: pointer; color: #f44336; padding: 2px 6px;">âœ•</button>
                </div>
            `).join('');
        }

        window.addSetting = async function(type) {
            const labels = {
                position: 'ì§ê¸‰',
                jobTitle: 'ì§ìœ„',
                jobRole: 'ì§ì±…',
                location: 'ê·¼ë¬´ì§€',
                employmentType: 'ê³ ìš©í˜•íƒœ'
            };
            
            const value = prompt(`${labels[type]}ì„(ë¥¼) ì…ë ¥í•˜ì„¸ìš”:`);
            if (!value) return;
            
            showLoading();
            
            const settingsDoc = await window.getDoc(window.doc(window.db, 'settings', 'master'));
            const settings = settingsDoc.data();
            
            const key = type === 'position' ? 'positions' : 
                       type === 'jobTitle' ? 'jobTitles' :
                       type === 'jobRole' ? 'jobRoles' :
                       type === 'location' ? 'locations' : 'employmentTypes';
            
            if (!settings[key]) settings[key] = [];
            
            if (!settings[key].includes(value)) {
                settings[key].push(value);
                await window.setDoc(window.doc(window.db, 'settings', 'master'), settings);
                renderSettings(settings);
            } else {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê°’ì…ë‹ˆë‹¤.');
            }
            
            hideLoading();
        }

        window.deleteSettingItem = async function(type, index) {
            if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            showLoading();
            
            const settingsDoc = await window.getDoc(window.doc(window.db, 'settings', 'master'));
            const settings = settingsDoc.data();
            
            const key = type === 'position' ? 'positions' : 
                       type === 'jobTitle' ? 'jobTitles' :
                       type === 'jobRole' ? 'jobRoles' :
                       type === 'location' ? 'locations' : 'employmentTypes';
            
            settings[key].splice(index, 1);
            await window.setDoc(window.doc(window.db, 'settings', 'master'), settings);
            renderSettings(settings);
            
            hideLoading();
        }

        window.moveSettingItem = async function(type, index, direction) {
            showLoading();
            
            const settingsDoc = await window.getDoc(window.doc(window.db, 'settings', 'master'));
            const settings = settingsDoc.data();
            
            const key = type === 'position' ? 'positions' : 
                       type === 'jobTitle' ? 'jobTitles' :
                       type === 'jobRole' ? 'jobRoles' :
                       type === 'location' ? 'locations' : 'employmentTypes';
            
            const newIndex = index + direction;
            
            if (newIndex >= 0 && newIndex < settings[key].length) {
                [settings[key][index], settings[key][newIndex]] = [settings[key][newIndex], settings[key][index]];
                await window.setDoc(window.doc(window.db, 'settings', 'master'), settings);
                renderSettings(settings);
            }
            
            hideLoading();
        }


        window.saveRosterSortSetting = async function() {
            const sort1 = document.getElementById('roster-sort-1').value;
            const sort2 = document.getElementById('roster-sort-2').value;
            const sort3 = document.getElementById('roster-sort-3').value;
            
            showLoading();
            
            const settingsDoc = await window.getDoc(window.doc(window.db, 'settings', 'master'));
            const settings = settingsDoc.exists() ? settingsDoc.data() : {};
            
            settings.rosterSort = {
                sort1: sort1,
                sort2: sort2,
                sort3: sort3
            };
            
            await window.setDoc(window.doc(window.db, 'settings', 'master'), settings);
            
            hideLoading();
            alert('ì •ë ¬ ê¸°ì¤€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        window.showAddAdminForm = function() {
            const username = prompt('ìƒˆ ê´€ë¦¬ì ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', '');
            if (!username) return;
            
            const name = prompt('ê´€ë¦¬ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', '');
            if (!name) return;
            
            const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (8ì ì´ìƒ ê¶Œì¥):', '');
            if (!password) return;
            
            if (password.length < 6) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            const roleChoice = confirm('ì‹œìŠ¤í…œ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní™•ì¸: ì‹œìŠ¤í…œ ê´€ë¦¬ì\nì·¨ì†Œ: ì¼ë°˜ ê´€ë¦¬ì');
            const role = roleChoice ? 'admin' : 'user';
            
            showLoading();
            window.setDoc(window.doc(window.db, 'users', username), {
                username: username,
                password: hashPassword(password),
                name: name,
                role: role,
                active: true
            }).then(() => {
                alert('ê´€ë¦¬ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadAdminManagement();
            }).catch(error => {
                alert('ì˜¤ë¥˜: ' + error.message);
                hideLoading();
            });
        }

        window.changeAdminPassword = async function(userId) {
            const docRef = window.doc(window.db, 'users', userId);
            const docSnap = await window.getDoc(docRef);
            if (!docSnap.exists()) return;
            
            const user = docSnap.data();
            
            const newPassword = prompt(`"${user.name}" ê´€ë¦¬ìì˜ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`, '');
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                showLoading();
                window.setDoc(docRef, {
                    ...user,
                    password: hashPassword(newPassword)
                }).then(() => {
                    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•œ ê²½ìš° ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ë„ë¡ ì•ˆë‚´
                    if (userId === session.username) {
                        alert('ë³¸ì¸ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        location.reload();
                    } else {
                        loadAdminManagement();
                    }
                }).catch(error => {
                    alert('ì˜¤ë¥˜: ' + error.message);
                    hideLoading();
                });
            }
        }

        window.editAdmin = async function(userId) {
            const docRef = window.doc(window.db, 'users', userId);
            const docSnap = await window.getDoc(docRef);
            if (!docSnap.exists()) return;
            
            const user = docSnap.data();
            
            const name = prompt('ê´€ë¦¬ì ì´ë¦„:', user.name);
            if (!name) return;
            
            const activeChoice = confirm('ê³„ì •ì„ í™œì„±í™” ìƒíƒœë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní™•ì¸: í™œì„±\nì·¨ì†Œ: ë¹„í™œì„±');
            
            let role = user.role;
            if (userId !== 'admin') { // ê¸°ë³¸ admin ê³„ì •ì€ ê¶Œí•œ ë³€ê²½ ë¶ˆê°€
                const roleChoice = confirm('ì‹œìŠ¤í…œ ê´€ë¦¬ì ê¶Œí•œì„ ë¶€ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní™•ì¸: ì‹œìŠ¤í…œ ê´€ë¦¬ì\nì·¨ì†Œ: ì¼ë°˜ ê´€ë¦¬ì');
                role = roleChoice ? 'admin' : 'user';
            }
            
            showLoading();
            window.setDoc(docRef, {
                ...user,
                name: name,
                role: role,
                active: activeChoice
            }).then(() => {
                alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadAdminManagement();
            }).catch(error => {
                alert('ì˜¤ë¥˜: ' + error.message);
                hideLoading();
            });
        }

        window.deleteAdmin = async function(userId) {
            if (userId === 'admin') {
                alert('ê¸°ë³¸ ê´€ë¦¬ì ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm('ì´ ê´€ë¦¬ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            showLoading();
            await window.deleteDoc(window.doc(window.db, 'users', userId));
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadAdminManagement();
        }

        // ===== ì¡°ì§ë„ ê¸°ëŠ¥ =====
        let orgChartData = { departments: [], connections: [], style: {} };
        let contextMenuPosition = { x: 0, y: 0 };
        let selectedDeptColor = '#1976d2';
        let allOrgEmployees = [];
        let draggedEmployee = null;
        let connectingFrom = null;
        let connectingFromSide = null;
        let selectedDeptIndex = null;
        let editingDeptIndex = null;
        
        // ì¡°ì§ë„ ìŠ¤íƒ€ì¼ ì„¤ì • (ê¸°ë³¸ê°’)
        let orgStyle = {
            levelHeight: 120,
            boxWidth: 100,
            headerFont: 11,
            memberFont: 10,
            headerPadding: 6
        };
        
        function getLevelY(level) {
            return 30 + (level - 1) * orgStyle.levelHeight;
        }

        // í•˜ìœ„ ë¶€ì„œ ì¸ì› ê³„ì‚° (ì—°ê²°ëœ ëª¨ë“  í•˜ìœ„ ë¶€ì„œ í¬í•¨)
        function calculateTotalMembers(deptIndex, visited = new Set()) {
            if (visited.has(deptIndex)) return 0;
            visited.add(deptIndex);
            
            const dept = orgChartData.departments[deptIndex];
            if (!dept) return 0;
            
            let total = (dept.members || []).length;
            (dept.teams || []).forEach(team => {
                total += (team.members || []).length;
            });
            
            (orgChartData.connections || []).forEach(conn => {
                if (conn.from === deptIndex) {
                    const toDept = orgChartData.departments[conn.to];
                    if (toDept && (toDept.level || 1) > (dept.level || 1)) {
                        total += calculateTotalMembers(conn.to, visited);
                    }
                }
            });
            
            return total;
        }

        // ì¡°ì§ë„ì— í‘œì‹œëœ ì´ ì¸ì› ê³„ì‚°
        function calculateDisplayedTotal() {
            let total = 0;
            (orgChartData.departments || []).forEach(dept => {
                total += (dept.members || []).length;
                (dept.teams || []).forEach(team => {
                    total += (team.members || []).length;
                });
            });
            return total;
        }

        // ì¡°ì§ë„ ë¡œë“œ
        async function loadOrgChart() {
            const today = new Date();
            const dateStr = `${today.getFullYear()}.${String(today.getMonth() + 1).padStart(2, '0')}.${String(today.getDate()).padStart(2, '0')}`;
            document.getElementById('org-chart-date').textContent = dateStr;
            document.getElementById('org-chart-date2').textContent = dateStr;
            
            const employeesSnap = await window.getDocs(window.collection(window.db, 'employees'));
            allOrgEmployees = [];
            let specialCounts = { 'ê³ ë¬¸': 0, 'ìë¬¸': 0, 'íœ´ì§': 0 };
            
            employeesSnap.forEach(doc => {
                const emp = doc.data();
                emp.id = doc.id;
                allOrgEmployees.push(emp);
                if (emp.position === 'ê³ ë¬¸') specialCounts['ê³ ë¬¸']++;
                if (emp.position === 'ìë¬¸') specialCounts['ìë¬¸']++;
                if (emp.workStatus === 'íœ´ì§') specialCounts['íœ´ì§']++;
            });
            
            const specialItems = [];
            if (specialCounts['ê³ ë¬¸'] > 0) specialItems.push(`ê³ ë¬¸(${specialCounts['ê³ ë¬¸']}ëª…)`);
            if (specialCounts['ìë¬¸'] > 0) specialItems.push(`ìë¬¸(${specialCounts['ìë¬¸']}ëª…)`);
            if (specialCounts['íœ´ì§'] > 0) specialItems.push(`íœ´ì§(${specialCounts['íœ´ì§']}ëª…)`);
            document.getElementById('org-chart-special').textContent = specialItems.length > 0 ? specialItems.join(', ') : '-';
            
            try {
                const orgDoc = await window.getDoc(window.doc(window.db, 'settings', 'orgChart'));
                if (orgDoc.exists()) {
                    orgChartData = orgDoc.data();
                    if (!orgChartData.connections) orgChartData.connections = [];
                    if (!orgChartData.departments) orgChartData.departments = [];
                    if (orgChartData.style) {
                        orgStyle = { ...orgStyle, ...orgChartData.style };
                    }
                }
            } catch (e) {
                console.log('ì¡°ì§ë„ ë°ì´í„° ì—†ìŒ');
            }
            renderOrgChart();
        }

        // ì¡°ì§ë„ ë Œë”ë§
        function renderOrgChart() {
            const canvas = document.getElementById('org-chart-canvas');
            const svg = document.getElementById('org-chart-svg');
            canvas.innerHTML = '';
            canvas.appendChild(svg);
            
            if (orgChartData.departments) {
                orgChartData.departments.forEach((dept, index) => {
                    createDeptElement(dept, index);
                });
            }
            renderConnections();
            
            document.getElementById('org-chart-total').textContent = calculateDisplayedTotal();
        }

        // ë¶€ì„œ ìš”ì†Œ ìƒì„±
        function createDeptElement(dept, index) {
            const canvas = document.getElementById('org-chart-canvas');
            const level = dept.level || 1;
            const isTopLevel = level === 1;
            
            // Y ìœ„ì¹˜: ì €ì¥ëœ yê°’ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ë ˆë²¨ ê¸°ì¤€
            const posY = dept.y !== undefined ? dept.y : getLevelY(level);
            
            const totalWithChildren = calculateTotalMembers(index);
            
            const deptEl = document.createElement('div');
            deptEl.className = 'org-dept-box';
            deptEl.dataset.index = index;
            deptEl.style.cssText = `
                position: absolute;
                left: ${dept.x || 100}px;
                top: ${posY}px;
                min-width: ${orgStyle.boxWidth}px;
                background: white;
                border: 2px solid ${dept.color};
                border-radius: 4px;
                cursor: move;
                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                z-index: 10;
            `;
            
            // ë¶€ì„œ í—¤ë” (ìµœìƒìœ„ ë ˆë²¨ì€ ì¸ì›ìˆ˜ í‘œì‹œ ì•ˆí•¨)
            let html = `
                <div class="dept-header" style="background: ${dept.color}; color: white; padding: ${orgStyle.headerPadding}px 10px; font-weight: bold; font-size: ${orgStyle.headerFont}px; display: flex; justify-content: space-between; align-items: center;">
                    <span>${dept.name}</span>
                    ${!isTopLevel ? `<span style="background: white; color: ${dept.color}; padding: 1px 6px; border-radius: 10px; font-size: ${orgStyle.headerFont - 1}px; margin-left: 8px;">${totalWithChildren}</span>` : ''}
                </div>
            `;
            
            // ë¶€ì„œ ì§ì† ë©¤ë²„
            if (dept.members && dept.members.length > 0) {
                html += `<div class="dept-members" style="padding: 4px 6px; border-bottom: 1px solid #eee;" data-dept-index="${index}" data-team-index="-1">`;
                dept.members.forEach((m, mi) => {
                    html += `
                        <div class="dept-member" style="display: flex; justify-content: space-between; align-items: center; padding: 2px 0; font-size: ${orgStyle.memberFont}px;">
                            <span style="color: #666; min-width: 30px;">${m.jobTitle || '-'}</span>
                            <span style="font-weight: 500; flex: 1; text-align: right;">${m.name}</span>
                            <button onclick="removeMemberFromDept(${index}, ${mi}, -1)" style="background: none; border: none; color: #999; cursor: pointer; font-size: ${orgStyle.memberFont - 1}px; margin-left: 4px;">âœ•</button>
                        </div>
                    `;
                });
                html += `</div>`;
            } else {
                html += `<div class="dept-members" style="padding: 4px 6px; min-height: 15px;" data-dept-index="${index}" data-team-index="-1"></div>`;
            }
            
            // í•˜ìœ„ íŒ€ë“¤
            if (dept.teams && dept.teams.length > 0) {
                dept.teams.forEach((team, ti) => {
                    html += `
                        <div class="team-box" style="margin: 3px; border: 1px solid #ddd; border-radius: 3px;">
                            <div style="background: #f5f5f5; padding: 3px 6px; font-size: ${orgStyle.memberFont}px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
                                <span>${team.name}</span>
                                <span style="color: #666;">${(team.members || []).length}</span>
                                <button onclick="deleteTeam(${index}, ${ti})" style="background: none; border: none; color: #999; cursor: pointer; font-size: ${orgStyle.memberFont - 1}px; margin-left: 4px;">âœ•</button>
                            </div>
                            <div class="team-members" style="padding: 3px 5px; min-height: 12px;" data-dept-index="${index}" data-team-index="${ti}">
                    `;
                    if (team.members && team.members.length > 0) {
                        team.members.forEach((m, mi) => {
                            html += `
                                <div class="dept-member" style="display: flex; justify-content: space-between; align-items: center; padding: 1px 0; font-size: ${orgStyle.memberFont}px;">
                                    <span style="color: #666; min-width: 30px;">${m.jobTitle || '-'}</span>
                                    <span style="font-weight: 500; flex: 1; text-align: right;">${m.name}</span>
                                    <button onclick="removeMemberFromDept(${index}, ${mi}, ${ti})" style="background: none; border: none; color: #999; cursor: pointer; font-size: ${orgStyle.memberFont - 1}px; margin-left: 4px;">âœ•</button>
                                </div>
                            `;
                        });
                    }
                    html += `</div></div>`;
                });
            }
            
            // ì—°ê²°ì 
            html += `
                <div class="connect-point connect-top" data-side="top" style="display: none; position: absolute; top: -5px; left: 50%; transform: translateX(-50%); width: 10px; height: 10px; background: #1976d2; border-radius: 50%; cursor: crosshair; z-index: 20;"></div>
                <div class="connect-point connect-bottom" data-side="bottom" style="display: none; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); width: 10px; height: 10px; background: #1976d2; border-radius: 50%; cursor: crosshair; z-index: 20;"></div>
                <div class="connect-point connect-left" data-side="left" style="display: none; position: absolute; left: -5px; top: 50%; transform: translateY(-50%); width: 10px; height: 10px; background: #1976d2; border-radius: 50%; cursor: crosshair; z-index: 20;"></div>
                <div class="connect-point connect-right" data-side="right" style="display: none; position: absolute; right: -5px; top: 50%; transform: translateY(-50%); width: 10px; height: 10px; background: #1976d2; border-radius: 50%; cursor: crosshair; z-index: 20;"></div>
            `;
            
            deptEl.innerHTML = html;
            
            // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
            deptEl.onmouseenter = () => {
                deptEl.querySelectorAll('.connect-point').forEach(p => p.style.display = 'block');
            };
            deptEl.onmouseleave = () => {
                if (!connectingFrom) {
                    deptEl.querySelectorAll('.connect-point').forEach(p => p.style.display = 'none');
                }
            };
            
            // ë¶€ì„œ ìš°í´ë¦­
            deptEl.oncontextmenu = (e) => {
                e.preventDefault();
                e.stopPropagation();
                selectedDeptIndex = index;
                const menu = document.getElementById('dept-context-menu');
                menu.style.display = 'block';
                menu.style.left = e.clientX + 'px';
                menu.style.top = e.clientY + 'px';
            };
            
            // ì—°ê²°ì  í´ë¦­
            deptEl.querySelectorAll('.connect-point').forEach(point => {
                point.onclick = (e) => {
                    e.stopPropagation();
                    const side = point.dataset.side;
                    if (!connectingFrom) {
                        connectingFrom = index;
                        connectingFromSide = side;
                        point.style.background = '#ff9800';
                        document.querySelectorAll('.org-dept-box').forEach(box => {
                            box.querySelectorAll('.connect-point').forEach(p => p.style.display = 'block');
                        });
                    } else if (connectingFrom !== index) {
                        addConnection(connectingFrom, connectingFromSide, index, side);
                        resetConnecting();
                    } else {
                        resetConnecting();
                    }
                };
            });
            
            makeDraggable(deptEl, index);
            
            // ë“œë¡­ ì˜ì—­ ì„¤ì •
            deptEl.querySelectorAll('.dept-members, .team-members').forEach(area => {
                area.ondragover = (e) => { e.preventDefault(); area.style.background = '#e3f2fd'; };
                area.ondragleave = () => { area.style.background = ''; };
                area.ondrop = (e) => {
                    e.preventDefault();
                    area.style.background = '';
                    if (draggedEmployee) {
                        const deptIdx = parseInt(area.dataset.deptIndex);
                        const teamIdx = parseInt(area.dataset.teamIndex);
                        addMemberToDept(deptIdx, draggedEmployee, teamIdx);
                    }
                };
            });
            
            canvas.appendChild(deptEl);
        }

        // ì—°ê²° ìƒíƒœ ì´ˆê¸°í™”
        function resetConnecting() {
            connectingFrom = null;
            connectingFromSide = null;
            document.querySelectorAll('.connect-point').forEach(p => {
                p.style.background = '#1976d2';
                p.style.display = 'none';
            });
        }

        // ì—°ê²° ì¶”ê°€
        function addConnection(fromIndex, fromSide, toIndex, toSide) {
            if (!orgChartData.connections) orgChartData.connections = [];
            const exists = orgChartData.connections.some(c => 
                (c.from === fromIndex && c.to === toIndex) || 
                (c.from === toIndex && c.to === fromIndex)
            );
            if (exists) return;
            
            orgChartData.connections.push({ from: fromIndex, fromSide, to: toIndex, toSide });
            saveOrgChart();
            renderOrgChart();
        }

        // ì—°ê²°ì„  ë Œë”ë§ (êº¾ì¸ ì„  ì§€ì›)
        function renderConnections() {
            const svg = document.getElementById('org-chart-svg');
            svg.innerHTML = '';
            document.querySelectorAll('.conn-delete-btn').forEach(btn => btn.remove());
            
            if (!orgChartData.connections) return;
            
            orgChartData.connections.forEach((conn, index) => {
                const fromDept = document.querySelector(`.org-dept-box[data-index="${conn.from}"]`);
                const toDept = document.querySelector(`.org-dept-box[data-index="${conn.to}"]`);
                if (!fromDept || !toDept) return;
                
                const fromPos = getConnectionPoint(fromDept, conn.fromSide);
                const toPos = getConnectionPoint(toDept, conn.toSide);
                
                const fromLevel = orgChartData.departments[conn.from].level || 1;
                const toLevel = orgChartData.departments[conn.to].level || 1;
                
                let pathD;
                let midX, midY;
                
                // ê°™ì€ ë ˆë²¨ì´ë©´ ì§ì„ 
                if (fromLevel === toLevel) {
                    pathD = `M ${fromPos.x} ${fromPos.y} L ${toPos.x} ${toPos.y}`;
                    midX = (fromPos.x + toPos.x) / 2;
                    midY = (fromPos.y + toPos.y) / 2;
                } else {
                    // ë‹¤ë¥¸ ë ˆë²¨
                    const isVertical = (conn.fromSide === 'bottom' && conn.toSide === 'top') || 
                                      (conn.fromSide === 'top' && conn.toSide === 'bottom');
                    
                    if (isVertical) {
                        // ìœ„/ì•„ë˜ ì—°ê²°: ë‘ ë²ˆ êº¾ì„
                        const verticalMid = (fromPos.y + toPos.y) / 2;
                        pathD = `M ${fromPos.x} ${fromPos.y} L ${fromPos.x} ${verticalMid} L ${toPos.x} ${verticalMid} L ${toPos.x} ${toPos.y}`;
                        midX = (fromPos.x + toPos.x) / 2;
                        midY = verticalMid;
                    } else {
                        // ì¢Œ/ìš° ì—°ê²°: í•œ ë²ˆ êº¾ì„
                        if (conn.fromSide === 'right' || conn.fromSide === 'left') {
                            pathD = `M ${fromPos.x} ${fromPos.y} L ${toPos.x} ${fromPos.y} L ${toPos.x} ${toPos.y}`;
                            midX = toPos.x;
                            midY = (fromPos.y + toPos.y) / 2;
                        } else {
                            pathD = `M ${fromPos.x} ${fromPos.y} L ${fromPos.x} ${toPos.y} L ${toPos.x} ${toPos.y}`;
                            midX = (fromPos.x + toPos.x) / 2;
                            midY = toPos.y;
                        }
                    }
                }
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathD);
                path.setAttribute('stroke', '#333');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('fill', 'none');
                svg.appendChild(path);
                
                // ì‚­ì œ ë²„íŠ¼
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'conn-delete-btn';
                deleteBtn.dataset.connIndex = index;
                deleteBtn.style.cssText = `
                    position: absolute;
                    left: ${midX - 10}px;
                    top: ${midY - 10}px;
                    width: 20px;
                    height: 20px;
                    background: #ff5252;
                    border-radius: 50%;
                    display: none;
                    justify-content: center;
                    align-items: center;
                    cursor: pointer;
                    z-index: 15;
                    color: white;
                    font-size: 10px;
                `;
                deleteBtn.innerHTML = 'ğŸ—‘';
                deleteBtn.onclick = () => deleteConnection(index);
                document.getElementById('org-chart-canvas').appendChild(deleteBtn);
            });
            
            setupConnectionHover();
        }

        // ì—°ê²°ì  ì¢Œí‘œ ê³„ì‚°
        function getConnectionPoint(element, side) {
            const rect = element.getBoundingClientRect();
            const canvas = document.getElementById('org-chart-canvas');
            const canvasRect = canvas.getBoundingClientRect();
            const x = rect.left - canvasRect.left + canvas.scrollLeft;
            const y = rect.top - canvasRect.top + canvas.scrollTop;
            const w = rect.width;
            const h = rect.height;
            
            switch (side) {
                case 'top': return { x: x + w/2, y: y };
                case 'bottom': return { x: x + w/2, y: y + h };
                case 'left': return { x: x, y: y + h/2 };
                case 'right': return { x: x + w, y: y + h/2 };
                default: return { x: x + w/2, y: y + h/2 };
            }
        }

        // ì—°ê²°ì„  í˜¸ë²„
        function setupConnectionHover() {
            const canvas = document.getElementById('org-chart-canvas');
            canvas.onmousemove = (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left + canvas.scrollLeft;
                const mouseY = e.clientY - rect.top + canvas.scrollTop;
                
                document.querySelectorAll('.conn-delete-btn').forEach(btn => {
                    const btnX = parseFloat(btn.style.left) + 10;
                    const btnY = parseFloat(btn.style.top) + 10;
                    const dist = Math.sqrt(Math.pow(mouseX - btnX, 2) + Math.pow(mouseY - btnY, 2));
                    btn.style.display = dist < 40 ? 'flex' : 'none';
                });
            };
        }

        window.deleteConnection = function(index) {
            orgChartData.connections.splice(index, 1);
            saveOrgChart();
            renderOrgChart();
        }

        // ë“œë˜ê·¸ (X, Y ëª¨ë‘ ì´ë™ ê°€ëŠ¥)
        function makeDraggable(element, deptIndex) {
            let isDragging = false;
            let startX, startY, initialX, initialY;
            
            element.onmousedown = (e) => {
                if (e.target.tagName === 'BUTTON' || e.target.closest('.dept-members') || e.target.closest('.team-members') || e.target.classList.contains('connect-point')) return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialX = element.offsetLeft;
                initialY = element.offsetTop;
                element.style.zIndex = 1000;
            };
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                element.style.left = (initialX + dx) + 'px';
                element.style.top = (initialY + dy) + 'px';
                renderConnections();
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    element.style.zIndex = 10;
                    orgChartData.departments[deptIndex].x = element.offsetLeft;
                    orgChartData.departments[deptIndex].y = element.offsetTop;
                    saveOrgChart();
                }
            });
        }

        // ë¹ˆê³µê°„ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´
        window.showOrgChartContextMenu = function(e) {
            e.preventDefault();
            if (e.target.closest('.org-dept-box')) return;
            
            const menu = document.getElementById('org-context-menu');
            const canvas = document.getElementById('org-chart-canvas');
            const rect = canvas.getBoundingClientRect();
            contextMenuPosition = {
                x: e.clientX - rect.left + canvas.scrollLeft,
                y: e.clientY - rect.top + canvas.scrollTop
            };
            menu.style.display = 'block';
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';
        }

        // ë©”ë‰´ ë‹«ê¸°
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#org-context-menu')) {
                document.getElementById('org-context-menu').style.display = 'none';
            }
            if (!e.target.closest('#dept-context-menu')) {
                document.getElementById('dept-context-menu').style.display = 'none';
            }
            if (connectingFrom !== null && !e.target.classList.contains('connect-point')) {
                resetConnecting();
            }
        });

        // ë¶€ì„œ ìƒì„± ëª¨ë‹¬
        window.showCreateDeptModal = function() {
            document.getElementById('org-context-menu').style.display = 'none';
            document.getElementById('create-dept-modal').style.display = 'flex';
            document.getElementById('dept-modal-title').textContent = 'ë¶€ì„œ ìƒì„±';
            document.getElementById('new-dept-name').value = '';
            document.getElementById('new-dept-level').value = '1';
            editingDeptIndex = null;
            selectDeptColor('#1976d2');
        }

        window.closeCreateDeptModal = function() {
            document.getElementById('create-dept-modal').style.display = 'none';
        }

        window.selectDeptColor = function(color) {
            selectedDeptColor = color;
            document.querySelectorAll('.color-option').forEach(el => {
                el.style.border = el.dataset.color === color ? '2px solid #333' : '2px solid transparent';
            });
        }

        window.createDeptBox = function() {
            const name = document.getElementById('new-dept-name').value.trim();
            const level = parseInt(document.getElementById('new-dept-level').value);
            if (!name) { alert('ë¶€ì„œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            
            if (editingDeptIndex !== null) {
                orgChartData.departments[editingDeptIndex].name = name;
                orgChartData.departments[editingDeptIndex].level = level;
                orgChartData.departments[editingDeptIndex].color = selectedDeptColor;
            } else {
                const newDept = {
                    name, color: selectedDeptColor, level,
                    x: contextMenuPosition.x,
                    y: contextMenuPosition.y,
                    members: [], teams: []
                };
                if (!orgChartData.departments) orgChartData.departments = [];
                orgChartData.departments.push(newDept);
            }
            
            saveOrgChart();
            renderOrgChart();
            closeCreateDeptModal();
        }

        // ë¶€ì„œ ìˆ˜ì •
        window.editDept = function() {
            document.getElementById('dept-context-menu').style.display = 'none';
            if (selectedDeptIndex === null) return;
            
            const dept = orgChartData.departments[selectedDeptIndex];
            editingDeptIndex = selectedDeptIndex;
            
            document.getElementById('create-dept-modal').style.display = 'flex';
            document.getElementById('dept-modal-title').textContent = 'ë¶€ì„œ ìˆ˜ì •';
            document.getElementById('new-dept-name').value = dept.name;
            document.getElementById('new-dept-level').value = dept.level || 1;
            selectDeptColor(dept.color);
        }

        // ë¶€ì„œ ì‚­ì œ
        window.deleteSelectedDept = function() {
            document.getElementById('dept-context-menu').style.display = 'none';
            if (selectedDeptIndex === null) return;
            if (!confirm('ì´ ë¶€ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            orgChartData.connections = (orgChartData.connections || []).filter(c => c.from !== selectedDeptIndex && c.to !== selectedDeptIndex);
            orgChartData.connections = orgChartData.connections.map(c => ({
                ...c,
                from: c.from > selectedDeptIndex ? c.from - 1 : c.from,
                to: c.to > selectedDeptIndex ? c.to - 1 : c.to
            }));
            
            orgChartData.departments.splice(selectedDeptIndex, 1);
            saveOrgChart();
            renderOrgChart();
        }

        window.deleteDept = function(index) {
            selectedDeptIndex = index;
            deleteSelectedDept();
        }

        // í•˜ìœ„ íŒ€ ìƒì„±
        window.showCreateTeamModal = function() {
            document.getElementById('dept-context-menu').style.display = 'none';
            document.getElementById('create-team-modal').style.display = 'flex';
            document.getElementById('new-team-name').value = '';
        }

        window.closeCreateTeamModal = function() {
            document.getElementById('create-team-modal').style.display = 'none';
        }

        window.createTeam = function() {
            const name = document.getElementById('new-team-name').value.trim();
            if (!name) { alert('íŒ€ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (selectedDeptIndex === null) return;
            
            if (!orgChartData.departments[selectedDeptIndex].teams) {
                orgChartData.departments[selectedDeptIndex].teams = [];
            }
            orgChartData.departments[selectedDeptIndex].teams.push({ name, members: [] });
            
            saveOrgChart();
            renderOrgChart();
            closeCreateTeamModal();
        }

        window.deleteTeam = function(deptIndex, teamIndex) {
            if (!confirm('ì´ íŒ€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            orgChartData.departments[deptIndex].teams.splice(teamIndex, 1);
            saveOrgChart();
            renderOrgChart();
        }

        // ì–‘ì‹ ìˆ˜ì • ëª¨ë‹¬
        window.showOrgStyleModal = function() {
            document.getElementById('org-style-modal').style.display = 'flex';
            document.getElementById('style-level-height').value = orgStyle.levelHeight;
            document.getElementById('style-level-height-val').textContent = orgStyle.levelHeight;
            document.getElementById('style-box-width').value = orgStyle.boxWidth;
            document.getElementById('style-box-width-val').textContent = orgStyle.boxWidth;
            document.getElementById('style-header-font').value = orgStyle.headerFont;
            document.getElementById('style-header-font-val').textContent = orgStyle.headerFont;
            document.getElementById('style-member-font').value = orgStyle.memberFont;
            document.getElementById('style-member-font-val').textContent = orgStyle.memberFont;
            document.getElementById('style-header-padding').value = orgStyle.headerPadding;
            document.getElementById('style-header-padding-val').textContent = orgStyle.headerPadding;
        }

        window.closeOrgStyleModal = function() {
            document.getElementById('org-style-modal').style.display = 'none';
        }

        window.applyOrgStyle = function() {
            orgStyle.levelHeight = parseInt(document.getElementById('style-level-height').value);
            orgStyle.boxWidth = parseInt(document.getElementById('style-box-width').value);
            orgStyle.headerFont = parseInt(document.getElementById('style-header-font').value);
            orgStyle.memberFont = parseInt(document.getElementById('style-member-font').value);
            orgStyle.headerPadding = parseInt(document.getElementById('style-header-padding').value);
            
            orgChartData.style = orgStyle;
            saveOrgChart();
            renderOrgChart();
            closeOrgStyleModal();
        }

        // ì„ì§ì› íŒ¨ë„
        window.showEmployeePanel = function() {
            document.getElementById('org-context-menu').style.display = 'none';
            document.getElementById('org-chart-employee-panel').style.display = 'flex';
            renderOrgEmployeeList();
        }

        window.hideEmployeePanel = function() {
            document.getElementById('org-chart-employee-panel').style.display = 'none';
        }

        function renderOrgEmployeeList() {
            const search = document.getElementById('org-employee-search').value.toLowerCase();
            const list = document.getElementById('org-employee-list');
            
            const assignedIds = new Set();
            if (orgChartData.departments) {
                orgChartData.departments.forEach(dept => {
                    (dept.members || []).forEach(m => assignedIds.add(m.id));
                    (dept.teams || []).forEach(team => {
                        (team.members || []).forEach(m => assignedIds.add(m.id));
                    });
                });
            }
            
            const filtered = allOrgEmployees.filter(emp => {
                const matchSearch = !search || (emp.name && emp.name.toLowerCase().includes(search));
                return matchSearch && !assignedIds.has(emp.id);
            });
            
            list.innerHTML = filtered.map(emp => `
                <div class="org-employee-item" draggable="true" 
                     ondragstart="startDragEmployee('${emp.id}', '${emp.name}', '${emp.jobTitle || ''}')"
                     style="padding: 8px; background: white; margin-bottom: 4px; border-radius: 4px; cursor: grab; border: 1px solid #ddd;">
                    <div style="font-weight: 500; font-size: 12px;">${emp.name}</div>
                    <div style="font-size: 10px; color: #666;">${emp.jobTitle || '-'} / ${emp.position || '-'}</div>
                </div>
            `).join('');
            
            if (filtered.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #999; font-size: 12px;">ë°°ì¹˜ ê°€ëŠ¥í•œ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            }
        }

        window.filterOrgEmployees = function() { renderOrgEmployeeList(); }

        window.startDragEmployee = function(id, name, jobTitle) {
            draggedEmployee = { id, name, jobTitle };
        }

        function addMemberToDept(deptIndex, employee, teamIndex = -1) {
            const dept = orgChartData.departments[deptIndex];
            
            if (teamIndex === -1) {
                if (!dept.members) dept.members = [];
                if (dept.members.some(m => m.id === employee.id)) return;
                dept.members.push(employee);
            } else {
                if (!dept.teams[teamIndex].members) dept.teams[teamIndex].members = [];
                if (dept.teams[teamIndex].members.some(m => m.id === employee.id)) return;
                dept.teams[teamIndex].members.push(employee);
            }
            
            saveOrgChart();
            renderOrgChart();
            renderOrgEmployeeList();
            draggedEmployee = null;
        }

        window.removeMemberFromDept = function(deptIndex, memberIndex, teamIndex = -1) {
            if (teamIndex === -1) {
                orgChartData.departments[deptIndex].members.splice(memberIndex, 1);
            } else {
                orgChartData.departments[deptIndex].teams[teamIndex].members.splice(memberIndex, 1);
            }
            saveOrgChart();
            renderOrgChart();
            renderOrgEmployeeList();
        }

        async function saveOrgChart() {
            try {
                await window.setDoc(window.doc(window.db, 'settings', 'orgChart'), orgChartData);
            } catch (e) {
                console.error('ì¡°ì§ë„ ì €ì¥ ì‹¤íŒ¨:', e);
            }
        }
    </script>
</body>
</html>
